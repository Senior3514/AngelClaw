<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=380">
  <style>
    :root { --bg:#0c0e18; --surface:#141825; --surface2:#1c2035; --border:#2a2f4a; --text:#e8eaf0; --text-dim:#8890b0; --text-muted:#5a6080; --gold:#f0c850; --accent:#7ca8ff; --green:#4ade80; --red:#f87171; --radius:10px; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { width:360px; min-height:420px; font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:var(--bg); color:var(--text); font-size:12px; }
    .hdr { display:flex; align-items:center; gap:8px; padding:12px 14px; background:var(--surface); border-bottom:1px solid var(--border); }
    .hdr-icon { width:28px; height:28px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:rgba(240,200,80,0.08); border:1px solid rgba(240,200,80,0.25); font-size:16px; }
    .hdr h1 { font-size:14px; font-weight:700; }
    .hdr p { font-size:9px; color:var(--gold); letter-spacing:0.5px; }
    .status { display:flex; align-items:center; gap:6px; padding:8px 14px; background:var(--surface2); border-bottom:1px solid var(--border); font-size:11px; }
    .dot { width:7px; height:7px; border-radius:50%; }
    .dot.ok { background:var(--green); } .dot.err { background:var(--red); } .dot.chk { background:var(--gold); animation:pulse 1s infinite; }
    @keyframes pulse { 50%{opacity:0.3} }
    .sect { padding:12px 14px; border-bottom:1px solid var(--border); }
    .sect-title { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:0.5px; color:var(--text-muted); margin-bottom:8px; }
    .metrics { display:grid; grid-template-columns:1fr 1fr 1fr; gap:6px; }
    .metric { text-align:center; padding:8px; background:var(--surface); border:1px solid var(--border); border-radius:8px; }
    .metric .val { font-size:18px; font-weight:800; }
    .metric .lbl { font-size:8px; color:var(--text-dim); text-transform:uppercase; }
    .btns { display:flex; gap:6px; }
    .btn { flex:1; padding:7px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text); font-size:11px; font-weight:600; cursor:pointer; text-align:center; }
    .btn:hover { border-color:var(--accent); background:rgba(124,168,255,0.08); }
    .btn-primary { background:rgba(124,168,255,0.1); color:var(--accent); border-color:rgba(124,168,255,0.3); }
    .chat-row { display:flex; gap:6px; }
    .chat-input { flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:8px; background:var(--surface); color:var(--text); font-size:11px; outline:none; }
    .chat-input:focus { border-color:var(--gold); }
    .chat-send { padding:8px 14px; border:none; border-radius:8px; background:linear-gradient(135deg,#f0c850,#7ca8ff); color:#000; font-weight:700; font-size:11px; cursor:pointer; }
    .chat-resp { margin-top:6px; padding:8px; background:var(--surface); border:1px solid var(--border); border-radius:8px; font-size:11px; max-height:100px; overflow-y:auto; display:none; }
    .form-group { margin-bottom:8px; }
    .form-label { font-size:10px; color:var(--text-dim); margin-bottom:3px; display:block; }
    .form-input { width:100%; padding:6px 8px; border:1px solid var(--border); border-radius:6px; background:var(--surface); color:var(--text); font-size:11px; outline:none; }
    .form-input:focus { border-color:var(--accent); }
    .save-msg { font-size:10px; margin-top:4px; min-height:14px; }
  </style>
</head>
<body>
  <div class="hdr">
    <div class="hdr-icon">&#128737;</div>
    <div><h1>AngelClaw</h1><p>AGI Guardian v7.0</p></div>
  </div>
  <div class="status">
    <span class="dot chk" id="dot"></span>
    <span id="statusLabel">Connecting...</span>
    <span style="margin-left:auto;font-size:10px;color:var(--text-muted)" id="statusVer"></span>
  </div>

  <div class="sect" id="metricsSection" style="display:none">
    <div class="sect-title">Overview</div>
    <div class="metrics">
      <div class="metric"><div class="val" id="mAgents">-</div><div class="lbl">Agents</div></div>
      <div class="metric"><div class="val" id="mAlerts" style="color:var(--red)">-</div><div class="lbl">Alerts</div></div>
      <div class="metric"><div class="val" id="mEvents">-</div><div class="lbl">Events</div></div>
    </div>
  </div>

  <div class="sect">
    <div class="sect-title">Quick Actions</div>
    <div class="btns">
      <button class="btn btn-primary" id="btnScan">Scan Now</button>
      <button class="btn" id="btnShield">Shield</button>
      <button class="btn" id="btnConsole">Console</button>
    </div>
  </div>

  <div class="sect">
    <div class="sect-title">Ask AngelClaw</div>
    <div class="chat-row">
      <input type="text" class="chat-input" id="chatInput" placeholder="Ask anything...">
      <button class="chat-send" id="btnChat">Send</button>
    </div>
    <div class="chat-resp" id="chatResp"></div>
  </div>

  <div class="sect">
    <div class="sect-title">Connection</div>
    <div class="form-group">
      <label class="form-label">API URL</label>
      <input type="text" class="form-input" id="apiUrl" placeholder="http://localhost:8500">
    </div>
    <div class="form-group">
      <label class="form-label">Auth Token</label>
      <input type="password" class="form-input" id="authToken" placeholder="Paste JWT or API key">
    </div>
    <button class="btn" id="btnSave" style="width:100%;margin-top:4px">Save</button>
    <div class="save-msg" id="saveMsg"></div>
  </div>

<script>
let apiUrl='http://localhost:8500', authToken='';
const $=id=>document.getElementById(id);
async function load(){const s=await chrome.storage.local.get(['apiUrl','authToken']);if(s.apiUrl)apiUrl=s.apiUrl;if(s.authToken)authToken=s.authToken;$('apiUrl').value=apiUrl;$('authToken').value=authToken;checkHealth();}
async function checkHealth(){
  try{const r=await fetch(apiUrl+'/health',{headers:authToken?{'Authorization':'Bearer '+authToken}:{}});if(r.ok){const d=await r.json();$('dot').className='dot ok';$('statusLabel').textContent='Connected';$('statusVer').textContent='v'+(d.version||'?');$('metricsSection').style.display='block';loadMetrics();}else throw 0;}
  catch(e){$('dot').className='dot err';$('statusLabel').textContent='Disconnected';$('metricsSection').style.display='none';}
}
async function loadMetrics(){
  try{const h={};if(authToken)h['Authorization']='Bearer '+authToken;
    const[ag,al]=await Promise.all([fetch(apiUrl+'/api/v1/agents',{headers:h}).then(r=>r.json()).catch(()=>[]),fetch(apiUrl+'/api/v1/guardian/alerts/recent?tenantId=dev-tenant&limit=10',{headers:h}).then(r=>r.json()).catch(()=>[])]);
    $('mAgents').textContent=ag.length||0;$('mAlerts').textContent=al.length||0;$('mEvents').textContent='-';}catch(e){}
}
$('btnSave').onclick=async()=>{apiUrl=$('apiUrl').value.replace(/\/$/,'');authToken=$('authToken').value;await chrome.storage.local.set({apiUrl,authToken});$('saveMsg').innerHTML='<span style="color:var(--green)">Saved</span>';checkHealth();setTimeout(()=>$('saveMsg').textContent='',2000);};
$('btnConsole').onclick=()=>chrome.tabs.create({url:apiUrl+'/ui'});
$('btnScan').onclick=async()=>{try{const r=await fetch(apiUrl+'/api/v1/admin/scan/trigger',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+authToken},body:JSON.stringify({tenant_id:'dev-tenant'})});$('statusLabel').textContent=r.ok?'Scan triggered':'Scan failed';}catch(e){$('statusLabel').textContent='Error';}};
$('btnShield').onclick=async()=>{try{const r=await fetch(apiUrl+'/api/v1/angelclaw/shield/status',{headers:{'Authorization':'Bearer '+authToken}});if(r.ok){const d=await r.json();$('statusLabel').textContent='Shield: '+(d.last_risk_level||'unknown');}else $('statusLabel').textContent='Shield unavailable';}catch(e){$('statusLabel').textContent='Error';}};
$('btnChat').onclick=async()=>{const t=$('chatInput').value.trim();if(!t)return;$('chatResp').style.display='block';$('chatResp').textContent='Thinking...';try{const r=await fetch(apiUrl+'/api/v1/angelclaw/chat',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+authToken},body:JSON.stringify({tenantId:'dev-tenant',prompt:t})});if(r.ok){const d=await r.json();$('chatResp').textContent=d.answer||'No response';}else $('chatResp').textContent='Error';}catch(e){$('chatResp').textContent='Connection error';}};
$('chatInput').onkeydown=e=>{if(e.key==='Enter')$('btnChat').click();};
load();
</script>
</body>
</html>
