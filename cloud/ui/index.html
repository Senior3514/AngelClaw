<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>ANGELGRID V2 — Autonomous Guardian Dashboard</title>
<style>
  :root {
    --bg: #0f1117;
    --surface: #1a1d27;
    --surface2: #232733;
    --border: #2d3140;
    --text: #e4e7ef;
    --text-dim: #8b90a0;
    --accent: #6c8fff;
    --accent-glow: rgba(108,143,255,0.15);
    --green: #4ade80;
    --green-dim: rgba(74,222,128,0.12);
    --yellow: #fbbf24;
    --yellow-dim: rgba(251,191,36,0.12);
    --red: #f87171;
    --red-dim: rgba(248,113,113,0.12);
    --orange: #fb923c;
    --radius: 10px;
    --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    --mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
  }
  a { color: var(--accent); text-decoration: none; }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }
  .header h1 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .header .angel-icon { font-size: 24px; }
  .header .subtitle { color: var(--text-dim); font-size: 12px; font-weight: 400; }
  .header .version-pill {
    font-size: 11px; padding: 2px 8px; border-radius: 8px;
    background: var(--accent-glow); color: var(--accent); margin-left: 8px;
  }
  .header .status-pill {
    display: flex; align-items: center; gap: 6px;
    padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 500;
    background: var(--green-dim); color: var(--green);
  }
  .header .status-dot { width: 7px; height: 7px; border-radius: 50%; background: var(--green); animation: pulse 2s infinite; }
  @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.4; } }

  /* Two-panel layout */
  .layout {
    display: grid;
    grid-template-columns: 65% 35%;
    height: calc(100vh - 52px);
    overflow: hidden;
  }

  /* Left panel */
  .left-panel {
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 14px;
  }

  /* Right panel — chat */
  .right-panel {
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    background: var(--surface);
  }

  /* Cards */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px;
  }
  .card-header {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--border);
  }
  .card-title { font-size: 14px; font-weight: 600; }
  .card-badge {
    font-size: 10px; padding: 2px 8px; border-radius: 10px;
    background: var(--accent-glow); color: var(--accent);
  }

  /* Stats row */
  .stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: var(--radius); padding: 14px; text-align: center;
  }
  .stat-value { font-size: 24px; font-weight: 700; margin-bottom: 2px; }
  .stat-label { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

  /* Guardian Alerts Feed */
  .guardian-alert-feed { max-height: 180px; overflow-y: auto; }
  .guardian-alert-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 8px 10px; border-radius: 8px; margin-bottom: 4px;
    background: var(--surface2); border-left: 3px solid var(--red);
  }
  .guardian-alert-item.sev-high { border-left-color: var(--orange); }
  .guardian-alert-item.sev-warn { border-left-color: var(--yellow); }
  .guardian-alert-body { flex: 1; }
  .guardian-alert-title { font-size: 12px; font-weight: 500; }
  .guardian-alert-meta { font-size: 10px; color: var(--text-dim); margin-top: 2px; }

  /* Agent table */
  .agent-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .agent-table th {
    text-align: left; padding: 6px 10px; font-size: 10px; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-dim); border-bottom: 1px solid var(--border);
  }
  .agent-table td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  .agent-table tr:hover { background: var(--surface2); }
  .status-badge {
    display: inline-block; padding: 1px 8px; border-radius: 10px; font-size: 10px; font-weight: 600;
  }
  .status-active { background: var(--green-dim); color: var(--green); }
  .status-degraded { background: var(--yellow-dim); color: var(--yellow); }
  .status-offline { background: var(--red-dim); color: var(--red); }
  .tag { display: inline-block; padding: 0 6px; margin: 1px 2px; border-radius: 6px; font-size: 9px; background: var(--accent-glow); color: var(--accent); }

  /* Alert feed (events) */
  .alert-feed { max-height: 200px; overflow-y: auto; }
  .alert-item {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 6px 8px; border-radius: 6px; margin-bottom: 4px;
  }
  .alert-item:hover { background: var(--surface2); }
  .alert-icon { font-size: 14px; flex-shrink: 0; margin-top: 1px; }
  .alert-body { flex: 1; min-width: 0; }
  .alert-title { font-size: 12px; font-weight: 500; }
  .alert-meta { font-size: 10px; color: var(--text-dim); margin-top: 1px; }
  .alert-sev { font-size: 9px; padding: 0 6px; border-radius: 6px; font-weight: 600; }
  .sev-critical { background: var(--red-dim); color: var(--red); }
  .sev-high { background: rgba(251,146,60,0.15); color: var(--orange); }
  .sev-warn, .sev-medium { background: var(--yellow-dim); color: var(--yellow); }
  .sev-info, .sev-low { background: var(--accent-glow); color: var(--accent); }

  /* Threat chart */
  .threat-chart { display: flex; flex-direction: column; gap: 6px; }
  .threat-row { display: flex; align-items: center; gap: 10px; }
  .threat-label { width: 80px; font-size: 11px; color: var(--text-dim); text-align: right; }
  .threat-bar-bg { flex: 1; height: 20px; background: var(--surface2); border-radius: 4px; overflow: hidden; }
  .threat-bar-fill { height: 100%; border-radius: 4px; display: flex; align-items: center; padding-left: 6px; font-size: 10px; font-weight: 600; min-width: 24px; }

  /* Chat panel */
  .chat-header {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    font-size: 14px; font-weight: 600;
    display: flex; align-items: center; gap: 8px;
  }
  .chat-messages {
    flex: 1; overflow-y: auto; padding: 12px 16px;
    display: flex; flex-direction: column; gap: 8px;
  }
  .chat-msg {
    padding: 10px 14px; border-radius: 12px; font-size: 13px; line-height: 1.5;
    max-width: 95%; word-wrap: break-word;
  }
  .chat-msg.system { background: var(--surface2); align-self: flex-start; }
  .chat-msg.user { background: var(--accent-glow); color: var(--accent); align-self: flex-end; }
  .chat-msg .actions { margin-top: 8px; display: flex; flex-direction: column; gap: 4px; }
  .action-card {
    background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
    padding: 8px 10px; font-size: 11px; cursor: pointer; transition: border-color 0.15s;
  }
  .action-card:hover { border-color: var(--accent); }
  .action-card .action-title { font-weight: 600; color: var(--accent); }
  .action-card .action-desc { color: var(--text-dim); margin-top: 2px; }
  .chat-refs { margin-top: 6px; font-size: 10px; color: var(--text-dim); }
  .chat-refs a { color: var(--accent); }
  .chat-input-row {
    padding: 12px 16px; border-top: 1px solid var(--border);
    display: flex; gap: 8px;
  }
  .chat-input {
    flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border);
    background: var(--surface2); color: var(--text); font-size: 13px; font-family: var(--font);
    outline: none;
  }
  .chat-input:focus { border-color: var(--accent); }
  .chat-send {
    padding: 10px 18px; border-radius: 8px; border: none;
    background: var(--accent); color: #fff; font-weight: 600; cursor: pointer;
    font-size: 13px;
  }
  .chat-send:hover { opacity: 0.85; }
  .chat-send:disabled { opacity: 0.4; cursor: not-allowed; }
  .chat-typing { font-size: 12px; color: var(--text-dim); padding: 4px 16px; }

  .loading { color: var(--text-dim); font-size: 12px; text-align: center; padding: 16px; }
  .empty { color: var(--text-dim); font-size: 12px; text-align: center; padding: 20px; }

  .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }

  @media (max-width: 900px) {
    .layout { grid-template-columns: 1fr; height: auto; }
    .right-panel { border-left: none; border-top: 1px solid var(--border); min-height: 400px; }
    .stats { grid-template-columns: repeat(3, 1fr); }
    .two-col { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<div class="header">
  <h1>
    <span class="angel-icon">&#128737;</span>
    ANGELGRID
    <span class="subtitle">Autonomous Guardian</span>
    <span class="version-pill">V2</span>
  </h1>
  <div class="status-pill"><span class="status-dot"></span> Protected</div>
</div>

<div class="layout">
  <!-- LEFT PANEL — Dashboard -->
  <div class="left-panel">

    <!-- Stats Row -->
    <div class="stats" id="stats">
      <div class="stat-card"><div class="stat-value" id="stat-agents">-</div><div class="stat-label">Agents</div></div>
      <div class="stat-card"><div class="stat-value" id="stat-events">-</div><div class="stat-label">Events (24h)</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--green)" id="stat-blocked">-</div><div class="stat-label">Blocked</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--accent)" id="stat-policies">-</div><div class="stat-label">Rules</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--red)" id="stat-alerts">-</div><div class="stat-label">Alerts</div></div>
    </div>

    <!-- Guardian Alerts -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Guardian Alerts</span>
        <span class="card-badge" id="guardian-alert-count">0</span>
      </div>
      <div class="guardian-alert-feed" id="guardian-alert-feed">
        <div class="loading">Loading guardian alerts...</div>
      </div>
    </div>

    <!-- Fleet + Threat in two columns -->
    <div class="two-col">
      <!-- Agent Fleet -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Fleet Status</span>
          <span class="card-badge" id="fleet-count">0</span>
        </div>
        <div id="fleet-table" style="max-height:260px;overflow-y:auto"><div class="loading">Loading fleet...</div></div>
      </div>

      <!-- Threat Landscape -->
      <div class="card">
        <div class="card-header">
          <span class="card-title">Threat Landscape (24h)</span>
          <span class="card-badge">By category</span>
        </div>
        <div class="threat-chart" id="threat-chart"><div class="loading">Loading...</div></div>
      </div>
    </div>

    <!-- Active Events Feed -->
    <div class="card">
      <div class="card-header">
        <span class="card-title">Recent Events</span>
        <span class="card-badge" id="alert-count">0</span>
      </div>
      <div class="alert-feed" id="alert-feed"><div class="loading">Loading events...</div></div>
    </div>

  </div>

  <!-- RIGHT PANEL — Guardian Chat -->
  <div class="right-panel">
    <div class="chat-header">
      <span>&#128737;</span> Guardian Chat
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="chat-msg system">
        Hi! I'm your ANGELGRID Guardian Angel. I watch over your fleet autonomously and can answer questions about incidents, threats, agents, policy, and more.<br><br>
        Try: "What happened recently?" or "Any threats?"
      </div>
    </div>
    <div id="chat-typing" class="chat-typing" style="display:none">Guardian is thinking...</div>
    <div class="chat-input-row">
      <input class="chat-input" id="chat-input" placeholder="Ask about incidents, threats, agents..." />
      <button class="chat-send" id="chat-send" onclick="sendChat()">Send</button>
    </div>
  </div>
</div>

<script>
const BASE = window.location.origin;
const chatHistory = [];

const sevIcon = s => ({critical:'&#9888;&#65039;',high:'&#128308;',warn:'&#128992;',medium:'&#128992;',low:'&#128309;',info:'&#128310;'}[s]||'&#9679;');
const sevClass = s => 'sev-'+(s==='warn'?'medium':s);
const statusClass = s => 'status-'+(s==='active'?'active':s==='degraded'?'degraded':'offline');
const ago = ts => { if(!ts) return 'never'; const d=new Date(ts); const m=Math.floor((Date.now()-d)/60000); return m<1?'just now':m<60?m+'m ago':m<1440?Math.floor(m/60)+'h ago':Math.floor(m/1440)+'d ago'; };
const catColor = c => ({shell:'var(--red)',network:'var(--orange)',file:'var(--yellow)',ai_tool:'var(--accent)',db:'#a78bfa',auth:'var(--red)',system:'var(--text-dim)'}[c]||'var(--accent)');
const esc = t => t ? t.replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';

async function fetchJSON(path) {
  try { const r = await fetch(BASE + path); if(!r.ok) return null; return await r.json(); } catch { return null; }
}

// Guardian Alerts
async function loadGuardianAlerts() {
  const data = await fetchJSON('/api/v1/guardian/alerts/recent?tenantId=dev-tenant&limit=10');
  const el = document.getElementById('guardian-alert-feed');
  const countEl = document.getElementById('guardian-alert-count');
  if(!data || !data.length) {
    el.innerHTML='<div class="empty">No guardian alerts. All clear.</div>';
    countEl.textContent='0';
    return 0;
  }
  countEl.textContent = data.length;
  el.innerHTML = data.map(a => {
    const cls = a.severity === 'critical' ? '' : a.severity === 'high' ? 'sev-high' : 'sev-warn';
    return '<div class="guardian-alert-item '+cls+'"><div class="guardian-alert-body"><div class="guardian-alert-title">['+esc(a.severity).toUpperCase()+'] '+esc(a.title)+'</div><div class="guardian-alert-meta">'+esc(a.alert_type)+' &middot; '+ago(a.created_at)+'</div></div></div>';
  }).join('');
  return data.length;
}

// Fleet
async function loadFleet() {
  const agents = await fetchJSON('/api/v1/agents');
  const el = document.getElementById('fleet-table');
  const countEl = document.getElementById('fleet-count');
  if(!agents || !agents.length) { el.innerHTML='<div class="empty">No agents registered.</div>'; countEl.textContent='0'; return agents||[]; }
  countEl.textContent = agents.length+' agent'+(agents.length!==1?'s':'');
  el.innerHTML = '<table class="agent-table"><thead><tr><th>Host</th><th>Status</th><th>OS</th><th>Version</th><th>Seen</th></tr></thead><tbody>' +
    agents.map(a => '<tr><td>'+esc(a.hostname)+'</td><td><span class="status-badge '+statusClass(a.status)+'">'+esc(a.status)+'</span></td><td>'+esc(a.os)+'</td><td>'+esc(a.version)+'</td><td>'+ago(a.last_seen_at)+'</td></tr>').join('') +
    '</tbody></table>';
  return agents;
}

// Events
async function loadAlerts() {
  const events = await fetchJSON('/api/v1/incidents/recent?limit=30');
  const el = document.getElementById('alert-feed');
  const countEl = document.getElementById('alert-count');
  if(!events || !events.length) { el.innerHTML='<div class="empty">No recent events. All clear.</div>'; countEl.textContent='0'; return []; }
  countEl.textContent = events.length+' events';
  el.innerHTML = events.map(e => '<div class="alert-item"><span class="alert-icon">'+sevIcon(e.severity)+'</span><div class="alert-body"><div class="alert-title">'+esc(e.category)+'/'+esc(e.type)+' <span class="alert-sev '+sevClass(e.severity)+'">'+esc(e.severity)+'</span></div><div class="alert-meta">'+ago(e.timestamp)+' &middot; '+(e.agent_id||'').slice(0,8)+'... &middot; '+(e.source||'system')+'</div></div></div>').join('');
  return events;
}

// Threat matrix
async function loadThreats() {
  const data = await fetchJSON('/api/v1/analytics/threat-matrix?lookback_hours=24');
  const el = document.getElementById('threat-chart');
  if(!data || !data.length) { el.innerHTML='<div class="empty">No threat data.</div>'; return; }
  const max = Math.max(...data.map(d=>d.total_events),1);
  el.innerHTML = data.slice(0,6).map(d => {
    const pct = Math.max(8, (d.total_events/max)*100);
    return '<div class="threat-row"><span class="threat-label">'+esc(d.category)+'</span><div class="threat-bar-bg"><div class="threat-bar-fill" style="width:'+pct+'%;background:'+catColor(d.category)+'">'+d.total_events+'</div></div></div>';
  }).join('');
}

// Stats
async function loadStats(agents, events, alertCount) {
  document.getElementById('stat-agents').textContent = agents ? agents.length : 0;
  document.getElementById('stat-events').textContent = events ? events.length : 0;
  const blocked = events ? events.filter(e=>['critical','high'].includes(e.severity)).length : 0;
  document.getElementById('stat-blocked').textContent = blocked;
  const policies = await fetchJSON('/api/v1/analytics/policy/evolution');
  const ruleCount = policies && policies.length ? policies[0].rule_count : 0;
  document.getElementById('stat-policies').textContent = ruleCount;
  document.getElementById('stat-alerts').textContent = alertCount || 0;
}

// Chat
async function sendChat() {
  const input = document.getElementById('chat-input');
  const msgs = document.getElementById('chat-messages');
  const btn = document.getElementById('chat-send');
  const typing = document.getElementById('chat-typing');
  const text = input.value.trim();
  if(!text) return;

  // Add user message
  chatHistory.push({role:'user', content:text});
  msgs.innerHTML += '<div class="chat-msg user">'+esc(text)+'</div>';
  input.value = '';
  btn.disabled = true;
  typing.style.display = 'block';
  msgs.scrollTop = msgs.scrollHeight;

  let responseHtml = '';
  try {
    const resp = await fetch(BASE+'/api/v1/guardian/chat', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({tenantId: 'dev-tenant', prompt: text})
    });
    if(resp.ok) {
      const data = await resp.json();
      chatHistory.push({role:'system', content:data.answer});
      responseHtml = '<div class="chat-msg system">' + formatAnswer(data.answer);

      // Action suggestion cards
      if(data.actions && data.actions.length) {
        responseHtml += '<div class="actions">';
        data.actions.forEach(a => {
          responseHtml += '<div class="action-card"><div class="action-title">'+esc(a.title)+'</div><div class="action-desc">'+esc(a.description)+'</div></div>';
        });
        responseHtml += '</div>';
      }

      // References
      if(data.references && data.references.length) {
        responseHtml += '<div class="chat-refs">Refs: '+data.references.map(r=>'<a href="'+r+'" target="_blank">'+esc(r)+'</a>').join(', ')+'</div>';
      }

      responseHtml += '</div>';
    } else {
      responseHtml = '<div class="chat-msg system">Sorry, I had trouble processing that. Try again?</div>';
    }
  } catch(e) {
    responseHtml = '<div class="chat-msg system">Connection error. Is the Cloud API running?</div>';
  }

  typing.style.display = 'none';
  msgs.innerHTML += responseHtml;
  msgs.scrollTop = msgs.scrollHeight;
  btn.disabled = false;
  input.focus();
}

function formatAnswer(text) {
  // Simple markdown: **bold**, newlines
  return esc(text).replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
}

document.getElementById('chat-input').addEventListener('keydown', e => { if(e.key==='Enter') sendChat(); });

// Bootstrap
(async () => {
  const agents = await loadFleet();
  const events = await loadAlerts();
  await loadThreats();
  const alertCount = await loadGuardianAlerts();
  await loadStats(agents, events, alertCount);
  // Refresh every 30s
  setInterval(async () => {
    const a = await loadFleet();
    const e = await loadAlerts();
    await loadThreats();
    const ac = await loadGuardianAlerts();
    await loadStats(a, e, ac);
  }, 30000);
})();
</script>
</body>
</html>
