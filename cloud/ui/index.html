<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0c0e18">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="description" content="AngelClaw AGI Guardian — Enterprise Security Console">
<link rel="manifest" href="/mobile/manifest.json">
<title>AngelClaw AGI Guardian 7.0 — Administrative Console</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0c14;
    --surface: rgba(20,24,37,0.85);
    --surface-solid: #141825;
    --surface2: rgba(28,32,53,0.8);
    --surface3: #242840;
    --border: rgba(42,47,74,0.6);
    --border-hover: rgba(124,168,255,0.3);
    --text: #e8eaf0;
    --text-dim: #8890b0;
    --text-muted: #5a6080;
    --angel-gold: #f0c850;
    --angel-glow: rgba(240,200,80,0.08);
    --angel-blue: #7ca8ff;
    --angel-blue-glow: rgba(124,168,255,0.10);
    --angel-halo: linear-gradient(135deg, rgba(240,200,80,0.12), rgba(124,168,255,0.08));
    --angel-wing: linear-gradient(135deg, #f0c850 0%, #7ca8ff 50%, #c084fc 100%);
    --accent: #7ca8ff;
    --accent-dim: rgba(124,168,255,0.12);
    --green: #4ade80;
    --green-dim: rgba(74,222,128,0.10);
    --yellow: #fbbf24;
    --yellow-dim: rgba(251,191,36,0.10);
    --red: #f87171;
    --red-dim: rgba(248,113,113,0.10);
    --orange: #fb923c;
    --orange-dim: rgba(251,146,60,0.10);
    --purple: #c084fc;
    --purple-dim: rgba(192,132,252,0.10);
    --cyan: #22d3ee;
    --cyan-dim: rgba(34,211,238,0.10);
    --radius: 14px;
    --radius-sm: 10px;
    --radius-xs: 6px;
    --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    --mono: 'JetBrains Mono', 'Fira Code', Consolas, monospace;
    --sidebar-w: 230px;
    --glass: blur(12px) saturate(1.4);
    --shadow-sm: 0 2px 8px rgba(0,0,0,0.2);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.3);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.4);
    --shadow-glow: 0 0 20px rgba(124,168,255,0.08);
    --transition: 0.2s cubic-bezier(0.4,0,0.2,1);
  }
  html { font-size: 100%; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; min-height: 100vh; min-height: 100dvh; }
  body::before { content:''; position:fixed; top:0; left:0; width:100%; height:100%; background:radial-gradient(ellipse at 20% 20%, rgba(124,168,255,0.04) 0%, transparent 50%), radial-gradient(ellipse at 80% 80%, rgba(192,132,252,0.03) 0%, transparent 50%); pointer-events:none; z-index:0; }
  a { color: var(--accent); text-decoration: none; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
  @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
  @keyframes slideIn { from{opacity:0;transform:translateX(-10px)} to{opacity:1;transform:translateX(0)} }
  @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
  @keyframes glow-pulse { 0%,100%{box-shadow:0 0 8px rgba(124,168,255,0.1)} 50%{box-shadow:0 0 20px rgba(124,168,255,0.2)} }
  @keyframes halo-spin { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
  .skeleton { background:linear-gradient(90deg,var(--surface3) 25%,rgba(42,47,74,0.6) 50%,var(--surface3) 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:var(--radius-xs); }

  /* Header */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 24px; background: var(--surface); backdrop-filter: var(--glass);
    border-bottom: 1px solid var(--border); position: relative; overflow: hidden; z-index: 100;
  }
  .header::after { content:''; position:absolute; bottom:0; left:0; right:0; height:2px; background:var(--angel-wing); opacity:0.7; }
  .header h1 { font-size:16px; font-weight:700; display:flex; align-items:center; gap:10px; }
  .angel-icon { width:32px; height:32px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:var(--angel-glow); border:1px solid rgba(240,200,80,0.3); font-size:16px; flex-shrink:0; box-shadow:0 0 16px rgba(240,200,80,0.12); transition:var(--transition); }
  .angel-icon:hover { box-shadow:0 0 24px rgba(240,200,80,0.25); transform:scale(1.05); }
  .brand-text { display:flex; flex-direction:column; }
  .brand-name { line-height:1.2; letter-spacing:-0.3px; font-weight:800; }
  .brand-sub { font-size:9px; font-weight:500; color:var(--angel-gold); letter-spacing:1.2px; text-transform:uppercase; opacity:0.8; }
  .version-pill { font-size:9px; padding:2px 8px; border-radius:10px; background:var(--angel-glow); color:var(--angel-gold); border:1px solid rgba(240,200,80,0.2); font-weight:700; letter-spacing:0.3px; }
  .header-right { display:flex; align-items:center; gap:10px; }
  .search-bar { display:flex; align-items:center; gap:6px; padding:5px 12px; border-radius:20px; background:rgba(28,32,53,0.6); border:1px solid var(--border); font-size:11px; color:var(--text-dim); cursor:pointer; transition:var(--transition); min-width:180px; }
  .search-bar:hover,.search-bar:focus-within { border-color:var(--border-hover); background:rgba(28,32,53,0.9); }
  .search-bar input { background:none; border:none; color:var(--text); font-size:11px; font-family:var(--font); outline:none; width:100%; }
  .search-bar input::placeholder { color:var(--text-muted); }
  .search-bar kbd { font-size:8px; padding:1px 5px; border-radius:4px; background:var(--surface3); color:var(--text-muted); border:1px solid var(--border); font-family:var(--mono); }
  .guardian-status { display:flex; align-items:center; gap:6px; padding:5px 14px; border-radius:20px; font-size:10px; font-weight:600; background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,0.15); transition:var(--transition); }
  .guardian-status:hover { background:rgba(74,222,128,0.15); }
  .guardian-status .dot { width:6px; height:6px; border-radius:50%; background:var(--green); animation:pulse 2s infinite; }
  @keyframes pulse { 0%,100%{opacity:1;box-shadow:0 0 4px var(--green)} 50%{opacity:0.3;box-shadow:none} }
  .user-badge { display:flex; align-items:center; gap:6px; padding:4px 10px; border-radius:var(--radius-sm); font-size:10px; background:var(--surface2); color:var(--text-dim); border:1px solid var(--border); transition:var(--transition); }
  .user-badge:hover { border-color:var(--border-hover); }
  .role-tag { padding:2px 6px; border-radius:4px; font-size:8px; font-weight:700; text-transform:uppercase; letter-spacing:0.3px; }
  .role-operator { background:var(--accent-dim); color:var(--accent); }
  .role-admin { background:var(--angel-glow); color:var(--angel-gold); }
  .role-viewer { background:var(--yellow-dim); color:var(--yellow); }
  .logout-btn { background:none; border:1px solid var(--border); border-radius:var(--radius-xs); color:var(--text-dim); font-size:10px; padding:4px 10px; cursor:pointer; transition:var(--transition); }
  .logout-btn:hover { border-color:var(--red); color:var(--red); background:var(--red-dim); }
  .mobile-menu-btn { display:none; background:none; border:1px solid var(--border); border-radius:var(--radius-xs); color:var(--text); font-size:18px; padding:2px 8px; cursor:pointer; transition:var(--transition); }
  .mobile-menu-btn:hover { background:var(--surface2); }

  /* App layout */
  .app-layout { display:flex; height:calc(100vh - 50px); height:calc(100dvh - 50px); overflow:hidden; position:relative; z-index:1; }

  /* Sidebar navigation */
  .sidebar {
    width:var(--sidebar-w); background:var(--surface); backdrop-filter:var(--glass); border-right:1px solid var(--border);
    display:flex; flex-direction:column; flex-shrink:0; overflow-y:auto;
  }
  .sidebar-section { padding:14px 0 6px; }
  .sidebar-section-title { font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); padding:0 18px 8px; }
  .nav-item {
    display:flex; align-items:center; gap:10px; padding:9px 18px; font-size:12px; font-weight:500;
    color:var(--text-dim); cursor:pointer; border-left:3px solid transparent; transition:var(--transition); margin:1px 0; position:relative;
  }
  .nav-item:hover { background:rgba(124,168,255,0.05); color:var(--text); }
  .nav-item.active { background:var(--accent-dim); color:var(--accent); border-left-color:var(--accent); font-weight:700; box-shadow:inset 0 0 20px rgba(124,168,255,0.05); }
  .nav-item .nav-icon { font-size:14px; width:22px; text-align:center; transition:var(--transition); }
  .nav-item:hover .nav-icon { transform:scale(1.1); }
  .nav-item .nav-badge { margin-left:auto; font-size:9px; padding:2px 7px; border-radius:8px; font-weight:700; background:var(--red-dim); color:var(--red); }
  .nav-item .nav-badge.green { background:var(--green-dim); color:var(--green); }

  /* Main content */
  .main-content { flex:1; overflow-y:auto; padding:20px 24px; display:flex; flex-direction:column; gap:16px; scroll-behavior:smooth; }
  .main-content > * { animation:fadeIn 0.3s ease-out both; }
  .main-content > *:nth-child(2) { animation-delay:0.05s; }
  .main-content > *:nth-child(3) { animation-delay:0.1s; }
  .main-content > *:nth-child(4) { animation-delay:0.15s; }
  .main-content > *:nth-child(5) { animation-delay:0.2s; }

  /* Chat panel (collapsible) */
  .chat-panel {
    width:350px; border-left:1px solid var(--border); display:flex; flex-direction:column;
    background:var(--surface); backdrop-filter:var(--glass); flex-shrink:0; transition:width 0.25s cubic-bezier(0.4,0,0.2,1);
  }
  .chat-panel.collapsed { width:0; overflow:hidden; border:none; }
  .chat-toggle {
    position:fixed; bottom:24px; right:24px; width:52px; height:52px; border-radius:50%;
    background:var(--angel-wing); border:none; font-size:22px; cursor:pointer; z-index:200;
    display:none; box-shadow:var(--shadow-lg), 0 0 30px rgba(240,200,80,0.15); transition:var(--transition);
  }
  .chat-toggle:hover { transform:scale(1.08); }

  /* Cards */
  .card { background:var(--surface); backdrop-filter:var(--glass); border:1px solid var(--border); border-radius:var(--radius); padding:16px; position:relative; overflow:hidden; transition:var(--transition); box-shadow:var(--shadow-sm); }
  .card:hover { border-color:var(--border-hover); box-shadow:var(--shadow-md), var(--shadow-glow); }
  .card.glow::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; background:var(--angel-wing); opacity:0.6; }
  .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid var(--border); }
  .card-title { font-size:13px; font-weight:700; display:flex; align-items:center; gap:7px; }
  .card-title .icon { font-size:14px; opacity:0.8; }
  .card-badge { font-size:9px; padding:3px 9px; border-radius:10px; font-weight:700; background:var(--accent-dim); color:var(--accent); letter-spacing:0.3px; }
  .card-badge.gold { background:var(--angel-glow); color:var(--angel-gold); }
  .card-badge.green { background:var(--green-dim); color:var(--green); }
  .card-badge.red { background:var(--red-dim); color:var(--red); }
  .card-badge.yellow { background:var(--yellow-dim); color:var(--yellow); }

  /* Stats row */
  .stats { display:grid; grid-template-columns:repeat(auto-fit,minmax(130px,1fr)); gap:10px; }
  .stat-card { background:var(--surface); backdrop-filter:var(--glass); border:1px solid var(--border); border-radius:var(--radius); padding:16px 14px; text-align:center; position:relative; overflow:hidden; transition:var(--transition); box-shadow:var(--shadow-sm); }
  .stat-card:hover { border-color:var(--border-hover); transform:translateY(-2px); box-shadow:var(--shadow-md); }
  .stat-card::before { content:''; position:absolute; top:0; left:0; right:0; height:2px; opacity:0.6; }
  .stat-card:nth-child(1)::before { background:var(--accent); }
  .stat-card:nth-child(2)::before { background:var(--angel-gold); }
  .stat-card:nth-child(3)::before { background:var(--green); }
  .stat-card:nth-child(4)::before { background:var(--purple); }
  .stat-card:nth-child(5)::before { background:var(--red); }
  .stat-card:nth-child(6)::before { background:var(--orange); }
  .stat-value { font-size:24px; font-weight:900; margin-bottom:2px; letter-spacing:-0.5px; }
  .stat-label { font-size:9px; color:var(--text-dim); text-transform:uppercase; letter-spacing:0.8px; font-weight:600; }

  /* Activity */
  .activity-item { display:flex; align-items:flex-start; gap:10px; padding:8px 10px; border-radius:var(--radius-sm); margin-bottom:4px; background:rgba(20,24,37,0.5); border-left:3px solid var(--border); transition:var(--transition); }
  .activity-item:hover { background:rgba(28,32,53,0.6); transform:translateX(2px); }
  .activity-item.cat-scan { border-left-color:var(--accent); }
  .activity-item.cat-cycle { border-left-color:var(--green); }
  .activity-item.cat-alert,.activity-item.cat-security_alert,.activity-item.cat-shield_alert,.activity-item.cat-error { border-left-color:var(--red); }
  .activity-item.cat-shield { border-left-color:var(--purple); }
  .activity-item.cat-drift { border-left-color:var(--yellow); }
  .activity-item.cat-lifecycle { border-left-color:var(--text-dim); }
  .activity-item.cat-legion { border-left-color:var(--accent); }
  .activity-body { flex:1; min-width:0; }
  .activity-cat { font-size:8px; font-weight:700; text-transform:uppercase; letter-spacing:0.6px; }
  .activity-time { font-size:9px; color:var(--text-muted); margin-left:6px; }
  .activity-text { font-size:10px; margin-top:2px; word-break:break-word; line-height:1.5; }

  /* Tables */
  .table-wrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
  .data-table { width:100%; border-collapse:collapse; font-size:11px; white-space:nowrap; }
  .data-table th { text-align:left; padding:8px 10px; font-size:9px; text-transform:uppercase; letter-spacing:0.6px; color:var(--text-dim); border-bottom:1px solid var(--border); font-weight:700; }
  .data-table td { padding:8px 10px; border-bottom:1px solid rgba(42,47,74,0.4); }
  .data-table tr { transition:var(--transition); }
  .data-table tr:hover { background:rgba(124,168,255,0.04); cursor:pointer; }
  .data-table tbody tr:last-child td { border-bottom:none; }
  .status-badge { display:inline-flex; align-items:center; gap:4px; padding:3px 9px; border-radius:10px; font-size:9px; font-weight:700; letter-spacing:0.2px; }
  .status-active { background:var(--green-dim); color:var(--green); }
  .status-active::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--green); }
  .status-degraded { background:var(--yellow-dim); color:var(--yellow); }
  .status-degraded::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--yellow); }
  .status-offline { background:var(--red-dim); color:var(--red); }
  .status-offline::before { content:''; width:5px; height:5px; border-radius:50%; background:var(--red); }
  .status-enforce { background:var(--red-dim); color:var(--red); }
  .status-monitor { background:var(--yellow-dim); color:var(--yellow); }
  .status-off { background:var(--surface2); color:var(--text-muted); }

  /* Alert items */
  .alert-item { display:flex; align-items:flex-start; gap:10px; padding:7px 10px; border-radius:var(--radius-sm); margin-bottom:4px; transition:var(--transition); }
  .alert-item:hover { background:rgba(28,32,53,0.5); }
  .alert-icon { font-size:14px; flex-shrink:0; margin-top:1px; }
  .alert-body { flex:1; min-width:0; }
  .alert-title { font-size:11px; font-weight:600; }
  .alert-meta { font-size:9px; color:var(--text-dim); margin-top:2px; }
  .alert-sev { font-size:8px; padding:2px 7px; border-radius:var(--radius-xs); font-weight:700; letter-spacing:0.2px; }
  .sev-critical { background:var(--red-dim); color:var(--red); }
  .sev-high { background:var(--orange-dim); color:var(--orange); }
  .sev-warn,.sev-medium { background:var(--yellow-dim); color:var(--yellow); }
  .sev-info,.sev-low { background:var(--accent-dim); color:var(--accent); }

  /* Threat chart */
  .threat-chart { display:flex; flex-direction:column; gap:6px; }
  .threat-row { display:flex; align-items:center; gap:10px; }
  .threat-label { width:75px; font-size:10px; color:var(--text-dim); text-align:right; font-weight:600; }
  .threat-bar-bg { flex:1; height:22px; background:rgba(28,32,53,0.5); border-radius:var(--radius-xs); overflow:hidden; }
  .threat-bar-fill { height:100%; border-radius:var(--radius-xs); display:flex; align-items:center; padding-left:8px; font-size:9px; font-weight:700; min-width:26px; transition:width 0.6s cubic-bezier(0.4,0,0.2,1); }

  /* Grid layouts */
  .two-col { display:grid; grid-template-columns:repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
  .three-col { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; }

  /* Settings controls */
  .pref-row { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .pref-label { min-width:95px; color:var(--text-dim); font-size:11px; font-weight:600; }
  .pref-select, .pref-input {
    flex:1; padding:7px 10px; border-radius:var(--radius-sm); border:1px solid var(--border);
    background:rgba(28,32,53,0.6); color:var(--text); font-size:11px; font-family:var(--font); outline:none;
    max-width:100%; min-width:0; transition:var(--transition);
  }
  .pref-select:focus, .pref-input:focus { border-color:var(--accent); box-shadow:0 0 0 3px rgba(124,168,255,0.1); }
  .btn { padding:7px 16px; border-radius:var(--radius-sm); border:1px solid var(--border); background:rgba(28,32,53,0.6); color:var(--text); font-size:11px; cursor:pointer; font-weight:600; transition:var(--transition); }
  .btn:hover { border-color:var(--accent); background:var(--accent-dim); transform:translateY(-1px); }
  .btn:active { transform:translateY(0); }
  .btn-primary { background:var(--accent-dim); color:var(--accent); border-color:rgba(124,168,255,0.3); }
  .btn-primary:hover { background:rgba(124,168,255,0.2); box-shadow:0 0 12px rgba(124,168,255,0.15); }
  .btn-danger { background:var(--red-dim); color:var(--red); border-color:rgba(248,113,113,0.3); }
  .btn-danger:hover { background:rgba(248,113,113,0.2); }
  .btn-success { background:var(--green-dim); color:var(--green); border-color:rgba(74,222,128,0.3); }
  .btn-success:hover { background:rgba(74,222,128,0.2); }

  /* Halo Score */
  .halo-score { display:flex; align-items:center; gap:16px; }
  .halo-ring { width:64px; height:64px; border-radius:50%; position:relative; display:flex; align-items:center; justify-content:center; }
  .halo-ring .halo-val { font-size:18px; font-weight:900; z-index:1; letter-spacing:-0.5px; }
  .halo-ring svg { position:absolute; top:0; left:0; transform:rotate(-90deg); }
  .halo-ring svg circle:last-child { transition:stroke-dashoffset 1s cubic-bezier(0.4,0,0.2,1); }
  .halo-meta { flex:1; }
  .halo-label { font-size:9px; text-transform:uppercase; letter-spacing:0.8px; color:var(--text-dim); font-weight:700; }
  .halo-desc { font-size:11px; color:var(--text-dim); margin-top:3px; }

  /* Shield grid */
  .shield-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(85px,1fr)); gap:8px; }
  .shield-stat { text-align:center; padding:8px 4px; border-radius:var(--radius-sm); background:rgba(20,24,37,0.4); transition:var(--transition); }
  .shield-stat:hover { background:rgba(28,32,53,0.5); }
  .shield-stat .val { font-size:18px; font-weight:800; }
  .shield-stat .lbl { font-size:9px; color:var(--text-dim); font-weight:600; margin-top:2px; }

  /* Chat */
  .chat-header { padding:14px 16px; border-bottom:1px solid var(--border); font-size:13px; font-weight:700; display:flex; align-items:center; gap:8px; background:var(--angel-halo); }
  .chat-header .angel-chat-icon { color:var(--angel-gold); font-size:16px; filter:drop-shadow(0 0 6px rgba(240,200,80,0.3)); }
  .chat-messages { flex:1; overflow-y:auto; padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
  .chat-msg { padding:12px 16px; border-radius:14px; font-size:12px; line-height:1.7; max-width:92%; word-wrap:break-word; animation:fadeIn 0.25s ease-out; }
  .chat-msg.system { background:rgba(28,32,53,0.7); align-self:flex-start; border:1px solid var(--border); border-bottom-left-radius:4px; backdrop-filter:var(--glass); }
  .chat-msg.user { background:linear-gradient(135deg,rgba(124,168,255,0.15),rgba(192,132,252,0.1)); color:var(--text); align-self:flex-end; border:1px solid rgba(124,168,255,0.2); border-bottom-right-radius:4px; }
  .chat-msg .actions { margin-top:10px; display:flex; flex-direction:column; gap:6px; }
  .action-card { background:rgba(10,12,20,0.6); border:1px solid var(--border); border-radius:var(--radius-sm); padding:10px 12px; font-size:10px; cursor:pointer; transition:var(--transition); display:flex; align-items:center; justify-content:space-between; }
  .action-card:hover { border-color:var(--accent); background:var(--accent-dim); transform:translateX(2px); }
  .action-card .action-title { font-weight:700; color:var(--accent); }
  .action-card .action-desc { color:var(--text-dim); margin-top:2px; }
  .action-card .apply-btn { padding:3px 10px; border-radius:var(--radius-xs); font-size:9px; font-weight:700; background:var(--green-dim); color:var(--green); border:1px solid rgba(74,222,128,0.2); cursor:pointer; transition:var(--transition); }
  .action-card .apply-btn:hover { background:var(--green); color:#000; box-shadow:0 0 12px rgba(74,222,128,0.2); }
  .chat-input-row { padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; background:rgba(20,24,37,0.5); }
  .chat-input { flex:1; padding:10px 16px; border-radius:12px; border:1px solid var(--border); background:rgba(28,32,53,0.6); color:var(--text); font-size:12px; font-family:var(--font); outline:none; transition:var(--transition); }
  .chat-input:focus { border-color:var(--angel-gold); box-shadow:0 0 0 3px rgba(240,200,80,0.08); }
  .chat-input::placeholder { color:var(--text-muted); }
  .chat-send { padding:10px 20px; border-radius:12px; border:none; background:var(--angel-wing); color:#000; font-weight:700; cursor:pointer; font-size:12px; transition:var(--transition); }
  .chat-send:hover { opacity:0.9; transform:scale(1.02); box-shadow:0 0 16px rgba(240,200,80,0.2); }
  .chat-send:disabled { opacity:0.3; cursor:not-allowed; transform:none; }
  .chat-typing { font-size:11px; color:var(--angel-gold); padding:6px 16px; display:flex; align-items:center; gap:6px; }
  .typing-dots span { display:inline-block; width:5px; height:5px; border-radius:50%; background:var(--angel-gold); animation:typing 1.4s infinite; }
  .typing-dots span:nth-child(2) { animation-delay:0.2s; }
  .typing-dots span:nth-child(3) { animation-delay:0.4s; }
  @keyframes typing { 0%,60%,100%{opacity:0.3} 30%{opacity:1} }

  /* Modal */
  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(8px); }
  .modal-overlay.visible { display:flex; }
  .modal { background:var(--surface-solid); border:1px solid var(--border); border-radius:var(--radius); width:720px; max-width:90vw; max-height:80vh; display:flex; flex-direction:column; box-shadow:var(--shadow-lg); animation:fadeIn 0.2s ease-out; }
  .modal-header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; border-bottom:1px solid var(--border); }
  .modal-header h2 { font-size:15px; font-weight:700; display:flex; align-items:center; gap:8px; }
  .modal-close { background:none; border:1px solid var(--border); color:var(--text-dim); font-size:16px; cursor:pointer; padding:4px 8px; border-radius:var(--radius-xs); transition:var(--transition); }
  .modal-close:hover { background:var(--red-dim); border-color:var(--red); color:var(--red); }
  .modal-body { flex:1; overflow-y:auto; padding:16px 20px; }

  /* Timeline */
  .timeline { display:flex; flex-direction:column; }
  .tl-entry { display:flex; gap:12px; padding:8px 0; border-left:2px solid var(--border); margin-left:10px; padding-left:16px; position:relative; transition:var(--transition); }
  .tl-entry:hover { background:rgba(124,168,255,0.03); }
  .tl-entry::before { content:''; position:absolute; left:-5px; top:12px; width:8px; height:8px; border-radius:50%; background:var(--border); transition:var(--transition); }
  .tl-entry:hover::before { transform:scale(1.3); }
  .tl-entry.tl-event::before { background:var(--accent); box-shadow:0 0 6px rgba(124,168,255,0.3); }
  .tl-entry.tl-policy::before { background:var(--yellow); box-shadow:0 0 6px rgba(251,191,36,0.3); }
  .tl-entry.tl-session::before { background:var(--green); box-shadow:0 0 6px rgba(74,222,128,0.3); }
  .tl-entry.tl-ai::before { background:var(--purple); box-shadow:0 0 6px rgba(192,132,252,0.3); }
  .tl-entry.tl-critical::before { background:var(--red); box-shadow:0 0 6px rgba(248,113,113,0.3); }
  .tl-entry.tl-high::before { background:var(--orange); box-shadow:0 0 6px rgba(251,146,60,0.3); }
  .tl-time { font-size:9px; color:var(--text-dim); min-width:65px; font-family:var(--mono); }
  .tl-content { flex:1; }
  .tl-summary { font-size:11px; line-height:1.5; }
  .tl-type-badge { font-size:8px; padding:2px 6px; border-radius:4px; font-weight:700; display:inline-block; margin-right:4px; }
  .tl-type-event { background:var(--accent-dim); color:var(--accent); }
  .tl-type-policy { background:var(--yellow-dim); color:var(--yellow); }
  .tl-type-session { background:var(--green-dim); color:var(--green); }
  .tl-type-ai { background:var(--purple-dim); color:var(--purple); }

  /* Login */
  .login-page { display:flex; align-items:center; justify-content:center; min-height:100vh; background:var(--bg); position:relative; overflow:hidden; }
  .login-page::before { content:''; position:absolute; width:500px; height:500px; border-radius:50%; background:radial-gradient(circle,rgba(240,200,80,0.06),transparent 70%); top:10%; left:20%; animation:float 8s ease-in-out infinite; }
  .login-page::after { content:''; position:absolute; width:400px; height:400px; border-radius:50%; background:radial-gradient(circle,rgba(124,168,255,0.05),transparent 70%); bottom:10%; right:15%; animation:float 10s ease-in-out infinite reverse; }
  @keyframes float { 0%,100%{transform:translate(0,0)} 50%{transform:translate(30px,-20px)} }
  .login-box { background:var(--surface); backdrop-filter:var(--glass); border:1px solid var(--border); border-radius:var(--radius); padding:36px; width:380px; max-width:90vw; max-width:90dvw; position:relative; overflow:hidden; box-shadow:var(--shadow-lg); z-index:1; animation:fadeIn 0.4s ease-out; }
  .login-box::before { content:''; position:absolute; top:0; left:0; right:0; height:3px; background:var(--angel-wing); }
  .login-box h2 { font-size:20px; margin-bottom:6px; display:flex; align-items:center; gap:10px; font-weight:800; }
  .login-box .login-sub { color:var(--text-dim); font-size:12px; margin-bottom:24px; }
  .login-box input { width:100%; padding:12px 14px; margin-bottom:12px; border-radius:var(--radius-sm); border:1px solid var(--border); background:rgba(28,32,53,0.6); color:var(--text); font-size:13px; font-family:var(--font); outline:none; transition:var(--transition); }
  .login-box input:focus { border-color:var(--angel-gold); box-shadow:0 0 0 3px rgba(240,200,80,0.08); }
  .login-box button { width:100%; padding:12px; border-radius:var(--radius-sm); border:none; background:var(--angel-wing); color:#000; font-weight:700; cursor:pointer; font-size:13px; margin-top:6px; transition:var(--transition); }
  .login-box button:hover { opacity:0.9; transform:translateY(-1px); box-shadow:0 4px 20px rgba(240,200,80,0.15); }
  .login-box button:active { transform:translateY(0); }
  .login-error { color:var(--red); font-size:11px; margin-bottom:8px; display:none; padding:6px 10px; background:var(--red-dim); border-radius:var(--radius-xs); border:1px solid rgba(248,113,113,0.2); }

  .loading { color:var(--text-dim); font-size:11px; text-align:center; padding:20px; }
  .loading::after { content:''; display:inline-block; width:14px; height:14px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:halo-spin 0.6s linear infinite; margin-left:8px; vertical-align:middle; }
  .empty { color:var(--text-muted); font-size:11px; text-align:center; padding:20px; }
  .page-title { font-size:18px; font-weight:800; margin-bottom:4px; display:flex; align-items:center; gap:10px; letter-spacing:-0.3px; }
  .page-subtitle { font-size:12px; color:var(--text-dim); margin-bottom:14px; line-height:1.5; }

  /* Responsive */
  @media (max-width:1100px) {
    .chat-panel { width:290px; }
    .search-bar { min-width:140px; }
  }
  @media (max-width:900px) {
    .sidebar { position:fixed; left:-260px; top:50px; bottom:0; z-index:300; transition:left 0.25s cubic-bezier(0.4,0,0.2,1); box-shadow:4px 0 24px rgba(0,0,0,0.6); }
    .sidebar.open { left:0; }
    .mobile-menu-btn { display:block; }
    .chat-panel { display:none; }
    .chat-panel.mobile-open { display:flex; position:fixed; top:50px; right:0; bottom:0; left:0; width:100%; z-index:250; }
    .chat-toggle { display:block; }
    .stats { grid-template-columns:repeat(3,1fr); }
    .two-col,.three-col { grid-template-columns:1fr; }
    .main-content { padding:14px; }
    .search-bar { display:none; }
  }
  @media (max-width:480px) {
    .stats { grid-template-columns:repeat(2,1fr); }
    .header h1 { font-size:13px; }
    .header-right .guardian-status { display:none; }
    .stat-card { padding:12px 10px; }
    .stat-value { font-size:20px; }
  }
</style>
</head>
<body>

<!-- Login Page -->
<div class="login-page" id="login-page" style="display:none">
  <div class="login-box">
    <h2><span class="angel-icon">&#128737;</span> AngelClaw AGI</h2>
    <div class="login-sub">Administrative Console &mdash; Sign in to continue</div>
    <div class="login-error" id="login-error"></div>
    <input type="text" id="login-user" placeholder="Username" autocomplete="username" />
    <input type="password" id="login-pass" placeholder="Password" autocomplete="current-password" />
    <button onclick="doLogin()">Sign In</button>
  </div>
</div>

<!-- Main App -->
<div id="main-app" style="display:none">
<div class="header">
  <div style="display:flex;align-items:center;gap:8px">
    <button class="mobile-menu-btn" onclick="toggleSidebar()">&#9776;</button>
    <h1>
      <span class="angel-icon">&#128737;</span>
      <span class="brand-text"><span class="brand-name">AngelClaw</span><span class="brand-sub">AGI Guardian</span></span>
      <span class="version-pill">V7.3.0</span>
    </h1>
  </div>
  <div class="header-right">
    <div class="search-bar" onclick="document.getElementById('search-input').focus()">
      <span style="opacity:0.5">&#128270;</span>
      <input type="text" id="search-input" placeholder="Seraph Brain Search..." onkeydown="if(event.key==='Enter')seraphSearch(this.value)" />
      <kbd>/</kbd>
    </div>
    <div class="guardian-status"><span class="dot"></span> Protected</div>
    <div class="user-badge" id="user-badge" style="display:none">
      <span id="user-name">&mdash;</span>
      <span class="role-tag" id="user-role">&mdash;</span>
    </div>
    <button class="logout-btn" id="logout-btn" style="display:none" onclick="doLogout()">Logout</button>
  </div>
</div>

<div class="app-layout">
  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-section">
      <div class="sidebar-section-title">Overview</div>
      <div class="nav-item active" onclick="navigate('dashboard')" data-page="dashboard">
        <span class="nav-icon">&#127968;</span> Dashboard
      </div>
      <div class="nav-item" onclick="navigate('fleet')" data-page="fleet">
        <span class="nav-icon">&#128421;</span> Fleet
        <span class="nav-badge green" id="nav-fleet-count">0</span>
      </div>
      <div class="nav-item" onclick="navigate('tenants')" data-page="tenants">
        <span class="nav-icon">&#127970;</span> Tenants
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Security</div>
      <div class="nav-item" onclick="navigate('alerts')" data-page="alerts">
        <span class="nav-icon">&#9888;</span> Alerts
        <span class="nav-badge" id="nav-alert-count">0</span>
      </div>
      <div class="nav-item" onclick="navigate('legion')" data-page="legion">
        <span class="nav-icon">&#9876;</span> Legion
      </div>
      <div class="nav-item" onclick="navigate('anti-tamper')" data-page="anti-tamper">
        <span class="nav-icon">&#128274;</span> Anti-Tamper
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Intelligence</div>
      <div class="nav-item" onclick="navigate('analytics')" data-page="analytics">
        <span class="nav-icon">&#128200;</span> Analytics
      </div>
      <div class="nav-item" onclick="navigate('threat-intel')" data-page="threat-intel">
        <span class="nav-icon">&#128270;</span> Threat Intel
      </div>
      <div class="nav-item" onclick="navigate('learning')" data-page="learning">
        <span class="nav-icon">&#129504;</span> Self-Learning
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">Operations</div>
      <div class="nav-item" onclick="navigate('assets')" data-page="assets">
        <span class="nav-icon">&#128451;</span> Assets
      </div>
      <div class="nav-item" onclick="navigate('soar')" data-page="soar">
        <span class="nav-icon">&#9889;</span> SOAR
      </div>
      <div class="nav-item" onclick="navigate('zero-trust')" data-page="zero-trust">
        <span class="nav-icon">&#128272;</span> Zero Trust
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">AGI Platform</div>
      <div class="nav-item" onclick="navigate('transcendence')" data-page="transcendence">
        <span class="nav-icon">&#129302;</span> AI Engine
      </div>
      <div class="nav-item" onclick="navigate('convergence')" data-page="convergence">
        <span class="nav-icon">&#128338;</span> Real-Time
      </div>
      <div class="nav-item" onclick="navigate('omniguard')" data-page="omniguard">
        <span class="nav-icon">&#9729;</span> Cloud Security
      </div>
      <div class="nav-item" onclick="navigate('prometheus')" data-page="prometheus">
        <span class="nav-icon">&#127919;</span> Threat Hunting
      </div>
      <div class="nav-item" onclick="navigate('empyrion')" data-page="empyrion">
        <span class="nav-icon">&#9889;</span> AGI Defense
      </div>
    </div>
    <div class="sidebar-section">
      <div class="sidebar-section-title">System</div>
      <div class="nav-item" onclick="navigate('policies')" data-page="policies">
        <span class="nav-icon">&#128220;</span> Policies
      </div>
      <div class="nav-item" onclick="navigate('settings')" data-page="settings">
        <span class="nav-icon">&#9881;</span> Settings
      </div>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content" id="main-content">
    <!-- Pages rendered dynamically by JS -->
  </div>

  <!-- CHAT PANEL -->
  <div class="chat-panel" id="chat-panel">
    <div class="chat-header">
      <span class="angel-chat-icon">&#128737;</span>
      <span>AngelClaw AI</span>
      <span style="font-size:9px;color:var(--text-dim);margin-left:auto" id="chat-daemon-pill">--</span>
    </div>
    <div class="chat-messages" id="chat-messages">
      <div class="chat-msg system">
        I'm <strong>AngelClaw AGI Guardian</strong> &mdash; your autonomous security companion.<br><br>
        Ask about threats, agents, policies, or help using AI safely.
      </div>
    </div>
    <div id="chat-typing" class="chat-typing" style="display:none">
      <span class="typing-dots"><span></span><span></span><span></span></span>
      Thinking...
    </div>
    <div class="chat-input-row">
      <input class="chat-input" id="chat-input" placeholder="Ask AngelClaw..." />
      <button class="chat-send" id="chat-send" onclick="sendChat()">Send</button>
    </div>
  </div>
</div>

<button class="chat-toggle" id="chat-toggle" onclick="toggleMobileChat()">&#128737;</button>
</div>

<!-- Timeline Modal -->
<div class="modal-overlay" id="timeline-modal">
  <div class="modal">
    <div class="modal-header">
      <h2>&#128337; <span id="tl-agent-name">Agent Timeline</span></h2>
      <button class="modal-close" onclick="closeModal('timeline-modal')">&times;</button>
    </div>
    <div class="modal-body" id="tl-body"><div class="loading">Loading...</div></div>
  </div>
</div>

<script>
/* ===== ANGELCLAW V7.3.0 "EMPYRION" ADMIN CONSOLE ===== */
const BASE = window.location.origin;
const chatHistory = [];
let authToken = localStorage.getItem('angelclaw_token') || '';
let authUser = null;
let currentPage = 'dashboard';
let cachedData = {};

/* Helpers */
const sevIcon = s => ({critical:'&#9888;&#65039;',high:'&#128308;',warn:'&#128992;',medium:'&#128992;',low:'&#128309;',info:'&#128310;'}[s]||'&#9679;');
const sevClass = s => 'sev-'+(s==='warn'?'medium':s);
const statusClass = s => s==='active'?'status-active':s==='degraded'?'status-degraded':'status-offline';
const ago = ts => { if(!ts) return 'never'; const d=new Date(ts); const m=Math.floor((Date.now()-d)/60000); return m<1?'just now':m<60?m+'m ago':m<1440?Math.floor(m/60)+'h ago':Math.floor(m/1440)+'d ago'; };
const catColor = c => ({shell:'var(--red)',network:'var(--orange)',file:'var(--yellow)',ai_tool:'var(--accent)',db:'var(--purple)',auth:'var(--red)',config:'var(--yellow)',system:'var(--text-dim)'}[c]||'var(--accent)');
const esc = t => t ? String(t).replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
const haloColor = s => s>=80?'var(--green)':s>=60?'var(--yellow)':s>=40?'var(--orange)':'var(--red)';

function authHeaders() { const h={'Content-Type':'application/json'}; if(authToken) h['Authorization']='Bearer '+authToken; return h; }
async function fetchJSON(path) {
  try { const r=await fetch(BASE+path,{headers:authHeaders()}); if(r.status===401){showLogin();return null;} if(!r.ok) return null; return await r.json(); } catch{return null;}
}
async function postJSON(path, body) {
  try { const r=await fetch(BASE+path,{method:'POST',headers:authHeaders(),body:JSON.stringify(body)}); if(r.status===401){showLogin();return null;} return await r.json(); } catch{return null;}
}

/* Auth */
async function checkAuth() {
  try {
    const r=await fetch(BASE+'/api/v1/auth/me',{headers:authHeaders()});
    if(r.ok) { const d=await r.json(); if(!d.auth_enabled){showApp(null);return true;} authUser=d; showApp(d); return true; }
    const h=await fetch(BASE+'/health'); if(h.ok) { const r2=await fetch(BASE+'/api/v1/auth/me'); if(r2.ok) { const d=await r2.json(); if(!d.auth_enabled){showApp(null);return true;} } }
    showLogin(); return false;
  } catch{showApp(null);return true;}
}
function showLogin() { document.getElementById('login-page').style.display='flex'; document.getElementById('main-app').style.display='none'; }
function showApp(user) {
  document.getElementById('login-page').style.display='none'; document.getElementById('main-app').style.display='block';
  if(user) { document.getElementById('user-badge').style.display='flex'; document.getElementById('user-name').textContent=user.username; const r=document.getElementById('user-role'); r.textContent=user.role; r.className='role-tag role-'+user.role; document.getElementById('logout-btn').style.display='inline-block'; }
}
async function doLogin() {
  const user=document.getElementById('login-user').value.trim(), pass=document.getElementById('login-pass').value, err=document.getElementById('login-error');
  err.style.display='none'; if(!user||!pass){err.textContent='Username and password required';err.style.display='block';return;}
  try { const r=await fetch(BASE+'/api/v1/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,password:pass})}); if(r.ok){const d=await r.json();authToken=d.access_token;localStorage.setItem('angelclaw_token',authToken);authUser={username:d.username,role:d.role};showApp(authUser);bootstrapDashboard();}else{const e=await r.json().catch(()=>({detail:'Login failed'}));err.textContent=e.detail||'Login failed';err.style.display='block';} } catch(e){err.textContent='Connection error';err.style.display='block';}
}
function doLogout() { authToken='';authUser=null;localStorage.removeItem('angelclaw_token');showLogin(); }
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

/* Seraph Brain Search */
function seraphSearch(query) {
  if(!query||!query.trim()) return;
  const q=query.trim().toLowerCase();
  const pages=['dashboard','fleet','tenants','alerts','legion','anti-tamper','analytics','threat-intel','learning','assets','soar','zero-trust','transcendence','convergence','omniguard','prometheus','empyrion','policies','settings'];
  const match=pages.find(p=>p.includes(q)||q.includes(p));
  if(match){navigate(match);document.getElementById('search-input').value='';return;}
  document.getElementById('search-input').value='';
  document.getElementById('chat-input').value=query;
  sendChat();
}
document.addEventListener('keydown',e=>{if(e.key==='/'&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA'){e.preventDefault();document.getElementById('search-input').focus();}});

/* Navigation */
function navigate(page) {
  currentPage=page;
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const el=document.querySelector(`.nav-item[data-page="${page}"]`); if(el) el.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');
  renderPage();
}
function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
function toggleMobileChat() { document.getElementById('chat-panel').classList.toggle('mobile-open'); }

/* Render Halo Score ring */
function renderHaloRing(score, size=64) {
  const c=haloColor(score), r=size/2-4, circ=2*Math.PI*r, offset=circ-(score/100)*circ;
  return `<div class="halo-ring" style="width:${size}px;height:${size}px"><span class="halo-val" style="color:${c}">${score}</span><svg width="${size}" height="${size}"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="var(--border)" stroke-width="4"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="${c}" stroke-width="4" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" stroke-linecap="round"/></svg></div>`;
}

/* Page renderers */
async function renderPage() {
  const mc=document.getElementById('main-content');
  mc.innerHTML='<div class="loading">Loading...</div>';
  switch(currentPage) {
    case 'dashboard': return renderDashboard(mc);
    case 'fleet': return renderFleet(mc);
    case 'tenants': return renderTenants(mc);
    case 'alerts': return renderAlerts(mc);
    case 'legion': return renderLegion(mc);
    case 'anti-tamper': return renderAntiTamper(mc);
    case 'analytics': return renderAnalytics(mc);
    case 'learning': return renderLearning(mc);
    case 'threat-intel': return renderThreatIntel(mc);
    case 'assets': return renderAssets(mc);
    case 'soar': return renderSOAR(mc);
    case 'zero-trust': return renderZeroTrust(mc);
    case 'transcendence': return renderTranscendence(mc);
    case 'convergence': return renderConvergence(mc);
    case 'omniguard': return renderOmniguard(mc);
    case 'prometheus': return renderPrometheus(mc);
    case 'empyrion': return renderEmpyrion(mc);
    case 'policies': return renderPolicies(mc);
    case 'settings': return renderSettings(mc);
    default: mc.innerHTML='<div class="empty">Page not found</div>';
  }
}

/* === DASHBOARD === */
async function renderDashboard(mc) {
  const [agents,events,orch,activity,daemon,alerts,shield,threats] = await Promise.all([
    fetchJSON('/api/v1/agents'), fetchJSON('/api/v1/incidents/recent?limit=30'),
    fetchJSON('/api/v1/orchestrator/status'), fetchJSON('/api/v1/angelclaw/activity/recent?limit=12'),
    fetchJSON('/api/v1/angelclaw/daemon/status'), fetchJSON('/api/v1/guardian/alerts/recent?tenantId=dev-tenant&limit=10'),
    fetchJSON('/api/v1/angelclaw/shield/status'), fetchJSON('/api/v1/analytics/threat-matrix?lookback_hours=24'),
  ]);
  cachedData.agents=agents; cachedData.alerts=alerts;
  const agentCount=agents?agents.length:0, eventCount=events?events.length:0;
  const blocked=events?events.filter(e=>['critical','high'].includes(e.severity)).length:0;
  const alertCount=alerts?alerts.length:0;
  const oi=orch?orch.stats||{}:{};
  document.getElementById('nav-fleet-count').textContent=agentCount;
  document.getElementById('nav-alert-count').textContent=alertCount;

  let html = `
    <div class="stats">
      <div class="stat-card"><div class="stat-value" style="color:var(--accent)">${agentCount}</div><div class="stat-label">Agents</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--angel-gold)">${eventCount}</div><div class="stat-label">Events (24h)</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--green)">${blocked}</div><div class="stat-label">Blocked</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--purple)">${oi.indicators_found||0}</div><div class="stat-label">Indicators</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--red)">${alertCount}</div><div class="stat-label">Alerts</div></div>
      <div class="stat-card"><div class="stat-value" style="color:var(--orange)">${oi.incidents_created||0}</div><div class="stat-label">Incidents</div></div>
    </div>`;

  // Activity panel
  html += `<div class="card glow" style="background:var(--angel-halo)"><div class="card-header"><span class="card-title"><span class="icon">&#128737;</span> Guardian Activity</span><span class="card-badge gold">${daemon&&daemon.running?'ACTIVE ('+daemon.cycles_completed+' cycles)':'STOPPED'}</span></div><div style="max-height:200px;overflow-y:auto">`;
  if(activity&&activity.length) {
    html += activity.map(a=>`<div class="activity-item cat-${esc(a.category)}"><div class="activity-body"><span class="activity-cat">${esc(a.category)}</span><span class="activity-time">${ago(a.timestamp)}</span><div class="activity-text">${esc(a.summary)}</div></div></div>`).join('');
  } else html += '<div class="empty">Guardian starting up...</div>';
  html += '</div></div>';

  // Two columns: Alerts + Orchestrator
  html += '<div class="two-col">';
  // Alerts
  html += `<div class="card"><div class="card-header"><span class="card-title"><span class="icon">&#9888;</span> Guardian Alerts</span><span class="card-badge red">${alertCount}</span></div><div style="max-height:200px;overflow-y:auto">`;
  if(alerts&&alerts.length) html += alerts.map(a=>`<div class="alert-item"><span class="alert-icon">${sevIcon(a.severity)}</span><div class="alert-body"><div class="alert-title">${esc(a.title)}</div><div class="alert-meta">${esc(a.severity)} &middot; ${ago(a.created_at)}</div></div></div>`).join('');
  else html += '<div class="empty">No alerts. All clear.</div>';
  html += '</div></div>';
  // Orchestrator
  html += `<div class="card"><div class="card-header"><span class="card-title"><span class="icon">&#9881;</span> AGI Orchestrator</span><span class="card-badge ${orch&&orch.running?'green':'red'}">${orch&&orch.running?'RUNNING':'STOPPED'}</span></div>`;
  if(orch) {
    html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:4px 12px;font-size:11px"><span><span style="color:var(--text-dim)">Events:</span> ${oi.events_processed||0}</span><span><span style="color:var(--text-dim)">Indicators:</span> ${oi.indicators_found||0}</span><span><span style="color:var(--text-dim)">Incidents:</span> ${oi.incidents_created||0}</span><span><span style="color:var(--text-dim)">Responses:</span> ${oi.responses_executed||0}</span></div>`;
    if(orch.agents) { html+='<div style="margin-top:8px;font-size:10px">'; for(const [n,i] of Object.entries(orch.agents)){const c=(i.status==='idle'||i.status==='ok')?'var(--green)':'var(--yellow)';html+=`<span style="margin-right:10px"><span style="color:${c}">&#9679;</span> ${n}</span>`;} html+='</div>'; }
  }
  html += '</div></div>';

  // Two columns: Fleet + Threats
  html += '<div class="two-col">';
  // Fleet preview
  html += `<div class="card"><div class="card-header"><span class="card-title"><span class="icon">&#128421;</span> Fleet</span><span class="card-badge">${agentCount}</span></div><div style="max-height:220px;overflow-y:auto">`;
  if(agents&&agents.length) {
    html += '<table class="data-table"><thead><tr><th>Host</th><th>Status</th><th>OS</th><th>Seen</th></tr></thead><tbody>';
    html += agents.slice(0,10).map(a=>`<tr onclick="navigate('fleet')"><td>${esc(a.hostname)}</td><td><span class="status-badge ${statusClass(a.status)}">${esc(a.status)}</span></td><td>${esc(a.os)}</td><td>${ago(a.last_seen_at)}</td></tr>`).join('');
    html += '</tbody></table>';
  } else html += '<div class="empty">No agents registered.</div>';
  html += '</div></div>';
  // Threats
  html += `<div class="card"><div class="card-header"><span class="card-title"><span class="icon">&#127919;</span> Threat Landscape</span></div>`;
  if(threats&&threats.length) {
    const max=Math.max(...threats.map(d=>d.total_events),1);
    html += '<div class="threat-chart">'+threats.slice(0,6).map(d=>{const pct=Math.max(8,(d.total_events/max)*100);return `<div class="threat-row"><span class="threat-label">${esc(d.category)}</span><div class="threat-bar-bg"><div class="threat-bar-fill" style="width:${pct}%;background:${catColor(d.category)}">${d.total_events}</div></div></div>`;}).join('')+'</div>';
  } else html += '<div class="empty">No threat data.</div>';
  html += '</div></div>';

  // Shield
  html += `<div class="card"><div class="card-header"><span class="card-title"><span class="icon">&#128737;</span> AngelClaw Shield</span><span class="card-badge">${shield?esc(shield.last_risk_level||'unknown').toUpperCase():'--'}</span></div><div class="shield-grid"><div class="shield-stat"><div class="val">${shield?shield.assessments_run||0:'--'}</div><div class="lbl">Checks</div></div><div class="shield-stat"><div class="val">${shield?(shield.injection_patterns||0)+(shield.leakage_patterns||0):'--'}</div><div class="lbl">Patterns</div></div><div class="shield-stat"><div class="val">${shield?shield.skills_registered||0:'--'}</div><div class="lbl">Skills</div></div><div class="shield-stat"><div class="val">${shield?(shield.evil_agi_patterns||0):'--'}</div><div class="lbl">Evil AGI</div></div></div></div>`;

  mc.innerHTML = html;
}

/* === FLEET === */
async function renderFleet(mc) {
  const agents = await fetchJSON('/api/v1/agents');
  cachedData.agents = agents;
  const total=agents?agents.length:0, active=agents?agents.filter(a=>a.status==='active').length:0;
  let html = `<div class="page-title">&#128421; Fleet &mdash; Angel Nodes</div><div class="page-subtitle">${total} total &mdash; ${active} active</div>`;
  if(agents&&agents.length) {
    html += `<div class="card"><div class="table-wrap"><table class="data-table"><thead><tr><th>Hostname</th><th>Status</th><th>Type</th><th>OS</th><th>Version</th><th>Tags</th><th>Last Seen</th></tr></thead><tbody>`;
    html += agents.map(a=>`<tr onclick="openTimeline('${esc(a.agent_id)}','${esc(a.hostname)}')"><td><strong>${esc(a.hostname)}</strong></td><td><span class="status-badge ${statusClass(a.status)}">${esc(a.status)}</span></td><td>${esc(a.type||'node')}</td><td>${esc(a.os)}</td><td>${esc(a.version)}</td><td>${(a.tags||[]).map(t=>'<span style="font-size:9px;padding:1px 5px;border-radius:4px;background:var(--surface3);margin-right:3px">'+esc(t)+'</span>').join('')}</td><td>${ago(a.last_seen_at)}</td></tr>`).join('');
    html += '</tbody></table></div></div>';
  } else html += '<div class="empty">No agents registered yet. Deploy Angel Nodes to see them here.</div>';
  mc.innerHTML = html;
}

/* === TENANTS === */
async function renderTenants(mc) {
  const data = await fetchJSON('/api/v1/admin/tenants');
  const tenants = data || [{id:'dev-tenant',name:'Development',status:'active',agent_count:cachedData.agents?cachedData.agents.length:0,halo_score:85}];
  let html = `<div class="page-title">&#127970; Tenants</div><div class="page-subtitle">Organization-wide tenant management</div>`;
  html += '<div class="card"><table class="data-table"><thead><tr><th>Tenant</th><th>Status</th><th>Agents</th><th>Halo Score</th><th>Wingspan</th></tr></thead><tbody>';
  tenants.forEach(t => {
    const score = t.halo_score||85;
    html += `<tr><td><strong>${esc(t.name||t.id)}</strong><div style="font-size:9px;color:var(--text-muted)">${esc(t.id)}</div></td><td><span class="status-badge status-active">${esc(t.status||'active')}</span></td><td>${t.agent_count||0}</td><td>${renderHaloRing(score,40)}</td><td>${t.wingspan||0}%</td></tr>`;
  });
  html += '</tbody></table></div>';
  mc.innerHTML = html;
}

/* === ALERTS === */
async function renderAlerts(mc) {
  const alerts = await fetchJSON('/api/v1/guardian/alerts/recent?tenantId=dev-tenant&limit=50');
  let html = `<div class="page-title">&#9888; Guardian Alerts</div><div class="page-subtitle">${alerts?alerts.length:0} recent alerts</div>`;
  if(alerts&&alerts.length) {
    html += '<div class="card">'+alerts.map(a=>`<div class="alert-item" style="padding:8px 10px;margin-bottom:4px;background:var(--surface2);border-radius:var(--radius-sm);border-left:3px solid ${a.severity==='critical'?'var(--red)':a.severity==='high'?'var(--orange)':'var(--yellow)'}"><div class="alert-body"><div class="alert-title"><span class="alert-sev ${sevClass(a.severity)}">${esc(a.severity)}</span> ${esc(a.title)}</div><div class="alert-meta">${esc(a.alert_type)} &middot; ${ago(a.created_at)} &middot; ${(a.related_agent_ids||[]).length} agent(s)</div></div></div>`).join('')+'</div>';
  } else html += '<div class="card"><div class="empty">No alerts. All clear.</div></div>';
  mc.innerHTML = html;
}

/* === LEGION === */
async function renderLegion(mc) {
  const orch = await fetchJSON('/api/v1/orchestrator/status');
  let html = `<div class="page-title">&#9876; Angel Legion</div><div class="page-subtitle">Seraph Orchestrator &mdash; Warden status and performance</div>`;
  if(orch) {
    html += `<div class="stats" style="grid-template-columns:repeat(4,1fr)">
      <div class="stat-card"><div class="stat-value" style="color:var(--green)">${orch.running?'ON':'OFF'}</div><div class="stat-label">Status</div></div>
      <div class="stat-card"><div class="stat-value">${orch.legion?orch.legion.total_agents||0:0}</div><div class="stat-label">Total Wardens</div></div>
      <div class="stat-card"><div class="stat-value">${(orch.stats||{}).events_processed||0}</div><div class="stat-label">Events Processed</div></div>
      <div class="stat-card"><div class="stat-value">${(orch.stats||{}).indicators_found||0}</div><div class="stat-label">Indicators</div></div>
    </div>`;
    // Warden list
    if(orch.agents) {
      html += '<div class="card" style="margin-top:14px"><div class="card-header"><span class="card-title">Wardens</span></div><table class="data-table"><thead><tr><th>Agent</th><th>Type</th><th>Status</th><th>Avg Latency</th><th>Indicators</th></tr></thead><tbody>';
      for(const [name,info] of Object.entries(orch.agents)) {
        const perf = (orch.warden_performance||{})[name]||{};
        const st = info.status; const color = (st==='idle'||st==='ok')?'var(--green)':'var(--yellow)';
        html += `<tr><td><span style="color:${color}">&#9679;</span> ${esc(name)}</td><td>${esc(info.agent_type||'warden')}</td><td>${esc(st)}</td><td>${perf.avg_latency_ms?perf.avg_latency_ms+'ms':'--'}</td><td>${perf.indicators_found||0}</td></tr>`;
      }
      html += '</tbody></table></div>';
    }
    // Incidents
    const incidents = await fetchJSON('/api/v1/orchestrator/incidents?limit=10');
    const incList = incidents?(incidents.incidents||[]):[];
    html += `<div class="card" style="margin-top:14px"><div class="card-header"><span class="card-title">&#128680; Incidents</span><span class="card-badge">${incList.length}</span></div>`;
    if(incList.length) {
      html += incList.map(inc=>{const needsApproval=inc.requires_approval&&(inc.state==='triaging'||inc.state==='new');const btn=needsApproval?` <button class="btn btn-primary" style="font-size:9px;padding:2px 8px" onclick="approveIncident('${esc(inc.incident_id)}')">Approve</button>`:'';return `<div class="alert-item" style="padding:6px 8px;margin-bottom:3px;background:var(--surface2);border-radius:6px"><div class="alert-body"><div class="alert-title"><span class="alert-sev ${sevClass(inc.severity)}">${esc(inc.state)}</span> ${esc((inc.title||'').substring(0,80))}${btn}</div><div class="alert-meta">${esc(inc.severity)} &middot; ${ago(inc.created_at)}</div></div></div>`;}).join('');
    } else html += '<div class="empty">No incidents.</div>';
    html += '</div>';
  } else html += '<div class="card"><div class="empty">Orchestrator unavailable.</div></div>';
  mc.innerHTML = html;
}

/* === ANTI-TAMPER === */
async function renderAntiTamper(mc) {
  const status = await fetchJSON('/api/v1/admin/anti-tamper/status');
  const events = await fetchJSON('/api/v1/admin/anti-tamper/events');
  let html = `<div class="page-title">&#128274; Anti-Tamper Protection</div><div class="page-subtitle">Monitor and enforce integrity of Angel Nodes</div>`;
  // Status overview
  html += '<div class="stats" style="grid-template-columns:repeat(4,1fr)">';
  if(status) {
    html += `<div class="stat-card"><div class="stat-value" style="color:var(--green)">${status.enforced_count||0}</div><div class="stat-label">Enforced</div></div>`;
    html += `<div class="stat-card"><div class="stat-value" style="color:var(--yellow)">${status.monitored_count||0}</div><div class="stat-label">Monitored</div></div>`;
    html += `<div class="stat-card"><div class="stat-value" style="color:var(--text-muted)">${status.disabled_count||0}</div><div class="stat-label">Disabled</div></div>`;
    html += `<div class="stat-card"><div class="stat-value" style="color:var(--red)">${status.tamper_events_24h||0}</div><div class="stat-label">Events (24h)</div></div>`;
  } else { html += '<div class="stat-card"><div class="stat-value">--</div><div class="stat-label">Status unavailable</div></div>'; }
  html += '</div>';
  // Configure
  html += `<div class="two-col"><div class="card"><div class="card-header"><span class="card-title">Configure Anti-Tamper</span></div>
    <div class="pref-row"><label class="pref-label">Tenant:</label><select class="pref-select" id="at-tenant"><option value="dev-tenant">dev-tenant</option></select></div>
    <div class="pref-row"><label class="pref-label">Mode:</label><select class="pref-select" id="at-mode"><option value="off">Off</option><option value="monitor" selected>Monitor</option><option value="enforce">Enforce</option></select></div>
    <div class="pref-row"><label class="pref-label">Agent ID:</label><input class="pref-input" id="at-agent" placeholder="(all agents)" /></div>
    <button class="btn btn-primary" style="margin-top:8px" onclick="configureAntiTamper()">Apply Configuration</button>
    <div id="at-result" style="font-size:10px;margin-top:6px;min-height:14px"></div>
  </div>`;
  // Events
  html += `<div class="card"><div class="card-header"><span class="card-title">Tamper Events</span><span class="card-badge red">${events?events.length:0}</span></div><div style="max-height:240px;overflow-y:auto">`;
  if(events&&events.length) {
    html += events.map(e=>`<div class="alert-item" style="padding:5px 8px;margin-bottom:3px;background:var(--surface2);border-radius:6px"><div class="alert-body"><div class="alert-title"><span class="alert-sev ${sevClass(e.severity)}">${esc(e.event_type)}</span> ${esc(e.description)}</div><div class="alert-meta">${ago(e.created_at)}</div></div></div>`).join('');
  } else html += '<div class="empty">No tamper events detected.</div>';
  html += '</div></div></div>';
  mc.innerHTML = html;
}
async function configureAntiTamper() {
  const tenant=document.getElementById('at-tenant').value, mode=document.getElementById('at-mode').value, agent=document.getElementById('at-agent').value.trim();
  const body = {tenant_id:tenant, mode:mode}; if(agent) body.agent_id=agent;
  const r=await postJSON('/api/v1/admin/anti-tamper/configure',body);
  document.getElementById('at-result').innerHTML = r?'<span style="color:var(--green)">Configuration applied</span>':'<span style="color:var(--red)">Failed to apply</span>';
}

/* === ANALYTICS === */
async function renderAnalytics(mc) {
  const [threats,reports,trends] = await Promise.all([
    fetchJSON('/api/v1/analytics/threat-matrix?lookback_hours=24'),
    fetchJSON('/api/v1/guardian/reports/recent?tenantId=dev-tenant&limit=5'),
    fetchJSON('/api/v1/admin/analytics/trends'),
  ]);
  let html = `<div class="page-title">&#128200; Analytics & Intelligence</div><div class="page-subtitle">Threat landscape, trends, and risk analysis</div>`;
  // Threats
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Threat Matrix (24h)</span></div>';
  if(threats&&threats.length) {
    const max=Math.max(...threats.map(d=>d.total_events),1);
    html += '<div class="threat-chart">'+threats.map(d=>{const pct=Math.max(8,(d.total_events/max)*100);return `<div class="threat-row"><span class="threat-label">${esc(d.category)}</span><div class="threat-bar-bg"><div class="threat-bar-fill" style="width:${pct}%;background:${catColor(d.category)}">${d.total_events}</div></div></div>`;}).join('')+'</div>';
  } else html += '<div class="empty">No data</div>';
  html += '</div>';
  // Trends
  html += '<div class="card"><div class="card-header"><span class="card-title">Trends</span></div>';
  if(trends&&trends.overall_direction) {
    const dir=trends.overall_direction;
    html += `<div style="font-size:12px;margin-bottom:8px">Direction: <strong style="color:${dir==='escalating'?'var(--red)':dir==='declining'?'var(--green)':'var(--text-dim)'}">${esc(dir)}</strong></div>`;
    if(trends.by_category) { html += trends.by_category.slice(0,8).map(c=>`<div style="font-size:10px;display:flex;justify-content:space-between;padding:2px 0"><span>${esc(c.category)}</span><span style="color:${c.trend_direction==='escalating'?'var(--red)':c.trend_direction==='declining'?'var(--green)':'var(--text-dim)'}">${c.current_count} (${esc(c.trend_direction)})</span></div>`).join(''); }
  } else html += '<div class="empty">No trend data</div>';
  html += '</div></div>';
  // Reports
  html += '<div class="card"><div class="card-header"><span class="card-title">Recent Reports</span></div>';
  if(reports&&reports.length) {
    html += '<table class="data-table"><thead><tr><th>Time</th><th>Agents</th><th>Events</th><th>Anomalies</th><th>Summary</th></tr></thead><tbody>';
    html += reports.map(r=>`<tr><td>${ago(r.timestamp)}</td><td>${r.agents_total} (${r.agents_active} active)</td><td>${r.incidents_total}</td><td>${(r.anomalies||[]).length}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(r.summary)}</td></tr>`).join('');
    html += '</tbody></table>';
  } else html += '<div class="empty">No reports</div>';
  html += '</div>';
  mc.innerHTML = html;
}

/* === SELF-LEARNING === */
async function renderLearning(mc) {
  const learning = await fetchJSON('/api/v1/admin/analytics/risk-scores');
  let html = `<div class="page-title">&#129504; Self-Learning Engine</div><div class="page-subtitle">Autonomous learning, feedback tracking, and adaptive thresholds</div>`;
  html += '<div class="two-col">';
  // Learning summary
  html += '<div class="card"><div class="card-header"><span class="card-title">Learning State</span></div>';
  if(learning) {
    html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Reflections:</span><span>${learning.total_reflections||0}</span></div>`;
    html += `<div class="pref-row"><span class="pref-label">Effectiveness:</span><span>${learning.detection_effectiveness!==undefined?(learning.detection_effectiveness*100).toFixed(0)+'%':'--'}</span></div>`;
    html += `<div class="pref-row"><span class="pref-label">Severity Trend:</span><span>${learning.escalation_rate?esc(learning.escalation_rate.direction):'stable'}</span></div></div>`;
  } else html += '<div class="empty">Learning data unavailable</div>';
  html += '</div>';
  // Playbook ranking
  html += '<div class="card"><div class="card-header"><span class="card-title">Playbook Ranking</span></div>';
  if(learning&&learning.playbook_ranking&&learning.playbook_ranking.length) {
    html += '<table class="data-table"><thead><tr><th>Playbook</th><th>Success</th><th>Fail</th><th>Rate</th></tr></thead><tbody>';
    html += learning.playbook_ranking.map(p=>`<tr><td>${esc(p.playbook)}</td><td>${p.success_count}</td><td>${p.fail_count}</td><td style="color:${p.success_rate>=0.7?'var(--green)':'var(--yellow)'}">${(p.success_rate*100).toFixed(0)}%</td></tr>`).join('');
    html += '</tbody></table>';
  } else html += '<div class="empty">No playbook data yet</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === POLICIES === */
async function renderPolicies(mc) {
  const policies = await fetchJSON('/api/v1/analytics/policy/evolution');
  let html = `<div class="page-title">&#128220; Policies</div><div class="page-subtitle">Policy management and history</div>`;
  html += '<div class="card"><div class="card-header"><span class="card-title">Policy Evolution</span></div>';
  if(policies&&policies.length) {
    html += '<table class="data-table"><thead><tr><th>Name</th><th>Rules</th><th>Version</th><th>Created</th></tr></thead><tbody>';
    html += policies.map(p=>`<tr><td>${esc(p.name)}</td><td>${p.rule_count}</td><td style="font-family:var(--mono);font-size:9px">${esc((p.version_hash||'').substring(0,12))}</td><td>${ago(p.created_at)}</td></tr>`).join('');
    html += '</tbody></table>';
  } else html += '<div class="empty">No policies</div>';
  html += '</div>';
  mc.innerHTML = html;
}

/* === SETTINGS === */
async function renderSettings(mc) {
  const prefs = await fetchJSON('/api/v1/angelclaw/preferences?tenantId=dev-tenant');
  const daemon = await fetchJSON('/api/v1/angelclaw/daemon/status');
  let html = `<div class="page-title">&#9881; Settings</div><div class="page-subtitle">Guardian configuration and preferences</div>`;
  html += '<div class="two-col">';
  // Preferences
  html += '<div class="card"><div class="card-header"><span class="card-title">Guardian Preferences</span><span class="card-badge gold">V7.3.0</span></div><div style="display:flex;flex-direction:column;gap:8px">';
  const autonomy=prefs?prefs.autonomy_level:'suggest_only', scanFreq=prefs?prefs.scan_frequency_minutes:10, reporting=prefs?prefs.reporting_level:'normal';
  html += `<div class="pref-row"><label class="pref-label">Autonomy:</label><select class="pref-select" id="pref-autonomy" onchange="updatePref('autonomy_level',this.value)"><option value="observe_only" ${autonomy==='observe_only'?'selected':''}>Observe Only</option><option value="suggest_only" ${autonomy==='suggest_only'?'selected':''}>Suggest Only</option><option value="assist" ${autonomy==='assist'?'selected':''}>Assist</option><option value="autonomous_apply" ${autonomy==='autonomous_apply'?'selected':''}>Autonomous</option></select></div>`;
  html += `<div class="pref-row"><label class="pref-label">Scan (min):</label><select class="pref-select" id="pref-scan" onchange="updatePref('scan_frequency_minutes',parseInt(this.value))"><option value="1" ${scanFreq==1?'selected':''}>1</option><option value="5" ${scanFreq==5?'selected':''}>5</option><option value="10" ${scanFreq==10?'selected':''}>10</option><option value="30" ${scanFreq==30?'selected':''}>30</option><option value="60" ${scanFreq==60?'selected':''}>60</option></select></div>`;
  html += `<div class="pref-row"><label class="pref-label">Reporting:</label><select class="pref-select" id="pref-reporting" onchange="updatePref('reporting_level',this.value)"><option value="quiet" ${reporting==='quiet'?'selected':''}>Quiet</option><option value="normal" ${reporting==='normal'?'selected':''}>Normal</option><option value="verbose" ${reporting==='verbose'?'selected':''}>Verbose</option></select></div>`;
  html += '<div id="pref-status" style="font-size:10px;color:var(--text-dim);min-height:14px"></div></div></div>';
  // Daemon
  html += '<div class="card"><div class="card-header"><span class="card-title">Daemon Status</span><span class="card-badge '+(daemon&&daemon.running?'green':'red')+'">'+(daemon&&daemon.running?'ACTIVE':'STOPPED')+'</span></div>';
  if(daemon) {
    html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Cycles:</span><span>${daemon.cycles_completed}</span></div><div class="pref-row"><span class="pref-label">Last scan:</span><span>${esc(daemon.last_scan_summary||'none')}</span></div><div class="pref-row"><span class="pref-label">Activity log:</span><span>${daemon.activity_count} entries</span></div></div>`;
  }
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === THREAT INTEL (V3.5) === */
async function renderThreatIntel(mc) {
  const [feeds,iocs,rep] = await Promise.all([
    fetchJSON('/api/v1/intel/feeds?tenant_id=dev-tenant'),
    fetchJSON('/api/v1/intel/iocs/matches?tenant_id=dev-tenant&limit=20'),
    fetchJSON('/api/v1/intel/reputation/top?tenant_id=dev-tenant&limit=10'),
  ]);
  let html = `<div class="page-title">&#128270; Threat Intelligence</div><div class="page-subtitle">Feeds, IOC matching, and reputation scoring</div>`;
  html += '<div class="stats"><div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(feeds?feeds.length:0)+'</div><div class="stat-label">Feeds</div></div><div class="stat-card"><div class="stat-value" style="color:var(--red)">'+(iocs?iocs.length:0)+'</div><div class="stat-label">IOC Matches</div></div><div class="stat-card"><div class="stat-value" style="color:var(--orange)">'+(rep?rep.length:0)+'</div><div class="stat-label">Reputation Entries</div></div></div>';
  html += '<div class="two-col">';
  // Feeds
  html += '<div class="card"><div class="card-header"><span class="card-title">Active Feeds</span></div>';
  if(feeds&&feeds.length) { html += '<table class="data-table"><thead><tr><th>Name</th><th>Type</th><th>IOCs</th><th>Status</th></tr></thead><tbody>'; feeds.forEach(f=>{ html += `<tr><td>${esc(f.name||f.feed_name)}</td><td>${esc(f.feed_type||f.type||'--')}</td><td>${f.ioc_count||0}</td><td><span class="status-badge status-active">${esc(f.status||'active')}</span></td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No feeds configured</div>';
  html += '</div>';
  // IOC Matches
  html += '<div class="card"><div class="card-header"><span class="card-title">Recent IOC Matches</span><span class="card-badge red">'+(iocs?iocs.length:0)+'</span></div><div style="max-height:260px;overflow-y:auto">';
  if(iocs&&iocs.length) { iocs.forEach(m=>{ html += `<div class="alert-item" style="padding:5px 8px;margin-bottom:3px;background:var(--surface2);border-radius:6px;border-left:3px solid var(--red)"><div class="alert-body"><div class="alert-title"><span class="alert-sev sev-high">${esc(m.ioc_type||'IOC')}</span> ${esc(m.ioc_value||m.matched_value||'')}</div><div class="alert-meta">${esc(m.source||'feed')} &middot; ${ago(m.matched_at||m.created_at)}</div></div></div>`; }); } else html += '<div class="empty">No matches found</div>';
  html += '</div></div></div>';
  // Reputation
  html += '<div class="card"><div class="card-header"><span class="card-title">Reputation Scores</span></div>';
  if(rep&&rep.length) { html += '<table class="data-table"><thead><tr><th>Entity</th><th>Type</th><th>Score</th><th>Reports</th></tr></thead><tbody>'; rep.forEach(r=>{ const sc=r.score||0; const color=sc>=70?'var(--red)':sc>=40?'var(--orange)':'var(--green)'; html += `<tr><td style="font-family:var(--mono);font-size:10px">${esc((r.entity||r.value||'').substring(0,40))}</td><td>${esc(r.entity_type||r.type)}</td><td style="color:${color};font-weight:700">${sc}</td><td>${r.report_count||r.reports||0}</td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No reputation data</div>';
  html += '</div>';
  mc.innerHTML = html;
}

/* === ASSETS (V4.0) === */
async function renderAssets(mc) {
  const [assets,vulns,topo] = await Promise.all([
    fetchJSON('/api/v1/assets?tenant_id=dev-tenant&limit=30'),
    fetchJSON('/api/v1/assets/vulnerabilities?tenant_id=dev-tenant&limit=20'),
    fetchJSON('/api/v1/assets/topology/stats?tenant_id=dev-tenant'),
  ]);
  const assetList = assets||[];
  let html = `<div class="page-title">&#128451; Asset Inventory & Topology</div><div class="page-subtitle">Discover, classify, and monitor all assets</div>`;
  html += '<div class="stats"><div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+assetList.length+'</div><div class="stat-label">Assets</div></div><div class="stat-card"><div class="stat-value" style="color:var(--red)">'+(vulns?vulns.length:0)+'</div><div class="stat-label">Vulnerabilities</div></div><div class="stat-card"><div class="stat-value" style="color:var(--purple)">'+(topo?topo.total_links||0:0)+'</div><div class="stat-label">Topology Links</div></div></div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Assets</span></div>';
  if(assetList.length) { html += '<div class="table-wrap"><table class="data-table"><thead><tr><th>Name</th><th>Type</th><th>IP</th><th>OS</th><th>Risk</th><th>Status</th></tr></thead><tbody>'; assetList.forEach(a=>{ const rc=a.risk_score>=70?'var(--red)':a.risk_score>=40?'var(--orange)':'var(--green)'; html += `<tr><td><strong>${esc(a.name)}</strong></td><td>${esc(a.asset_type||'--')}</td><td style="font-family:var(--mono);font-size:10px">${esc(a.ip_address||'--')}</td><td>${esc(a.os||'--')}</td><td style="color:${rc};font-weight:700">${a.risk_score||0}</td><td><span class="status-badge status-active">${esc(a.status||'active')}</span></td></tr>`; }); html += '</tbody></table></div>'; } else html += '<div class="empty">No assets registered. Use the API to add assets.</div>';
  html += '</div>';
  mc.innerHTML = html;
}

/* === SOAR (V4.0) === */
async function renderSOAR(mc) {
  const [playbooks,sla] = await Promise.all([
    fetchJSON('/api/v1/soar/playbooks?tenant_id=dev-tenant'),
    fetchJSON('/api/v1/soar/sla?tenant_id=dev-tenant'),
  ]);
  let html = `<div class="page-title">&#9889; SOAR & Automation</div><div class="page-subtitle">Playbooks, orchestration, and SLA tracking</div>`;
  html += '<div class="stats"><div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(playbooks?playbooks.length:0)+'</div><div class="stat-label">Playbooks</div></div><div class="stat-card"><div class="stat-value" style="color:var(--green)">'+(sla?sla.length:0)+'</div><div class="stat-label">SLA Policies</div></div></div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Playbooks</span></div>';
  if(playbooks&&playbooks.length) { html += '<table class="data-table"><thead><tr><th>Name</th><th>Trigger</th><th>Steps</th><th>Runs</th><th>Status</th></tr></thead><tbody>'; playbooks.forEach(p=>{ html += `<tr><td><strong>${esc(p.name)}</strong></td><td>${esc(p.trigger_condition||'manual')}</td><td>${p.steps?p.steps.length:0}</td><td>${p.execution_count||0}</td><td><span class="status-badge status-active">${esc(p.status||'active')}</span></td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No playbooks defined</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">SLA Policies</span></div>';
  if(sla&&sla.length) { html += '<table class="data-table"><thead><tr><th>Name</th><th>Severity</th><th>Target</th><th>Breaches</th></tr></thead><tbody>'; sla.forEach(s=>{ html += `<tr><td>${esc(s.name||s.policy_name)}</td><td><span class="alert-sev ${sevClass(s.severity)}">${esc(s.severity)}</span></td><td>${s.target_minutes||s.response_time_minutes||'--'}m</td><td style="color:${s.breach_count>0?'var(--red)':'var(--green)'}">${s.breach_count||0}</td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No SLA policies</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === ZERO TRUST (V4.5) === */
async function renderZeroTrust(mc) {
  const [status,devices,sessions] = await Promise.all([
    fetchJSON('/api/v1/convergence/status'),
    fetchJSON('/api/v1/zerotrust/devices?tenant_id=dev-tenant'),
    fetchJSON('/api/v1/zerotrust/sessions?tenant_id=dev-tenant&limit=20'),
  ]);
  const devList = devices||[];
  const sessList = sessions||[];
  let html = `<div class="page-title">&#128272; Zero Trust Architecture</div><div class="page-subtitle">Device trust, identity policies, microsegmentation, and session risk</div>`;
  html += '<div class="stats"><div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+devList.length+'</div><div class="stat-label">Devices</div></div><div class="stat-card"><div class="stat-value" style="color:var(--green)">'+sessList.length+'</div><div class="stat-label">Sessions</div></div></div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Device Trust</span></div>';
  if(devList.length) { html += '<table class="data-table"><thead><tr><th>Device</th><th>OS</th><th>Trust</th><th>Risk</th></tr></thead><tbody>'; devList.slice(0,15).forEach(d=>{ const tc=d.trust_score>=80?'var(--green)':d.trust_score>=60?'var(--yellow)':d.trust_score>=40?'var(--orange)':'var(--red)'; html += `<tr><td>${esc(d.device_name||d.device_id||'--')}</td><td>${esc(d.os_family||'--')}</td><td style="color:${tc};font-weight:700">${d.trust_score||0}/100</td><td>${esc(d.risk_level||'--')}</td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No devices assessed</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Active Sessions</span></div>';
  if(sessList.length) { html += '<table class="data-table"><thead><tr><th>User</th><th>Risk</th><th>Action</th><th>Geo</th></tr></thead><tbody>'; sessList.slice(0,15).forEach(s=>{ const rc=s.risk_score>=70?'var(--red)':s.risk_score>=40?'var(--orange)':'var(--green)'; html += `<tr><td>${esc(s.user_id||'--')}</td><td style="color:${rc};font-weight:700">${s.risk_score||0}</td><td>${esc(s.recommended_action||'--')}</td><td>${esc(s.geo_location||'--')}</td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No active sessions</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === TRANSCENDENCE (V5.0) === */
async function renderTranscendence(mc) {
  const [models,compliance,forensics,evolving] = await Promise.all([
    fetchJSON('/api/v1/transcendence/ai/models?tenant_id=dev-tenant'),
    fetchJSON('/api/v1/transcendence/compliance/stats?tenant_id=dev-tenant'),
    fetchJSON('/api/v1/transcendence/forensics/cases?tenant_id=dev-tenant'),
    fetchJSON('/api/v1/transcendence/evolving/stats?tenant_id=dev-tenant'),
  ]);
  let html = `<div class="page-title">&#129302; AI Engine &mdash; Transcendence</div><div class="page-subtitle">AI orchestration, compliance-as-code, forensics, and self-evolving rules</div>`;
  html += '<div class="stats"><div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(models?models.length:0)+'</div><div class="stat-label">AI Models</div></div><div class="stat-card"><div class="stat-value" style="color:var(--green)">'+(compliance?compliance.pass_rate||'--':'--')+'</div><div class="stat-label">Compliance Rate</div></div><div class="stat-card"><div class="stat-value" style="color:var(--purple)">'+(forensics?forensics.length:0)+'</div><div class="stat-label">Forensic Cases</div></div><div class="stat-card"><div class="stat-value" style="color:var(--orange)">'+(evolving?evolving.total_rules||0:0)+'</div><div class="stat-label">Evolving Rules</div></div></div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">AI Model Registry</span></div>';
  if(models&&models.length) { html += '<table class="data-table"><thead><tr><th>Model</th><th>Provider</th><th>Capabilities</th><th>Status</th></tr></thead><tbody>'; models.forEach(m=>{ html += `<tr><td><strong>${esc(m.name||m.model_name)}</strong></td><td>${esc(m.provider||'--')}</td><td>${(m.capabilities||[]).slice(0,3).map(c=>'<span style="font-size:9px;padding:1px 4px;border-radius:4px;background:var(--surface3);margin-right:2px">'+esc(c)+'</span>').join('')}</td><td><span class="status-badge ${m.enabled!==false?'status-active':'status-offline'}">${m.enabled!==false?'active':'disabled'}</span></td></tr>`; }); html += '</tbody></table>'; } else html += '<div class="empty">No AI models registered</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Compliance Status</span></div>';
  if(compliance) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Frameworks:</span><span>${compliance.total_frameworks||0}</span></div><div class="pref-row"><span class="pref-label">Rules:</span><span>${compliance.total_rules||0}</span></div><div class="pref-row"><span class="pref-label">Last audit:</span><span>${compliance.last_audit||'never'}</span></div></div>`; } else html += '<div class="empty">No compliance data</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === CONVERGENCE (V5.5) === */
async function renderConvergence(mc) {
  const [status,halo] = await Promise.all([
    fetchJSON('/api/v1/convergence/status'),
    fetchJSON('/api/v1/convergence/halo/current'),
  ]);
  const rt = status?status.realtime:null;
  const fleet = status?status.fleet:null;
  const haloScore = halo?halo.score:null;
  let html = `<div class="page-title">&#128338; Real-Time Defense Fabric</div><div class="page-subtitle">Live metrics, Halo Score, fleet orchestration</div>`;
  html += '<div class="stats">';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--angel-gold)">'+(haloScore!==null?haloScore:'--')+'</div><div class="stat-label">Halo Score</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(rt?rt.total_events||0:0)+'</div><div class="stat-label">Events</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--green)">'+(fleet?fleet.total_nodes||0:0)+'</div><div class="stat-label">Fleet Nodes</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--purple)">'+(fleet?fleet.active_nodes||0:0)+'</div><div class="stat-label">Active Nodes</div></div>';
  html += '</div>';
  // Halo Score Ring
  if(haloScore!==null) { const haloText=haloScore>=80?'Excellent — All systems optimal':haloScore>=60?'Good — Minor improvements possible':haloScore>=40?'Needs Improvement — Review recommended':'Critical — Immediate action required'; html += '<div class="card glow" style="background:var(--angel-halo)"><div class="card-header"><span class="card-title"><span class="icon">&#128737;</span> Halo Score</span><span class="card-badge gold">V5.5</span></div><div class="halo-score">'+renderHaloRing(haloScore,80)+'<div class="halo-meta"><div class="halo-label">Security Posture</div><div class="halo-desc">'+haloText+'</div></div></div></div>'; }
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Real-Time Metrics</span></div>';
  if(rt) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Total events:</span><span>${rt.total_events||0}</span></div><div class="pref-row"><span class="pref-label">Subscribers:</span><span>${rt.subscribers||0}</span></div></div>`; } else html += '<div class="empty">No real-time data</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Fleet Orchestrator</span></div>';
  if(fleet) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Total nodes:</span><span>${fleet.total_nodes||0}</span></div><div class="pref-row"><span class="pref-label">Active:</span><span>${fleet.active_nodes||0}</span></div><div class="pref-row"><span class="pref-label">Commands:</span><span>${fleet.commands_dispatched||0}</span></div></div>`; } else html += '<div class="empty">No fleet data</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === OMNIGUARD (V6.0) === */
async function renderOmniguard(mc) {
  const status = await fetchJSON('/api/v1/omniguard/status');
  const cloud = status?status.cloud_connectors:null;
  const cspm = status?status.cspm:null;
  const saas = status?status.saas_shield:null;
  const mesh = status?status.hybrid_mesh:null;
  let html = `<div class="page-title">&#9729; Cloud Security &mdash; Omniguard</div><div class="page-subtitle">Multi-cloud defense, CSPM, SaaS shield, hybrid mesh</div>`;
  html += '<div class="stats">';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(cloud?cloud.total_connectors||0:0)+'</div><div class="stat-label">Cloud Connectors</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--red)">'+(cspm?cspm.total_findings||0:0)+'</div><div class="stat-label">CSPM Findings</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--purple)">'+(saas?saas.total_apps||0:0)+'</div><div class="stat-label">SaaS Apps</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--green)">'+(mesh?mesh.total_environments||0:0)+'</div><div class="stat-label">Mesh Envs</div></div>';
  html += '</div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Cloud Connectors</span></div>';
  if(cloud&&cloud.total_connectors) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Connectors:</span><span>${cloud.total_connectors}</span></div><div class="pref-row"><span class="pref-label">Resources:</span><span>${cloud.total_resources||0}</span></div></div>`; } else html += '<div class="empty">No cloud connectors. Add via API.</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">CSPM</span></div>';
  if(cspm&&cspm.total_findings) { const crit=cspm.critical_findings||0; html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Findings:</span><span>${cspm.total_findings}</span></div><div class="pref-row"><span class="pref-label">Critical:</span><span style="color:var(--red)">${crit}</span></div><div class="pref-row"><span class="pref-label">Posture:</span><span>${cspm.posture_score||'--'}/100</span></div></div>`; } else html += '<div class="empty">No CSPM scans yet</div>';
  html += '</div></div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">SaaS Shield</span></div>';
  if(saas&&saas.total_apps) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Apps:</span><span>${saas.total_apps}</span></div><div class="pref-row"><span class="pref-label">Shadow IT:</span><span style="color:var(--orange)">${saas.shadow_it_discovered||0}</span></div><div class="pref-row"><span class="pref-label">Sessions:</span><span>${saas.total_sessions||0}</span></div></div>`; } else html += '<div class="empty">No SaaS apps monitored</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Hybrid Mesh</span></div>';
  if(mesh&&mesh.total_environments) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Environments:</span><span>${mesh.total_environments}</span></div><div class="pref-row"><span class="pref-label">Federation:</span><span>${mesh.total_federation_links||0} links</span></div><div class="pref-row"><span class="pref-label">Syncs:</span><span>${mesh.total_policy_syncs||0}</span></div></div>`; } else html += '<div class="empty">No environments registered</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === PROMETHEUS (V6.5) === */
async function renderPrometheus(mc) {
  const status = await fetchJSON('/api/v1/prometheus/status');
  const hunt = status?status.threat_hunter:null;
  const mitre = status?status.mitre_mapper:null;
  const adv = status?status.adversary_sim:null;
  const corr = status?status.intel_correlation:null;
  let html = `<div class="page-title">&#127919; Threat Hunting &mdash; Prometheus</div><div class="page-subtitle">Autonomous hunting, MITRE ATT&CK, adversary simulation, intel correlation</div>`;
  html += '<div class="stats">';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(hunt?hunt.total_hunts||0:0)+'</div><div class="stat-label">Hunts</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--purple)">'+(mitre?mitre.total_techniques||0:0)+'</div><div class="stat-label">MITRE Techniques</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--red)">'+(adv?adv.total_scenarios||0:0)+'</div><div class="stat-label">Scenarios</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--orange)">'+(corr?corr.total_correlations||0:0)+'</div><div class="stat-label">Correlations</div></div>';
  html += '</div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Threat Hunter</span></div>';
  if(hunt&&hunt.total_hunts) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Total hunts:</span><span>${hunt.total_hunts}</span></div><div class="pref-row"><span class="pref-label">Completed:</span><span style="color:var(--green)">${hunt.completed_hunts||0}</span></div><div class="pref-row"><span class="pref-label">Findings:</span><span>${hunt.total_findings||0}</span></div><div class="pref-row"><span class="pref-label">Playbooks:</span><span>${hunt.total_playbooks||0}</span></div></div>`; } else html += '<div class="empty">No hunts yet. Start one via API or chat.</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">MITRE ATT&CK Coverage</span></div>';
  if(mitre&&mitre.total_techniques) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Techniques:</span><span>${mitre.total_techniques}</span></div><div class="pref-row"><span class="pref-label">Mappings:</span><span>${mitre.total_mappings||0}</span></div><div class="pref-row"><span class="pref-label">Coverage:</span><span>${mitre.coverage_pct||'--'}%</span></div></div>`; } else html += '<div class="empty">No MITRE techniques tracked</div>';
  html += '</div></div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Adversary Simulation</span></div>';
  if(adv&&adv.total_scenarios) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Scenarios:</span><span>${adv.total_scenarios}</span></div><div class="pref-row"><span class="pref-label">Simulations:</span><span>${adv.total_simulations||0}</span></div><div class="pref-row"><span class="pref-label">Detection rate:</span><span style="color:var(--green)">${adv.avg_detection_rate||'--'}%</span></div></div>`; } else html += '<div class="empty">No scenarios defined</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Intel Correlation</span></div>';
  if(corr&&corr.total_correlations) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Correlations:</span><span>${corr.total_correlations}</span></div><div class="pref-row"><span class="pref-label">Patterns:</span><span>${corr.total_patterns||0}</span></div><div class="pref-row"><span class="pref-label">Campaigns:</span><span>${corr.total_campaigns||0}</span></div></div>`; } else html += '<div class="empty">No correlations yet</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

/* === EMPYRION (V7.0) === */
async function renderEmpyrion(mc) {
  const status = await fetchJSON('/api/v1/empyrion/status');
  const agi = status?status.agi_defense:null;
  const resp = status?status.autonomous_response:null;
  const fed = status?status.threat_federation:null;
  const soc = status?status.soc_autopilot:null;
  let html = `<div class="page-title">&#9889; AGI Defense &mdash; Empyrion</div><div class="page-subtitle">Self-programming defense, autonomous response, threat federation, SOC autopilot</div>`;
  html += '<div class="stats">';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--angel-gold)">'+(agi?agi.total_rules||0:0)+'</div><div class="stat-label">AGI Rules</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--red)">'+(resp?resp.total_responses||0:0)+'</div><div class="stat-label">Auto Responses</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--accent)">'+(fed?fed.total_indicators_shared||0:0)+'</div><div class="stat-label">Shared Intel</div></div>';
  html += '<div class="stat-card"><div class="stat-value" style="color:var(--green)">'+(soc?soc.total_triaged||0:0)+'</div><div class="stat-label">SOC Triaged</div></div>';
  html += '</div>';
  html += '<div class="two-col">';
  html += '<div class="card glow" style="background:var(--angel-halo)"><div class="card-header"><span class="card-title"><span class="icon">&#129302;</span> AGI Defense Engine</span><span class="card-badge gold">V7.0</span></div>';
  if(agi) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Generated:</span><span>${agi.total_rules||0} rules</span></div><div class="pref-row"><span class="pref-label">Deployed:</span><span style="color:var(--green)">${agi.deployed_rules||0}</span></div><div class="pref-row"><span class="pref-label">Analyses:</span><span>${agi.total_analyses||0}</span></div><div class="pref-row"><span class="pref-label">Kill switches:</span><span style="color:var(--red)">${agi.killed_rules||0}</span></div></div>`; } else html += '<div class="empty">AGI Defense Engine initializing...</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">Autonomous Response</span></div>';
  if(resp) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Responses:</span><span>${resp.total_responses||0}</span></div><div class="pref-row"><span class="pref-label">Contained:</span><span>${resp.containments||0}</span></div><div class="pref-row"><span class="pref-label">Recovered:</span><span style="color:var(--green)">${resp.recoveries||0}</span></div><div class="pref-row"><span class="pref-label">Overrides:</span><span>${resp.overrides||0}</span></div></div>`; } else html += '<div class="empty">No autonomous responses yet</div>';
  html += '</div></div>';
  html += '<div class="two-col">';
  html += '<div class="card"><div class="card-header"><span class="card-title">Threat Federation</span></div>';
  if(fed) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Members:</span><span>${fed.total_members||0}</span></div><div class="pref-row"><span class="pref-label">Shared:</span><span>${fed.total_indicators_shared||0} indicators</span></div><div class="pref-row"><span class="pref-label">Consumed:</span><span>${fed.total_indicators_consumed||0}</span></div><div class="pref-row"><span class="pref-label">Collective:</span><span style="color:var(--angel-gold)">${fed.collective_score||'--'}/100</span></div></div>`; } else html += '<div class="empty">Not joined. Use /api/v1/empyrion/federation/join</div>';
  html += '</div>';
  html += '<div class="card"><div class="card-header"><span class="card-title">SOC Autopilot</span></div>';
  if(soc) { html += `<div style="font-size:11px"><div class="pref-row"><span class="pref-label">Triaged:</span><span>${soc.total_triaged||0} alerts</span></div><div class="pref-row"><span class="pref-label">Analysts:</span><span>${soc.total_analysts||0}</span></div><div class="pref-row"><span class="pref-label">Investigations:</span><span>${soc.active_investigations||0}</span></div><div class="pref-row"><span class="pref-label">Avg MTTR:</span><span>${soc.avg_mttr||'--'}</span></div></div>`; } else html += '<div class="empty">SOC Autopilot initializing...</div>';
  html += '</div></div>';
  mc.innerHTML = html;
}

async function updatePref(key, value) {
  const body={}; body[key]=value;
  const r=await fetch(BASE+'/api/v1/angelclaw/preferences?tenantId=dev-tenant',{method:'POST',headers:authHeaders(),body:JSON.stringify(body)});
  const el=document.getElementById('pref-status');
  if(r.ok){el.textContent=key.replace(/_/g,' ')+' updated';el.style.color='var(--green)';setTimeout(()=>el.textContent='',3000);}
  else{el.textContent='Failed';el.style.color='var(--red)';}
}

/* Approvals */
async function approveIncident(id) {
  const d=await fetch(BASE+'/api/v1/orchestrator/incidents/'+id+'/approve',{method:'POST',headers:authHeaders()}).then(r=>r.json()).catch(()=>null);
  if(d&&!d.error) renderPage(); else alert('Approval failed');
}

/* Timeline */
async function openTimeline(agentId, hostname) {
  const modal=document.getElementById('timeline-modal'), body=document.getElementById('tl-body');
  document.getElementById('tl-agent-name').textContent=hostname+' Timeline (24h)';
  body.innerHTML='<div class="loading">Loading...</div>'; modal.classList.add('visible');
  const data=await fetchJSON('/api/v1/analytics/agent/timeline?agentId='+agentId+'&hours=24');
  if(!data||!data.entries||!data.entries.length){body.innerHTML='<div class="empty">No activity in 24h.</div>';return;}
  let html='<div style="font-size:10px;color:var(--text-dim);margin-bottom:10px">'+data.total_events+' events</div><div class="timeline">';
  data.entries.forEach(e=>{const t=e.entry_type;let cls='tl-event',badge='<span class="tl-type-badge tl-type-event">event</span>';if(t==='policy_change'){cls='tl-policy';badge='<span class="tl-type-badge tl-type-policy">policy</span>';}else if(t==='session_start'){cls='tl-session';badge='<span class="tl-type-badge tl-type-session">session</span>';}else if(t==='ai_tool_call'){cls='tl-ai';badge='<span class="tl-type-badge tl-type-ai">ai</span>';}if(e.severity==='critical')cls+=' tl-critical';else if(e.severity==='high')cls+=' tl-high';const ts=new Date(e.timestamp);html+=`<div class="tl-entry ${cls}"><span class="tl-time">${ts.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span><div class="tl-content"><div class="tl-summary">${badge} ${esc(e.summary)}`;if(e.severity)html+=` <span class="alert-sev ${sevClass(e.severity)}">${esc(e.severity)}</span>`;html+='</div></div></div>';});
  html+='</div>'; body.innerHTML=html;
}
function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
document.getElementById('timeline-modal').addEventListener('click',function(e){if(e.target===this)closeModal('timeline-modal');});
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeModal('timeline-modal');});

/* Chat */
async function sendChat() {
  const input=document.getElementById('chat-input'),msgs=document.getElementById('chat-messages'),btn=document.getElementById('chat-send'),typing=document.getElementById('chat-typing');
  const text=input.value.trim(); if(!text) return;
  chatHistory.push({role:'user',content:text});
  msgs.innerHTML+='<div class="chat-msg user">'+esc(text)+'</div>';
  input.value=''; btn.disabled=true; typing.style.display='flex'; msgs.scrollTop=msgs.scrollHeight;
  let responseHtml='';
  try {
    const resp=await fetch(BASE+'/api/v1/angelclaw/chat',{method:'POST',headers:authHeaders(),body:JSON.stringify({tenantId:'dev-tenant',prompt:text})});
    if(resp.ok) {
      const data=await resp.json(); chatHistory.push({role:'system',content:data.answer});
      responseHtml='<div class="chat-msg system">'+formatAnswer(data.answer);
      if(data.actions&&data.actions.length){responseHtml+='<div class="actions">'+data.actions.map(a=>{const idx=a.index||'';return `<div class="action-card"><div><div class="action-title">#${idx} ${esc(a.type||a.action_type||'')}</div><div class="action-desc">${esc(a.description||'')}</div></div>${a.dry_run?'<span class="apply-btn" onclick="sendChatText(\'apply #'+idx+'\')">Apply</span>':''}</div>`;}).join('')+'</div>';}
      if(data.effects&&data.effects.length){responseHtml+='<div style="margin-top:6px;padding:6px 8px;background:var(--green-dim);border-radius:var(--radius-sm);font-size:10px;border:1px solid rgba(74,222,128,0.15)">'+data.effects.map(e=>'<div>'+(e.success?'&#9989;':'&#10060;')+' '+esc(e.message||e.type||'')+'</div>').join('')+'</div>';}
      responseHtml+='</div>';
    } else responseHtml='<div class="chat-msg system">Sorry, trouble processing that.</div>';
  } catch(e) { responseHtml='<div class="chat-msg system">Connection error.</div>'; }
  typing.style.display='none'; msgs.innerHTML+=responseHtml; msgs.scrollTop=msgs.scrollHeight; btn.disabled=false; input.focus();
}
function sendChatText(t){document.getElementById('chat-input').value=t;sendChat();}
function formatAnswer(t) {
  return esc(t).replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/`([^`]+)`/g,'<code style="background:var(--surface3);padding:1px 3px;border-radius:3px;font-family:var(--mono);font-size:10px">$1</code>').replace(/```(\w*)\n?([\s\S]*?)```/g,'<pre style="background:var(--surface3);padding:6px;border-radius:6px;font-family:var(--mono);font-size:10px;overflow-x:auto;margin:4px 0">$2</pre>').replace(/\n/g,'<br>');
}
document.getElementById('chat-input').addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});

/* WebSocket */
let ws=null;
function connectWebSocket() {
  try { const proto=location.protocol==='https:'?'wss:':'ws:'; ws=new WebSocket(`${proto}//${location.host}/ws/events?tenant_id=dev-tenant`);
    ws.onopen=()=>console.log('[WS] Connected'); ws.onclose=()=>{setTimeout(connectWebSocket,5000);}; ws.onerror=()=>{};
    ws.onmessage=e=>{try{const msg=JSON.parse(e.data);if(msg.type==='alert')showToast(`Alert: ${msg.title||'New alert'}`,'red');}catch(err){}};
  } catch(err){}
}
function showToast(msg,color) {
  const t=document.createElement('div'); t.style.cssText=`position:fixed;bottom:24px;right:24px;background:var(--surface-solid);border:1px solid var(--${color||'accent'});color:var(--text);padding:12px 20px;border-radius:var(--radius);z-index:9999;font-size:12px;max-width:360px;box-shadow:0 8px 32px rgba(0,0,0,0.4);backdrop-filter:blur(12px);animation:fadeIn 0.3s ease-out;font-weight:500;display:flex;align-items:center;gap:8px`;
  const icon=color==='red'?'&#9888;&#65039;':color==='green'?'&#9989;':'&#128737;';
  t.innerHTML=icon+' '+msg; document.body.appendChild(t); setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(10px)';t.style.transition='all 0.3s';setTimeout(()=>t.remove(),300);},4000);
}

/* Bootstrap */
async function bootstrapDashboard() {
  renderPage();
  // Refresh every 30s
  setInterval(()=>{ if(document.visibilityState==='visible') renderPage(); },30000);
  connectWebSocket();
  // Load daemon status for chat
  const d=await fetchJSON('/api/v1/angelclaw/daemon/status');
  if(d){const cp=document.getElementById('chat-daemon-pill');if(cp)cp.textContent=d.running?'Guardian active':'Stopped';}
}

(async()=>{const ok=await checkAuth();if(ok)bootstrapDashboard();})();
</script>
</body>
</html>
