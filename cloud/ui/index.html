<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#050a12">
<title>AngelClaw V10.0.0 Seraph â€” Console</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --background:228 62% 3.5%;--foreground:210 40% 92%;
  --card:228 45% 7%;--card-foreground:210 40% 92%;
  --primary:185 80% 55%;--primary-foreground:228 60% 4%;
  --secondary:228 30% 14%;--secondary-foreground:210 40% 85%;
  --muted:228 25% 11%;--muted-foreground:215 20% 50%;
  --accent:228 35% 16%;--accent-foreground:185 80% 55%;
  --destructive:0 72% 51%;--destructive-foreground:210 40% 98%;
  --border:228 25% 14%;--input:228 25% 12%;--ring:185 80% 55%;
  --aegis-cyan:185 80% 55%;--aegis-green:152 70% 50%;--aegis-amber:38 92% 55%;
  --aegis-red:0 72% 55%;--aegis-purple:265 70% 60%;--aegis-glow:185 100% 70%;
  --radius:0.75rem;--radius-sm:0.5rem;--radius-xs:0.375rem;
  --font:'Inter',system-ui,sans-serif;--mono:'JetBrains Mono',monospace;
  --bg:hsl(228 62% 3.5%);--surface:hsl(228 45% 7% / 0.6);--surface2:hsl(228 25% 11% / 0.3);
  --text:hsl(210 40% 92%);--text-dim:hsl(210 40% 82%);--text-muted:hsl(215 20% 50%);
  --primary-c:hsl(185 80% 55%);--primary-dim:hsl(185 80% 55% / 0.08);
  --green:hsl(152 70% 50%);--green-dim:hsl(152 70% 50% / 0.08);
  --amber:hsl(38 92% 55%);--amber-dim:hsl(38 92% 55% / 0.08);
  --red:hsl(0 72% 55%);--red-dim:hsl(0 72% 55% / 0.08);
  --purple:hsl(265 70% 60%);--purple-dim:hsl(265 70% 60% / 0.08);
  --cyan:hsl(185 80% 55%);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:var(--font);background:var(--bg);color:var(--text);font-size:13px;overflow:hidden;height:100vh;background-image:radial-gradient(ellipse at 10% 90%,hsl(var(--aegis-cyan) / 0.02) 0%,transparent 40%),radial-gradient(ellipse at 90% 10%,hsl(var(--aegis-purple) / 0.02) 0%,transparent 40%)}
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:hsl(var(--border));border-radius:4px}
a{color:hsl(var(--primary));text-decoration:none}
input,select,textarea{font-family:var(--font);font-size:13px;background:var(--surface);border:1px solid hsl(var(--border));border-radius:var(--radius-xs);color:var(--text);padding:8px 12px;outline:none;transition:border-color .2s}
input:focus{border-color:hsl(var(--primary))}
button{font-family:var(--font);cursor:pointer;border:none;font-size:13px}

.glass{background:hsl(var(--card) / 0.55);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid hsl(var(--border) / 0.4);border-radius:var(--radius);padding:20px;transition:all 0.3s ease}
.glass:hover{border-color:hsl(var(--border) / 0.65);background:hsl(var(--card) / 0.65)}
.glass-strong{background:hsl(var(--card) / 0.8);backdrop-filter:blur(28px) saturate(200%);-webkit-backdrop-filter:blur(28px) saturate(200%);border:1px solid hsl(var(--border) / 0.5);border-radius:var(--radius);padding:20px}
.glow-cyan{box-shadow:0 0 24px hsl(var(--aegis-cyan) / 0.12),0 0 60px hsl(var(--aegis-cyan) / 0.04)}
.glow-amber{box-shadow:0 0 24px hsl(var(--aegis-amber) / 0.15)}
.glow-red{box-shadow:0 0 20px hsl(var(--aegis-red) / 0.15)}
.text-gradient{background:linear-gradient(135deg,hsl(var(--aegis-cyan)),hsl(var(--aegis-purple)));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.aurora{position:relative}
.aurora::before{content:'';position:absolute;inset:0;border-radius:inherit;padding:1px;background:linear-gradient(135deg,hsl(var(--aegis-cyan)/0.35),hsl(var(--aegis-purple)/0.15),hsl(var(--aegis-cyan)/0.08),hsl(var(--aegis-purple)/0.35));-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:aurora-shift 6s ease-in-out infinite;pointer-events:none;z-index:0}
.aurora>*{position:relative;z-index:1}

.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:9999px;font-size:10px;font-weight:600;white-space:nowrap}
.badge-default{background:hsl(var(--primary) / 0.1);color:hsl(var(--primary))}
.badge-destructive{background:hsl(var(--destructive) / 0.12);color:hsl(var(--destructive))}
.badge-amber{background:hsl(var(--aegis-amber) / 0.12);color:hsl(var(--aegis-amber))}
.badge-green{background:hsl(var(--aegis-green) / 0.1);color:hsl(var(--aegis-green))}
.badge-purple{background:hsl(var(--aegis-purple) / 0.1);color:hsl(var(--aegis-purple))}
.badge-outline{background:transparent;border:1px solid hsl(var(--border));color:var(--text-muted)}
.badge-secondary{background:hsl(var(--secondary));color:hsl(var(--secondary-foreground))}

.app-shell{display:flex;height:100vh;overflow:hidden}
.sidebar{width:210px;min-width:210px;background:hsl(228 50% 5% / 0.97);backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);border-right:1px solid hsl(var(--border) / 0.35);display:flex;flex-direction:column;z-index:50;flex-shrink:0}
.sidebar.collapsed{width:60px;min-width:60px}
.sidebar-logo{padding:14px 16px;display:flex;align-items:center;gap:10px;border-bottom:1px solid hsl(var(--border) / 0.3)}
.logo-icon{width:34px;height:34px;border-radius:8px;background:linear-gradient(135deg,hsl(var(--aegis-cyan)),hsl(var(--aegis-purple)));display:flex;align-items:center;justify-content:center;font-size:16px;color:#fff;flex-shrink:0}
.logo-text{overflow:hidden;white-space:nowrap}.sidebar.collapsed .logo-text{display:none}
.logo-name{font-size:15px;font-weight:800;display:block}.logo-version{font-size:9px;color:var(--text-muted);display:block}
.sidebar-nav{flex:1;overflow-y:auto;padding:6px 8px}
.nav-section{font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);padding:14px 12px 4px;overflow:hidden;white-space:nowrap}
.sidebar.collapsed .nav-section{display:none}
.nav-item{display:flex;align-items:center;gap:10px;padding:7px 12px;border-radius:var(--radius-xs);cursor:pointer;transition:all .15s;color:var(--text-dim);position:relative;white-space:nowrap;font-size:12px}
.nav-item:hover{background:var(--primary-dim);color:var(--text)}
.nav-item.active{background:var(--primary-dim);color:hsl(var(--primary));font-weight:600}
.nav-item.active::before{content:'';position:absolute;left:0;top:4px;bottom:4px;width:3px;border-radius:0 3px 3px 0;background:hsl(var(--primary))}
.nav-icon{font-size:14px;flex-shrink:0;width:18px;text-align:center}
.sidebar.collapsed .nav-label{display:none}
.sidebar.collapsed .nav-item{justify-content:center;padding:10px}
.sidebar-footer{padding:10px 16px;border-top:1px solid hsl(var(--border) / 0.3);font-size:9px;color:var(--text-muted);font-style:italic;overflow:hidden;white-space:nowrap}
.sidebar.collapsed .sidebar-footer{font-size:0;padding:8px}
.sidebar-toggle{padding:6px;text-align:center;cursor:pointer;color:var(--text-muted);font-size:11px;border-top:1px solid hsl(var(--border) / 0.3)}
.sidebar-toggle:hover{color:hsl(var(--primary))}

.main-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden}
.topbar{height:52px;display:flex;align-items:center;justify-content:space-between;padding:0 20px;border-bottom:1px solid hsl(var(--border) / 0.25);background:hsl(var(--card) / 0.5);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);gap:12px;flex-shrink:0;z-index:40}
.topbar-search{display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid hsl(var(--border));border-radius:var(--radius-sm);padding:5px 12px;min-width:260px}
.topbar-search input{background:none;border:none;color:var(--text);font-size:12px;outline:none;flex:1}
.topbar-right{display:flex;align-items:center;gap:10px}
.halo-badge{display:flex;align-items:center;gap:4px;padding:3px 10px;border-radius:20px;background:var(--primary-dim);border:1px solid hsl(var(--aegis-cyan) / 0.15);font-size:11px;font-weight:700;color:hsl(var(--primary))}
.notif-btn{background:none;border:1px solid hsl(var(--border));border-radius:var(--radius-xs);color:var(--text-dim);font-size:15px;padding:3px 7px;position:relative}
.notif-dot{position:absolute;top:2px;right:2px;width:5px;height:5px;border-radius:50%;background:hsl(var(--aegis-amber));animation:pulse 2s infinite}
.user-pill{display:flex;align-items:center;gap:8px}
.user-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,hsl(var(--primary)),var(--purple));display:flex;align-items:center;justify-content:center;font-size:10px;font-weight:700;color:#fff}
.user-info{line-height:1.2}.uname{font-size:11px;font-weight:600}.utenant{font-size:9px;color:var(--text-muted)}
.logout-btn{background:var(--red-dim);color:var(--red);padding:3px 8px;border-radius:var(--radius-xs);font-size:10px;font-weight:600}

.main-content{flex:1;overflow-y:auto;padding:18px;display:flex;flex-direction:column;gap:16px}

.stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.stat-card{display:flex;align-items:center;gap:12px}
.stat-icon{width:38px;height:38px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0}
.stat-val{font-size:22px;font-weight:800;line-height:1.1}
.stat-label{font-size:10px;color:var(--text-dim);font-weight:500}
.stat-desc{font-size:9px;color:var(--text-muted)}
.g12{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
.g2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
.g3{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.g4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.g5{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}

.page-header{margin-bottom:2px}
.page-title{font-size:18px;font-weight:800;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.page-sub{font-size:11px;color:var(--text-muted);margin-top:2px}

.alert-row{display:flex;gap:8px;padding:7px 10px;border-radius:var(--radius-xs);background:var(--surface2);border:1px solid hsl(var(--border) / 0.3);transition:background .15s}
.alert-row:hover{background:hsl(228 30% 10% / 0.5)}
.alert-row.unresolved{background:hsl(0 72% 51% / 0.04);border-color:hsl(0 72% 51% / 0.15)}

.tbl{width:100%;border-collapse:collapse;font-size:12px}
.tbl th{text-align:left;padding:7px 10px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--text-muted);border-bottom:1px solid hsl(var(--border));background:hsl(var(--card) / 0.3)}
.tbl td{padding:7px 10px;border-bottom:1px solid hsl(var(--border) / 0.15);transition:background 0.15s}
.tbl tr:hover td{background:hsl(var(--primary) / 0.06)}

.loading{text-align:center;padding:40px;color:var(--text-muted);font-size:12px}
.loading::before{content:'';display:block;width:24px;height:24px;border:2px solid hsl(var(--border));border-top-color:hsl(var(--primary));border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 12px}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:18px;color:var(--text-muted);font-size:11px;font-style:italic}

.chat-panel{width:300px;min-width:300px;border-left:1px solid hsl(var(--border) / 0.3);display:flex;flex-direction:column;background:hsl(228 62% 3.5% / 0.97)}
.chat-header{padding:10px 14px;border-bottom:1px solid hsl(var(--border) / 0.3);font-size:12px;font-weight:700;display:flex;align-items:center;gap:6px}
.chat-messages{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px}
.chat-msg{padding:7px 10px;border-radius:var(--radius-sm);font-size:11px;line-height:1.5;max-width:90%}
.chat-msg.system{background:var(--primary-dim);border:1px solid hsl(var(--aegis-cyan) / 0.1);align-self:flex-start}
.chat-msg.user{background:var(--surface2);align-self:flex-end}
.chat-msg.bot{background:var(--surface);border:1px solid hsl(var(--border));align-self:flex-start}
.chat-typing{padding:6px 14px;font-size:10px;color:var(--text-muted);display:flex;align-items:center;gap:6px}
.typing-dots span{display:inline-block;width:4px;height:4px;border-radius:50%;background:hsl(var(--primary));animation:blink 1.4s infinite;margin:0 1px}
.typing-dots span:nth-child(2){animation-delay:0.2s}.typing-dots span:nth-child(3){animation-delay:0.4s}
.chat-input-row{display:flex;gap:5px;padding:10px;border-top:1px solid hsl(var(--border) / 0.3)}
.chat-input{flex:1;padding:7px 10px;background:var(--surface);border:1px solid hsl(var(--border));border-radius:var(--radius-xs);color:var(--text);font-size:11px;outline:none}
.chat-send{background:hsl(var(--primary));color:#000;font-weight:700;padding:7px 12px;border-radius:var(--radius-xs);font-size:11px}
.chat-toggle{display:none;position:fixed;bottom:16px;right:16px;width:44px;height:44px;border-radius:50%;background:hsl(var(--primary));color:#000;font-size:18px;z-index:200;box-shadow:0 4px 20px hsl(var(--aegis-cyan) / 0.3)}

.login-page{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:var(--bg);z-index:999;background-image:radial-gradient(ellipse at 20% 50%,hsl(var(--aegis-cyan) / 0.04) 0%,transparent 50%),radial-gradient(ellipse at 80% 20%,hsl(var(--aegis-purple) / 0.04) 0%,transparent 50%)}
.login-box{background:hsl(var(--card) / 0.7);border:1px solid hsl(var(--border) / 0.5);border-radius:var(--radius);padding:36px 32px;width:360px;text-align:center;backdrop-filter:blur(24px) saturate(180%);-webkit-backdrop-filter:blur(24px) saturate(180%);box-shadow:0 0 60px hsl(var(--aegis-cyan) / 0.06),0 24px 48px rgba(0,0,0,0.3);animation:fadeIn 0.6s ease-out}
.login-logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,hsl(var(--aegis-cyan)),hsl(var(--aegis-purple)));display:flex;align-items:center;justify-content:center;font-size:24px;color:#fff;margin:0 auto 16px;box-shadow:0 0 30px hsl(var(--aegis-cyan) / 0.2);animation:float 4s ease-in-out infinite}
.login-box h2{font-size:22px;font-weight:900;margin-bottom:3px}
.login-sub{font-size:10px;color:var(--text-muted);margin-bottom:20px;letter-spacing:0.5px}
.login-box input{width:100%;margin-bottom:8px;padding:10px 14px;background:hsl(var(--card) / 0.5);border:1px solid hsl(var(--border) / 0.4);transition:all .2s}
.login-box input:focus{border-color:hsl(var(--primary));box-shadow:0 0 12px hsl(var(--aegis-cyan) / 0.1)}
.login-box button{width:100%;padding:10px;background:linear-gradient(135deg,hsl(var(--aegis-cyan)),hsl(185 80% 45%));color:#000;font-weight:700;border-radius:var(--radius-xs);font-size:13px;margin-top:6px;transition:all .2s;box-shadow:0 4px 16px hsl(var(--aegis-cyan) / 0.2)}
.login-box button:hover{box-shadow:0 4px 24px hsl(var(--aegis-cyan) / 0.35);transform:translateY(-1px)}
.login-error{color:var(--red);font-size:11px;margin-bottom:6px;display:none}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);z-index:500;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:hsl(var(--card));border:1px solid hsl(var(--border));border-radius:var(--radius);width:90%;max-width:700px;max-height:80vh;overflow:hidden;display:flex;flex-direction:column}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid hsl(var(--border))}
.modal-header h2{font-size:15px;font-weight:700}
.modal-close{background:none;border:none;color:var(--text-dim);font-size:18px;cursor:pointer}
.modal-body{flex:1;overflow-y:auto;padding:18px}

@keyframes aurora-shift{0%,100%{opacity:0.4}50%{opacity:1}}
@keyframes pulse-glow{0%,100%{opacity:0.4;transform:scale(1)}50%{opacity:0.7;transform:scale(1.01)}}
@keyframes shield-pulse{0%,100%{box-shadow:0 0 20px hsl(var(--aegis-cyan)/0.08)}50%{box-shadow:0 0 40px hsl(var(--aegis-cyan)/0.2),0 0 80px hsl(var(--aegis-cyan)/0.08)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
@keyframes blink{0%,100%{opacity:0.2}50%{opacity:1}}
@keyframes marquee{from{transform:translateX(0)}to{transform:translateX(-50%)}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
.animate-shield-pulse{animation:shield-pulse 3s ease-in-out infinite}
.animate-float{animation:float 4s ease-in-out infinite}
.animate-pulse-glow{animation:pulse-glow 3s ease-in-out infinite}
.animate-marquee{animation:marquee 30s linear infinite}
.gauge-arc{transition:stroke-dashoffset 1s ease-out}
.fade-in{animation:fadeIn 0.4s ease-out}

@media(max-width:900px){
  .sidebar{position:fixed;left:-260px;top:0;bottom:0;z-index:300;transition:left .25s;box-shadow:4px 0 24px rgba(0,0,0,0.5)}
  .sidebar.open{left:0}.chat-panel{display:none}.chat-panel.mobile-open{display:flex;position:fixed;inset:0;width:100%;z-index:250}
  .chat-toggle{display:block}.topbar-search{display:none}
  .stat-row{grid-template-columns:repeat(2,1fr)}.g2,.g3,.g4,.g5{grid-template-columns:1fr}
  .g12{grid-template-columns:1fr}.main-content{padding:12px}.mobile-menu-btn{display:inline-flex!important}
}
.mobile-menu-btn{display:none;background:none;border:1px solid hsl(var(--border));border-radius:var(--radius-xs);color:var(--text);font-size:14px;padding:2px 7px;cursor:pointer;margin-right:6px}
</style>
</head>
<body>

<div class="login-page" id="login-page" style="display:none">
  <div class="login-box">
    <div class="login-logo">&#10040;</div>
    <h2 class="text-gradient">AngelClaw</h2>
    <div class="login-sub">V10.0.0 SERAPH &mdash; AUTONOMOUS AI DEFENSE</div>
    <div class="login-error" id="login-error"></div>
    <input type="text" id="login-user" placeholder="Username" autocomplete="username"/>
    <input type="password" id="login-pass" placeholder="Password" autocomplete="current-password"/>
    <button onclick="doLogin()">Sign In</button>
    <div style="margin-top:14px;font-size:9px;color:var(--text-muted)">Guardian angel, not gatekeeper.</div>
  </div>
</div>

<div id="main-app" style="display:none" class="app-shell">
  <div class="sidebar" id="sidebar">
    <div class="sidebar-logo"><div class="logo-icon">&#10040;</div><div class="logo-text"><span class="logo-name text-gradient">AngelClaw</span><span class="logo-version">v10.0 &middot; Seraph</span></div></div>
    <div class="sidebar-nav" id="sidebar-nav">
      <div class="nav-section">Command</div>
      <div class="nav-item active" onclick="navigate('dashboard')" data-page="dashboard"><span class="nav-icon">&#9670;</span><span class="nav-label">Dashboard</span></div>
      <div class="nav-section">Operations</div>
      <div class="nav-item" onclick="navigate('fleet')" data-page="fleet"><span class="nav-icon">&#9678;</span><span class="nav-label">Fleet</span></div>
      <div class="nav-item" onclick="navigate('alerts')" data-page="alerts"><span class="nav-icon">&#9888;</span><span class="nav-label">Alerts</span></div>
      <div class="nav-item" onclick="navigate('legion')" data-page="legion"><span class="nav-icon">&#9876;</span><span class="nav-label">Angel Legion</span></div>
      <div class="nav-section">Intelligence</div>
      <div class="nav-item" onclick="navigate('threat-intel')" data-page="threat-intel"><span class="nav-icon">&#128270;</span><span class="nav-label">Threat Intel</span></div>
      <div class="nav-item" onclick="navigate('analytics')" data-page="analytics"><span class="nav-icon">&#128200;</span><span class="nav-label">Analytics</span></div>
      <div class="nav-item" onclick="navigate('ai-engine')" data-page="ai-engine"><span class="nav-icon">&#129504;</span><span class="nav-label">AI Engine</span></div>
      <div class="nav-section">Governance</div>
      <div class="nav-item" onclick="navigate('zero-trust')" data-page="zero-trust"><span class="nav-icon">&#128272;</span><span class="nav-label">Zero Trust</span></div>
      <div class="nav-item" onclick="navigate('policies')" data-page="policies"><span class="nav-icon">&#128220;</span><span class="nav-label">Policies</span></div>
      <div class="nav-item" onclick="navigate('settings')" data-page="settings"><span class="nav-icon">&#9881;</span><span class="nav-label">Settings</span></div>
    </div>
    <div class="sidebar-footer">Guardian angel, not gatekeeper.</div>
    <div class="sidebar-toggle" onclick="toggleSidebarCollapse()">&#10094;</div>
  </div>

  <div class="main-wrap">
    <div class="topbar">
      <div style="display:flex;align-items:center">
        <button class="mobile-menu-btn" onclick="toggleSidebar()">&#9776;</button>
        <div class="topbar-search"><span style="opacity:0.4;font-size:13px">&#128270;</span><input type="text" id="search-input" placeholder='Ask Seraph Brain...' onkeydown="if(event.key==='Enter')seraphSearch(this.value)"/></div>
      </div>
      <div class="topbar-right">
        <div class="halo-badge">&#10040; Halo <span id="halo-val">--</span></div>
        <button class="notif-btn" title="Notifications">&#128276;<span class="notif-dot"></span></button>
        <div class="user-pill" id="user-pill" style="display:none"><div class="user-avatar" id="user-initials">AC</div><div class="user-info"><div class="uname" id="user-name">admin</div><div class="utenant" id="user-tenant">dev-tenant</div></div></div>
        <button class="logout-btn" id="logout-btn" style="display:none" onclick="doLogout()">Logout</button>
      </div>
    </div>
    <div class="main-content" id="main-content"><div class="loading">Loading...</div></div>
  </div>

  <div class="chat-panel" id="chat-panel">
    <div class="chat-header"><span style="color:hsl(var(--primary))">&#10040;</span> Seraph AI <span style="font-size:9px;color:var(--text-muted);margin-left:auto" id="chat-daemon-pill">--</span></div>
    <div class="chat-messages" id="chat-messages"><div class="chat-msg system">I'm <strong>AngelClaw Seraph</strong> &mdash; your autonomous security companion.</div></div>
    <div id="chat-typing" class="chat-typing" style="display:none"><span class="typing-dots"><span></span><span></span><span></span></span>Thinking...</div>
    <div class="chat-input-row"><input class="chat-input" id="chat-input" placeholder="Ask Seraph..."/><button class="chat-send" onclick="sendChat()">&#10148;</button></div>
  </div>
</div>

<button class="chat-toggle" id="chat-toggle" onclick="toggleMobileChat()">&#10040;</button>

<div class="modal-overlay" id="timeline-modal">
  <div class="modal"><div class="modal-header"><h2>&#128337; <span id="tl-agent-name">Timeline</span></h2><button class="modal-close" onclick="closeModal('timeline-modal')">&times;</button></div><div class="modal-body" id="tl-body"><div class="loading">Loading...</div></div></div>
</div>

<script>
const BASE=window.location.origin,chatHistory=[];
let authToken=localStorage.getItem('angelclaw_token')||'',authUser=null,currentPage='dashboard',cachedData={},sidebarCollapsed=false;

const esc=t=>t?String(t).replace(/</g,'&lt;').replace(/>/g,'&gt;'):'';
const ago=ts=>{if(!ts)return'--';const m=Math.floor((Date.now()-new Date(ts))/60000);return m<1?'just now':m<60?m+'m ago':m<1440?Math.floor(m/60)+'h ago':Math.floor(m/1440)+'d ago';};
const riskColor=r=>r>50?'var(--red)':r>20?'var(--amber)':'var(--green)';
const sevBadge=s=>s==='critical'?'badge-destructive':s==='high'?'badge-amber':'badge-default';
const n2s=n=>n!=null?Number(n).toLocaleString():'--';

function authHeaders(){const h={'Content-Type':'application/json'};if(authToken)h['Authorization']='Bearer '+authToken;return h;}
async function fetchJSON(p){try{const r=await fetch(BASE+p,{headers:authHeaders()});if(r.status===401){showLogin();return null;}if(!r.ok)return null;return await r.json();}catch{return null;}}
async function postJSON(p,b){try{const r=await fetch(BASE+p,{method:'POST',headers:authHeaders(),body:JSON.stringify(b)});if(r.status===401){showLogin();return null;}return await r.json();}catch{return null;}}

function gc(content,cls=''){return`<div class="glass fade-in ${cls}">${content}</div>`;}

function renderGauge(score,size=140){
  if(score==null)score=0;
  const r=size/2-8,circ=2*Math.PI*r,offset=circ-(score/100)*circ;
  const col=score>=80?'var(--aegis-green)':score>=50?'var(--aegis-amber)':'var(--aegis-red)';
  return`<div style="position:relative;width:${size}px;height:${size}px;margin:0 auto"><svg width="${size}" height="${size}" style="transform:rotate(-90deg)"><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="hsl(var(--border))" stroke-width="5"/><circle cx="${size/2}" cy="${size/2}" r="${r}" fill="none" stroke="hsl(${col})" stroke-width="5" stroke-linecap="round" stroke-dasharray="${circ}" stroke-dashoffset="${offset}" class="gauge-arc" style="filter:drop-shadow(0 0 6px hsl(${col}/0.3))"/></svg><div style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center"><span style="font-size:${size/4}px;font-weight:800">${score}</span><span style="font-size:9px;color:var(--text-muted)">/ 100</span></div></div>`;
}

function renderAreaChart(data,w,h){
  if(!data||!data.length)return'<div class="empty">No chart data</div>';
  const maxV=Math.max(...data.map(d=>Math.max(d.threats||0,d.blocked||0)))*1.2||1;
  const px=(key)=>data.map((d,i)=>`${(i/(data.length-1))*w},${h-(((d[key]||0)/maxV)*h)}`);
  const area=(key,col,gid)=>{const p=px(key);return`<defs><linearGradient id="${gid}" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stop-color="hsl(${col})" stop-opacity="0.25"/><stop offset="95%" stop-color="hsl(${col})" stop-opacity="0"/></linearGradient></defs><polygon points="${p.join(' ')} ${w},${h} 0,${h}" fill="url(#${gid})"/><polyline points="${p.join(' ')}" fill="none" stroke="hsl(${col})" stroke-width="2" stroke-linejoin="round"/>`;};
  const xl=data.map((d,i)=>`<text x="${(i/(data.length-1))*w}" y="${h+14}" fill="hsl(var(--muted-foreground))" font-size="9" text-anchor="middle" font-family="Inter,sans-serif">${esc(d.label||d.time||'')}</text>`).join('');
  return`<svg viewBox="0 0 ${w} ${h+20}" style="width:100%;height:auto;overflow:visible">${area('threats','0 72% 55%','tGrad')}${area('blocked','185 80% 55%','bGrad')}${xl}</svg>`;
}

function renderDonut(pct,color,label){
  if(pct==null)pct=0;
  const r=18,circ=2*Math.PI*r,offset=circ-(pct/100)*circ;
  return`<div style="display:flex;flex-direction:column;align-items:center;gap:4px"><div style="position:relative;width:44px;height:44px"><svg width="44" height="44" style="transform:rotate(-90deg)"><circle cx="22" cy="22" r="${r}" fill="none" stroke="hsl(var(--border) / 0.3)" stroke-width="4"/><circle cx="22" cy="22" r="${r}" fill="none" stroke="hsl(${color})" stroke-width="4" stroke-linecap="round" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/></svg><span style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700">${pct}%</span></div><span style="font-size:9px;color:var(--text-muted)">${label}</span></div>`;
}

function statCard(icon,value,label,color){
  return gc(`<div class="stat-card"><div class="stat-icon" style="background:var(--${color}-dim);color:var(--${color})">${icon}</div><div><div class="stat-val">${value}</div><div class="stat-label">${label}</div></div></div>`);
}

/* Auth */
async function checkAuth(){
  try{const r=await fetch(BASE+'/api/v1/auth/me',{headers:authHeaders()});if(r.ok){const d=await r.json();if(!d.auth_enabled){showApp(null);return true;}authUser=d;showApp(d);return true;}showLogin();return false;}catch{showApp(null);return true;}
}
function showLogin(){document.getElementById('login-page').style.display='flex';document.getElementById('main-app').style.display='none';}
function showApp(user){
  document.getElementById('login-page').style.display='none';document.getElementById('main-app').style.display='flex';
  if(user){document.getElementById('user-pill').style.display='flex';document.getElementById('user-name').textContent=user.username;document.getElementById('user-initials').textContent=(user.username||'AC').substring(0,2).toUpperCase();document.getElementById('logout-btn').style.display='inline-block';}
}
async function doLogin(){
  const user=document.getElementById('login-user').value.trim(),pass=document.getElementById('login-pass').value,err=document.getElementById('login-error');
  err.style.display='none';if(!user||!pass){err.textContent='Username and password required';err.style.display='block';return;}
  try{const r=await fetch(BASE+'/api/v1/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:user,password:pass})});if(r.ok){const d=await r.json();authToken=d.access_token;localStorage.setItem('angelclaw_token',authToken);authUser={username:d.username,role:d.role};showApp(authUser);bootstrapDashboard();}else{const e=await r.json().catch(()=>({detail:'Login failed'}));err.textContent=e.detail||'Login failed';err.style.display='block';}}catch{err.textContent='Connection error';err.style.display='block';}
}
function doLogout(){authToken='';authUser=null;localStorage.removeItem('angelclaw_token');showLogin();}
document.getElementById('login-pass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});

/* Navigation */
function navigate(page){
  currentPage=page;document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const el=document.querySelector(`.nav-item[data-page="${page}"]`);if(el)el.classList.add('active');
  document.getElementById('sidebar').classList.remove('open');renderPage();
}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
function toggleSidebarCollapse(){sidebarCollapsed=!sidebarCollapsed;document.getElementById('sidebar').classList.toggle('collapsed',sidebarCollapsed);document.querySelector('.sidebar-toggle').innerHTML=sidebarCollapsed?'&#10095;':'&#10094;';}
function toggleMobileChat(){document.getElementById('chat-panel').classList.toggle('mobile-open');}
function seraphSearch(q){
  if(!q||!q.trim())return;const pages=['dashboard','fleet','alerts','legion','threat-intel','analytics','ai-engine','zero-trust','policies','settings'];
  const match=pages.find(p=>q.toLowerCase().includes(p.replace('-',' '))||p.includes(q.toLowerCase()));
  if(match){navigate(match);document.getElementById('search-input').value='';return;}
  document.getElementById('search-input').value='';document.getElementById('chat-input').value=q;sendChat();
}
document.addEventListener('keydown',e=>{if(e.key==='/'&&document.activeElement.tagName!=='INPUT'&&document.activeElement.tagName!=='TEXTAREA'){e.preventDefault();document.getElementById('search-input').focus();}});

function openModal(id){document.getElementById(id).classList.add('show');}
function closeModal(id){document.getElementById(id).classList.remove('show');}

async function renderPage(){
  const mc=document.getElementById('main-content');mc.innerHTML='<div class="loading">Loading...</div>';
  switch(currentPage){
    case 'dashboard':return renderDashboard(mc);case 'fleet':return renderFleet(mc);
    case 'alerts':return renderAlerts(mc);case 'legion':return renderLegion(mc);
    case 'threat-intel':return renderThreatIntel(mc);case 'analytics':return renderAnalytics(mc);
    case 'ai-engine':return renderAIEngine(mc);case 'zero-trust':return renderZeroTrust(mc);
    case 'policies':return renderPolicies(mc);case 'settings':return renderSettings(mc);
    default:mc.innerHTML='<div class="empty">Page not found</div>';
  }
}

/* ===== DASHBOARD ===== */
async function renderDashboard(mc){
  const [agents,events,daemon,activity,alerts,halo,threats,fleet,shield]=await Promise.all([
    fetchJSON('/api/v1/agents'),fetchJSON('/api/v1/incidents/recent?limit=30'),
    fetchJSON('/api/v1/angelclaw/daemon/status'),fetchJSON('/api/v1/angelclaw/activity/recent?limit=10'),
    fetchJSON('/api/v1/guardian/alerts/recent?tenantId=dev-tenant&limit=8'),fetchJSON('/api/v1/convergence/halo/current'),
    fetchJSON('/api/v1/convergence/dashboard/threats'),fetchJSON('/api/v1/convergence/fleet/os-distribution'),
    fetchJSON('/api/v1/angelclaw/shield/status'),
  ]);
  cachedData.agents=agents;cachedData.alerts=alerts;
  const ac=agents?agents.length:0,ec=events?events.length:0,alc=alerts?alerts.length:0;
  const hs=halo&&halo.score!=null?halo.score:null;
  document.getElementById('halo-val').textContent=hs!=null?hs:'--';

  let h=`<div class="page-header"><div class="page-title">&#10040; AngelClaw Command Center <span class="badge badge-outline">v10.0.0 &middot; Seraph</span></div><div class="page-sub">Autonomous AI defense fabric &mdash; real-time data from all subsystems</div></div>`;

  h+='<div class="stat-row">'+statCard('&#10040;',hs!=null?hs:'--','Halo Score','primary')+statCard('&#9678;',n2s(ac),'Fleet Nodes','green')+statCard('&#128276;',n2s(alc),'Active Alerts','amber')+statCard('&#128200;',n2s(ec),'Recent Events','cyan')+'</div>';

  h+='<div class="g12">';
  h+=`<div style="grid-column:span 3">${gc(`<div style="text-align:center"><p style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:8px">Halo Score</p>${renderGauge(hs||0,140)}<p style="font-size:10px;color:var(--green);font-weight:500;margin-top:6px">${hs!=null?'Live':'Connecting...'}</p></div>`,'aurora animate-shield-pulse')}</div>`;

  const chartData=threats&&threats.data?threats.data:null;
  h+=`<div style="grid-column:span 5">${gc(`<h3 style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:10px">Threat Landscape</h3><div style="padding:6px 0">${chartData?renderAreaChart(chartData,400,170):'<div class="empty">Awaiting threat data...</div>'}</div>${chartData?'<div style="display:flex;gap:14px;margin-top:6px;font-size:10px"><span style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:3px;border-radius:2px;background:hsl(0 72% 55%)"></span>Threats</span><span style="display:flex;align-items:center;gap:4px"><span style="width:8px;height:3px;border-radius:2px;background:hsl(185 80% 55%)"></span>Blocked</span></div>':''}`)}</div>`;

  h+=`<div style="grid-column:span 4">${gc(`<h3 style="font-size:12px;font-weight:600;color:var(--text-muted);margin-bottom:10px">System Health</h3><div class="g2">${[{l:'Shield',v:shield&&shield.mode?shield.mode:'--',c:shield?'green':'amber'},{l:'Daemon',v:daemon&&daemon.running?'Active':'--',c:daemon&&daemon.running?'green':'red'},{l:'Alerts',v:n2s(alc),c:alc>0?'amber':'green'},{l:'Fleet',v:n2s(ac),c:ac>0?'green':'amber'}].map(s=>`<div style="padding:8px;border-radius:6px;background:var(--surface2);text-align:center"><div style="font-size:10px;color:var(--text-muted)">${s.l}</div><div style="font-size:14px;font-weight:800;color:var(--${s.c});margin-top:2px">${s.v}</div></div>`).join('')}</div>`)}</div>`;
  h+='</div>';

  // Fleet OS breakdown
  if(fleet&&Array.isArray(fleet)&&fleet.length){
    h+=gc(`<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px"><span style="font-size:12px;font-weight:700">&#9678; Fleet Distribution</span><span class="badge badge-default">${n2s(ac)} nodes</span></div><div class="g${Math.min(fleet.length,5)}">`+fleet.map(f=>`<div style="padding:10px;border-radius:8px;background:var(--surface2);border:1px solid hsl(var(--border) / 0.2);text-align:center"><div style="font-size:12px;font-weight:700">${esc(f.os||f.name||'Unknown')}</div><div style="font-size:18px;font-weight:800;margin:4px 0">${n2s(f.count||f.total||0)}</div>${f.health!=null?`<div style="font-size:9px;color:var(--${f.health>99?'green':'amber'})">${f.health}% healthy</div>`:''}</div>`).join('')+'</div>');
  }

  // Activity feed
  h+=gc(`<div style="display:flex;justify-content:space-between;margin-bottom:10px"><span style="font-size:12px;font-weight:700">&#10040; Guardian Activity</span><span class="badge ${daemon&&daemon.running?'badge-green':'badge-destructive'}">${daemon&&daemon.running?'LIVE':'OFFLINE'}</span></div><div style="max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:3px">`+(activity&&activity.length?activity.map(a=>`<div style="display:flex;gap:6px;padding:5px 8px;border-radius:5px;background:var(--surface2);border-left:2px solid hsl(var(--primary))"><div style="flex:1"><span style="font-size:9px;font-weight:700;text-transform:uppercase;color:hsl(var(--primary))">${esc(a.category)}</span> <span style="font-size:9px;color:var(--text-muted)">${ago(a.timestamp)}</span><div style="font-size:10px;margin-top:1px">${esc(a.summary)}</div></div></div>`).join(''):'<div class="empty">No activity data available</div>')+'</div>','glow-amber');

  // Seraph ticker
  h+=gc(`<div style="display:flex;align-items:center;gap:10px"><span style="font-size:14px;color:hsl(var(--primary));flex-shrink:0">&#129504;</span><div style="flex:1;overflow:hidden"><div style="display:flex;gap:20px;animation:marquee 30s linear infinite;white-space:nowrap"><span style="font-size:11px"><b style="color:hsl(var(--primary))">Seraph Brain</b> &mdash; V10.0.0 Autonomous Defense Active</span><span style="color:var(--text-muted)">&bull;</span><span style="font-size:11px"><b style="color:hsl(var(--primary))">Halo Score:</b> ${hs!=null?hs:'--'}</span><span style="color:var(--text-muted)">&bull;</span><span style="font-size:11px"><b style="color:hsl(var(--primary))">Fleet:</b> ${n2s(ac)} nodes</span><span style="color:var(--text-muted)">&bull;</span><span style="font-size:11px"><b style="color:hsl(var(--primary))">Events:</b> ${n2s(ec)} processed</span></div></div><span style="font-size:14px;color:hsl(var(--primary));animation:pulse 2s infinite">&#9881;</span></div>`,'glow-cyan');

  mc.innerHTML=h;
}

/* ===== FLEET ===== */
async function renderFleet(mc){
  const [agents,meshStatus,osDist,segments]=await Promise.all([
    cachedData.agents||fetchJSON('/api/v1/agents'),fetchJSON('/api/v1/mesh/status'),
    fetchJSON('/api/v1/convergence/fleet/os-distribution'),fetchJSON('/api/v1/zerotrust/segments'),
  ]);
  const list=agents||[];cachedData.agents=list;
  const online=list.filter(a=>a.status==='online').length;

  let h=`<div class="page-header"><div class="page-title">&#9678; Network Fabric <span class="badge badge-default">${n2s(list.length)} nodes</span></div><div class="page-sub">Fleet topology, mesh status, micro-segmentation</div></div>`;
  h+='<div class="stat-row">'+statCard('&#9678;',n2s(list.length),'Total Nodes','primary')+statCard('&#9989;',n2s(online),'Online','green')+statCard('&#9888;',n2s(list.length-online),'Offline','amber')+statCard('&#128274;',meshStatus&&meshStatus.encryption?meshStatus.encryption:'--','Mesh Encryption','cyan')+'</div>';

  if(list.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">&#128462; Mesh Topology</div><div style="display:flex;flex-wrap:wrap;gap:6px;justify-content:center;padding:12px">${list.slice(0,24).map((a,i)=>`<div style="width:54px;text-align:center;padding:6px;border-radius:6px;background:var(--surface2);border:1px solid ${a.status==='online'?'var(--green)':'var(--red)'}30;transition:transform .15s" onmouseover="this.style.transform='scale(1.08)'" onmouseout="this.style.transform='scale(1)'"><div style="font-size:14px">&#128421;</div><div style="font-size:7px;margin-top:3px;color:var(--text-dim);overflow:hidden;text-overflow:ellipsis">${esc(a.agent_id||'node-'+i).slice(0,10)}</div><div style="font-size:7px;color:${a.status==='online'?'var(--green)':'var(--red)'}">${a.status||'--'}</div></div>`).join('')}</div>`,'aurora');

    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Fleet Nodes</div><div style="overflow-x:auto"><table class="tbl"><thead><tr><th>Agent ID</th><th>Hostname</th><th>OS</th><th>Status</th><th>Trust</th><th>Last Seen</th></tr></thead><tbody>`+list.map(a=>`<tr><td style="font-family:var(--mono);font-size:10px;color:hsl(var(--primary))">${esc(a.agent_id)}</td><td>${esc(a.hostname)}</td><td>${esc(a.os_type||'--')}</td><td><span class="badge ${a.status==='online'?'badge-green':'badge-destructive'}">${a.status||'--'}</span></td><td style="color:${riskColor(100-(a.trust_score||80))}">${a.trust_score||'--'}%</td><td style="font-size:10px;color:var(--text-dim)">${ago(a.last_heartbeat)}</td></tr>`).join('')+`</tbody></table></div>`);
  }else{h+=gc('<div class="empty">No fleet nodes registered. Deploy ANGELNODEs to see them here.</div>');}

  if(segments&&Array.isArray(segments)&&segments.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">&#128272; Micro-Segmentation Zones</div><div class="g${Math.min(segments.length,4)}">`+segments.map(z=>`<div style="padding:12px;border-radius:8px;background:var(--surface2);text-align:center"><div style="font-size:13px;font-weight:700">${esc(z.name||z.segment_id)}</div><div style="font-size:9px;color:var(--text-muted);margin-top:4px">${esc(z.description||z.trust_level||'--')}</div></div>`).join('')+'</div>');
  }
  mc.innerHTML=h;
}

/* ===== ALERTS ===== */
async function renderAlerts(mc){
  const [alerts,soarStats]=await Promise.all([
    fetchJSON('/api/v1/guardian/alerts/recent?tenantId=dev-tenant&limit=30'),
    fetchJSON('/api/v1/soar/stats'),
  ]);
  const list=alerts||[];cachedData.alerts=list;
  const crits=list.filter(a=>a.severity==='critical').length;

  let h=`<div class="page-header"><div class="page-title">&#9888; Alerts &amp; Events <span class="badge badge-destructive">${crits} Critical</span></div><div class="page-sub">Real-time alert feed from Angel Legion wardens</div></div>`;
  h+='<div class="stat-row">'+statCard('&#128276;',n2s(list.length),'Total Alerts','amber')+statCard('&#9888;',n2s(crits),'Critical','red')+statCard('&#9989;',soarStats&&soarStats.total_executions!=null?n2s(soarStats.total_executions):'--','SOAR Runs','green')+statCard('&#128337;',soarStats&&soarStats.avg_response_time!=null?soarStats.avg_response_time+'s':'--','Avg Response','cyan')+'</div>';

  if(list.length){
    h+=gc(`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px"><div style="display:flex;align-items:center;gap:6px"><span style="font-size:12px;font-weight:700">Alert Feed</span><span style="width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 2s infinite"></span></div><span class="badge badge-destructive">${list.filter(a=>a.status==='open'||!a.resolved).length} Open</span></div><div style="display:flex;flex-direction:column;gap:4px">`+list.map(a=>{
      const id=a.alert_id||a.id||'--';const ev=a.title||a.event||a.summary||'Alert';const det=a.description||a.detail||'';const sev=a.severity||'info';const time=ago(a.created_at||a.timestamp);const resolved=a.status==='resolved'||a.resolved;
      return`<div class="alert-row ${resolved?'':'unresolved'}"><span style="font-size:13px;flex-shrink:0;margin-top:1px">${resolved?'&#9989;':'&#9888;'}</span><div style="flex:1;min-width:0"><div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:3px"><div style="display:flex;align-items:center;gap:5px"><span style="font-family:var(--mono);font-size:9px;color:hsl(var(--primary))">${esc(id)}</span><span style="font-size:11px;font-weight:500">${esc(ev)}</span><span class="badge ${sevBadge(sev)}">${sev}</span></div><div style="display:flex;align-items:center;gap:5px">${a.warden?`<span class="badge badge-outline">${esc(a.warden)}</span>`:''}<span style="font-size:9px;color:var(--text-muted)">${time}</span></div></div>${det?`<p style="font-size:10px;color:var(--text-muted);margin-top:2px">${esc(det)}</p>`:''}</div></div>`;
    }).join('')+'</div>');
  }else{h+=gc('<div class="empty">No alerts. All systems nominal.</div>','glow-cyan');}
  mc.innerHTML=h;
}

/* ===== LEGION ===== */
async function renderLegion(mc){
  const [legion,threats]=await Promise.all([
    fetchJSON('/api/v1/orchestrator/legion/status'),
    fetchJSON('/api/v1/analytics/threat-matrix?lookback_hours=24'),
  ]);

  let h=`<div class="page-header"><div class="page-title">&#9876; Angel Legion</div><div class="page-sub">The autonomous wardens protecting your infrastructure</div></div>`;

  const wardens=legion&&legion.wardens?legion.wardens:legion&&Array.isArray(legion)?legion:null;
  const wardenCount=wardens?wardens.length:0;

  h+='<div class="stat-row">'+statCard('&#9876;',n2s(wardenCount),'Active Wardens','primary')+statCard('&#128737;','--','Alerts Handled','green')+statCard('&#129504;','--','Auto-Resolve Rate','cyan')+statCard('&#9889;','--','Avg Response','amber')+'</div>';

  if(wardens&&wardens.length){
    h+='<div class="g3">'+wardens.map(w=>gc(`<div><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><span style="font-size:13px;font-weight:700">${esc(w.name||w.warden_name)}</span><span class="badge ${w.status==='active'||w.status==='Active'?'badge-green':'badge-amber'}">${esc(w.status||'--')}</span></div><div style="font-size:10px;color:hsl(var(--primary));font-weight:600;margin-bottom:3px">${esc(w.role||w.description||'')}</div>${w.alerts!=null?`<div style="font-size:9px;color:var(--text-muted)">${n2s(w.alerts)} alerts handled</div>`:''}</div>`,'glow-cyan')).join('')+'</div>';
  }else{
    h+=gc('<div class="empty">Warden data unavailable. Orchestrator may be initializing.</div>');
  }

  if(threats&&threats.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Threat Matrix (24h)</div><table class="tbl"><thead><tr><th>Threat</th><th>Severity</th><th>Count</th><th>Status</th></tr></thead><tbody>`+threats.slice(0,10).map(t=>`<tr><td style="font-weight:600">${esc(t.threat_name||t.name||'Unknown')}</td><td><span class="badge ${sevBadge(t.severity||'high')}">${t.severity||'--'}</span></td><td>${n2s(t.count||t.instances||0)}</td><td><span class="badge badge-green">${t.status||'Blocked'}</span></td></tr>`).join('')+'</tbody></table>');
  }
  mc.innerHTML=h;
}

/* ===== THREAT INTEL ===== */
async function renderThreatIntel(mc){
  const [stats,feeds,matches,mitre]=await Promise.all([
    fetchJSON('/api/v1/intel/stats'),fetchJSON('/api/v1/intel/feeds'),
    fetchJSON('/api/v1/intel/iocs/matches'),fetchJSON('/api/v1/prometheus/mitre/coverage'),
  ]);

  let h=`<div class="page-header"><div class="page-title">&#128270; Threat Intelligence</div><div class="page-sub">Threat feeds, IOC tracking, MITRE ATT&CK coverage</div></div>`;
  h+='<div class="stat-row">'+statCard('&#128270;',stats&&stats.total_feeds!=null?n2s(stats.total_feeds):'--','Threat Feeds','primary')+statCard('&#127760;',stats&&stats.total_iocs!=null?n2s(stats.total_iocs):'--','IOCs Tracked','amber')+statCard('&#9888;',matches&&Array.isArray(matches)?n2s(matches.length):'--','IOC Matches','red')+statCard('&#128737;',stats&&stats.block_rate!=null?stats.block_rate+'%':'--','Block Rate','green')+'</div>';

  const feedList=feeds&&Array.isArray(feeds)?feeds:[];
  if(feedList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Active Feeds</div><table class="tbl"><thead><tr><th>Feed</th><th>Type</th><th>IOCs</th><th>Status</th><th>Last Sync</th></tr></thead><tbody>`+feedList.map(f=>`<tr><td style="font-weight:600">${esc(f.name)}</td><td><span class="badge badge-default">${esc(f.feed_type||f.type||'--')}</span></td><td>${n2s(f.ioc_count||0)}</td><td><span class="badge ${f.enabled||f.active?'badge-green':'badge-amber'}">${f.enabled||f.active?'Active':'Paused'}</span></td><td style="color:var(--text-dim)">${ago(f.last_sync||f.updated_at)}</td></tr>`).join('')+'</tbody></table>');
  }else{h+=gc('<div class="empty">No threat feeds configured. Add feeds via API.</div>');}

  if(matches&&Array.isArray(matches)&&matches.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">IOC Matches</div><table class="tbl"><thead><tr><th>IOC</th><th>Type</th><th>Severity</th><th>Source</th><th>Detected</th></tr></thead><tbody>`+matches.slice(0,12).map(m=>`<tr><td style="font-family:var(--mono);font-size:10px">${esc(m.indicator||m.ioc||'--')}</td><td><span class="badge badge-default">${esc(m.ioc_type||m.type||'--')}</span></td><td><span class="badge ${sevBadge(m.severity||'high')}">${m.severity||'--'}</span></td><td style="color:var(--text-dim)">${esc(m.feed_name||m.source||'--')}</td><td style="color:var(--text-dim)">${ago(m.detected_at||m.created_at)}</td></tr>`).join('')+'</tbody></table>','glow-red');
  }

  if(mitre){
    const coverage=mitre.coverage_pct||mitre.coverage||null;
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">MITRE ATT&CK Coverage</div>${coverage!=null?`<div style="text-align:center;padding:12px">${renderDonut(coverage,'185 80% 55%','Coverage')}</div>`:'<div class="empty">Run MITRE mapping to see coverage</div>'}`,'glow-cyan');
  }
  mc.innerHTML=h;
}

/* ===== ANALYTICS ===== */
async function renderAnalytics(mc){
  const [threats,anomalyStats,learning,feedback]=await Promise.all([
    fetchJSON('/api/v1/analytics/threat-matrix?lookback_hours=168'),
    fetchJSON('/api/v1/ml/anomaly/stats'),
    fetchJSON('/api/v1/orchestrator/learning/summary'),
    fetchJSON('/api/v1/learning/feedback/recent?limit=15'),
  ]);
  const threatList=threats||[];const feedbackList=feedback||[];

  let h=`<div class="page-header"><div class="page-title">&#128200; Analytics &amp; Intelligence</div><div class="page-sub">Threat analytics, ML anomaly detection, learning engine</div></div>`;
  h+='<div class="stat-row">'+statCard('&#128200;',n2s(threatList.length),'Threats (7d)','red')+statCard('&#129504;',anomalyStats&&anomalyStats.total_detections!=null?n2s(anomalyStats.total_detections):'--','Anomalies','amber')+statCard('&#128257;',n2s(feedbackList.length),'Feedback Items','green')+statCard('&#9889;',learning&&learning.adjustments!=null?n2s(learning.adjustments):'--','Auto-Adjustments','cyan')+'</div>';

  if(threatList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Threat Matrix (7 days)</div><table class="tbl"><thead><tr><th>Threat</th><th>Category</th><th>Severity</th><th>Instances</th><th>Status</th></tr></thead><tbody>`+threatList.slice(0,12).map(t=>`<tr><td style="font-weight:600">${esc(t.threat_name||t.name||'Unknown')}</td><td><span class="badge badge-default">${esc(t.category||'--')}</span></td><td><span class="badge ${sevBadge(t.severity||'high')}">${t.severity||'--'}</span></td><td>${n2s(t.count||t.instances||0)}</td><td><span class="badge badge-green">${t.status||'Mitigated'}</span></td></tr>`).join('')+'</tbody></table>');
  }else{h+=gc('<div class="empty">No threat data in the last 7 days</div>');}

  if(anomalyStats){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">ML Anomaly Detection</div><div class="g3">${[{l:'Total Detections',v:anomalyStats.total_detections},{l:'Active Baselines',v:anomalyStats.total_baselines||anomalyStats.baselines},{l:'False Positive Rate',v:anomalyStats.false_positive_rate!=null?anomalyStats.false_positive_rate+'%':null}].map(s=>`<div style="text-align:center;padding:12px"><div style="font-size:20px;font-weight:800">${s.v!=null?s.v:'--'}</div><div style="font-size:10px;color:var(--text-muted);margin-top:2px">${s.l}</div></div>`).join('')}</div>`,'aurora');
  }

  if(feedbackList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Recent Feedback</div><div style="max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:3px">`+feedbackList.map(f=>`<div style="padding:5px 8px;border-radius:5px;background:var(--surface2);border-left:2px solid hsl(var(--primary))"><div style="font-size:9px"><span style="color:hsl(var(--primary));font-weight:600">${esc(f.category||'feedback')}</span> <span style="color:var(--text-muted)">${ago(f.timestamp)}</span></div><div style="font-size:10px;margin-top:1px">${esc(f.summary||f.description||'Feedback applied')}</div></div>`).join('')+'</div>','glow-cyan');
  }
  mc.innerHTML=h;
}

/* ===== AI ENGINE ===== */
async function renderAIEngine(mc){
  const [status,models,aiStats,empyrion]=await Promise.all([
    fetchJSON('/api/v1/transcendence/status'),fetchJSON('/api/v1/transcendence/ai/models'),
    fetchJSON('/api/v1/transcendence/ai/stats'),fetchJSON('/api/v1/empyrion/status'),
  ]);

  let h=`<div class="page-header"><div class="page-title">&#129504; AI Engine &mdash; Seraph Brain</div><div class="page-sub">Neural architecture, model governance, AGI defense</div></div>`;

  const health=status&&status.health!=null?status.health:null;
  h+='<div class="stat-row">'+statCard('&#129504;',health!=null?health:'--','Engine Health','primary')+statCard('&#128200;',aiStats&&aiStats.total_requests!=null?n2s(aiStats.total_requests):'--','Total Requests','green')+statCard('&#9889;',aiStats&&aiStats.avg_latency!=null?aiStats.avg_latency+'ms':'--','Avg Latency','cyan')+statCard('&#128274;',empyrion&&empyrion.safety_mode?empyrion.safety_mode:'--','Safety Mode','purple')+'</div>';

  h+=gc(`<div style="text-align:center;padding:16px"><div style="font-size:9px;color:var(--text-muted);text-transform:uppercase;letter-spacing:2px;font-weight:700;margin-bottom:8px">Neural Engine Health</div>${renderGauge(health||0,150)}<div style="font-size:10px;color:var(--${health&&health>=80?'green':'amber'});font-weight:500;margin-top:6px">${health!=null?(health>=80?'Optimal':'Degraded'):'Connecting...'}</div></div>`,'aurora');

  const modelList=models&&Array.isArray(models)?models:[];
  if(modelList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Model Registry</div><table class="tbl"><thead><tr><th>Model</th><th>Version</th><th>Status</th><th>Requests</th></tr></thead><tbody>`+modelList.map(m=>`<tr><td style="font-weight:600">${esc(m.name||m.model_name)}</td><td style="font-family:var(--mono);font-size:10px;color:var(--text-dim)">${esc(m.version||'--')}</td><td><span class="badge ${m.status==='active'||m.status==='production'?'badge-green':'badge-amber'}">${esc(m.status||'--')}</span></td><td>${n2s(m.requests||m.total_requests||0)}</td></tr>`).join('')+'</tbody></table>');
  }else{h+=gc('<div class="empty">No AI models registered</div>');}

  if(empyrion){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">AGI Defense &mdash; Empyrion</div><div class="g3">${[{l:'Safety Mode',v:empyrion.safety_mode||'--'},{l:'Active Rules',v:empyrion.active_rules!=null?empyrion.active_rules:'--'},{l:'Alignment Score',v:empyrion.alignment_score!=null?empyrion.alignment_score+'%':'--'}].map(s=>`<div style="text-align:center;padding:12px;background:var(--surface2);border-radius:8px"><div style="font-size:18px;font-weight:800">${s.v}</div><div style="font-size:10px;color:var(--text-muted);margin-top:2px">${s.l}</div></div>`).join('')}</div>`,'glow-cyan');
  }
  mc.innerHTML=h;
}

/* ===== ZERO TRUST ===== */
async function renderZeroTrust(mc){
  const [status,segStats,sessStats,devStats]=await Promise.all([
    fetchJSON('/api/v1/zerotrust/status'),fetchJSON('/api/v1/zerotrust/segments/stats'),
    fetchJSON('/api/v1/zerotrust/sessions/stats'),fetchJSON('/api/v1/zerotrust/devices/stats'),
  ]);

  let h=`<div class="page-header"><div class="page-title">&#128272; Zero Trust Architecture</div><div class="page-sub">Never trust, always verify &mdash; continuous authentication and micro-segmentation</div></div>`;

  const trustScore=status&&status.overall_score!=null?status.overall_score:status&&status.trust_score!=null?status.trust_score:null;
  h+='<div class="stat-row">'+statCard('&#128272;',trustScore!=null?trustScore+'%':'--','Trust Score','green')+statCard('&#128101;',sessStats&&sessStats.active_sessions!=null?n2s(sessStats.active_sessions):'--','Active Sessions','primary')+statCard('&#128421;',devStats&&devStats.total_devices!=null?n2s(devStats.total_devices):'--','Assessed Devices','cyan')+statCard('&#128462;',segStats&&segStats.total_segments!=null?n2s(segStats.total_segments):'--','Segments','purple')+'</div>';

  if(trustScore!=null){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Trust Distribution</div><div style="height:12px;border-radius:10px;display:flex;overflow:hidden;margin-bottom:8px"><div style="width:${trustScore}%;background:var(--green)"></div><div style="width:${Math.max(0,100-trustScore-10)}%;background:var(--amber)"></div><div style="width:${Math.min(10,100-trustScore)}%;background:var(--red)"></div></div><div style="display:flex;justify-content:space-between;font-size:10px"><span style="color:var(--green)">&#9679; Verified ${trustScore}%</span><span style="color:var(--amber)">&#9679; Conditional</span><span style="color:var(--red)">&#9679; Untrusted</span></div>`);
  }

  if(sessStats){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Session Stats</div><div class="g4">${[{l:'Active',v:sessStats.active_sessions},{l:'Verified',v:sessStats.verified},{l:'MFA',v:sessStats.mfa_sessions},{l:'Denied',v:sessStats.denied}].map(s=>`<div style="text-align:center;padding:10px;background:var(--surface2);border-radius:8px"><div style="font-size:18px;font-weight:800">${s.v!=null?n2s(s.v):'--'}</div><div style="font-size:10px;color:var(--text-muted);margin-top:2px">${s.l}</div></div>`).join('')}</div>`,'aurora');
  }

  if(devStats){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Device Assessment</div><div class="g3">${[{l:'Total Devices',v:devStats.total_devices},{l:'Compliant',v:devStats.compliant},{l:'Non-Compliant',v:devStats.non_compliant}].map(s=>`<div style="text-align:center;padding:10px;background:var(--surface2);border-radius:8px"><div style="font-size:18px;font-weight:800">${s.v!=null?n2s(s.v):'--'}</div><div style="font-size:10px;color:var(--text-muted);margin-top:2px">${s.l}</div></div>`).join('')}</div>`,'glow-cyan');
  }

  if(!status&&!sessStats&&!devStats){h+=gc('<div class="empty">Zero Trust module initializing. Deploy policies to activate.</div>');}
  mc.innerHTML=h;
}

/* ===== POLICIES ===== */
async function renderPolicies(mc){
  const [snapshots,nlPolicies,playbooks]=await Promise.all([
    fetchJSON('/api/v1/policies/snapshots'),fetchJSON('/api/v1/transcendence/policies/nl'),
    fetchJSON('/api/v1/orchestrator/playbooks'),
  ]);
  const snapList=snapshots&&Array.isArray(snapshots)?snapshots:[];
  const nlList=nlPolicies&&Array.isArray(nlPolicies)?nlPolicies:[];
  const pbList=playbooks&&Array.isArray(playbooks)?playbooks:[];

  let h=`<div class="page-header"><div class="page-title">&#128220; Policy Hub</div><div class="page-sub">Policy snapshots, natural language policies, playbook orchestration</div></div>`;
  h+='<div class="stat-row">'+statCard('&#128220;',n2s(snapList.length),'Policy Snapshots','primary')+statCard('&#129504;',n2s(nlList.length),'NL Policies','purple')+statCard('&#9889;',n2s(pbList.length),'Playbooks','green')+statCard('&#128260;','--','Total Runs','cyan')+'</div>';

  if(snapList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Policy Snapshots</div><table class="tbl"><thead><tr><th>ID</th><th>Created</th><th>Policies</th><th>Actions</th></tr></thead><tbody>`+snapList.slice(0,10).map(s=>`<tr><td style="font-family:var(--mono);font-size:10px;color:hsl(var(--primary))">${esc(s.snapshot_id||s.id||'--')}</td><td style="color:var(--text-dim)">${ago(s.created_at)}</td><td>${n2s(s.policy_count||s.total||0)}</td><td><span class="badge badge-default" style="cursor:pointer">Rollback</span></td></tr>`).join('')+'</tbody></table>');
  }else{h+=gc('<div class="empty">No policy snapshots. Create one via the API.</div>');}

  if(nlList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Natural Language Policies</div><table class="tbl"><thead><tr><th>Policy</th><th>Status</th><th>Created</th></tr></thead><tbody>`+nlList.slice(0,10).map(p=>`<tr><td style="font-weight:600">${esc(p.natural_text||p.description||p.name||'--')}</td><td><span class="badge ${p.approved?'badge-green':'badge-amber'}">${p.approved?'Approved':'Pending'}</span></td><td style="color:var(--text-dim)">${ago(p.created_at)}</td></tr>`).join('')+'</tbody></table>','aurora');
  }

  if(pbList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Playbooks</div><table class="tbl"><thead><tr><th>Playbook</th><th>Trigger</th><th>Runs</th><th>Status</th></tr></thead><tbody>`+pbList.map(p=>`<tr><td style="font-weight:600">${esc(p.name)}</td><td style="color:var(--text-dim)">${esc(p.trigger||p.trigger_type||'auto')}</td><td>${n2s(p.runs||p.total_runs||0)}</td><td><span class="badge ${p.enabled!==false?'badge-green':'badge-amber'}">${p.enabled!==false?'Active':'Paused'}</span></td></tr>`).join('')+'</tbody></table>','glow-cyan');
  }
  mc.innerHTML=h;
}

/* ===== SETTINGS ===== */
async function renderSettings(mc){
  const [org,tenants,roles]=await Promise.all([
    fetchJSON('/api/v1/admin/org/overview'),fetchJSON('/api/v1/admin/tenants'),
    fetchJSON('/api/v1/auth/roles'),
  ]);
  const tenantList=tenants&&Array.isArray(tenants)?tenants:[];
  const roleList=roles&&Array.isArray(roles)?roles:[];

  let h=`<div class="page-header"><div class="page-title">&#9881; Settings</div><div class="page-sub">Organization, tenants, RBAC configuration</div></div>`;

  if(org){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Organization Overview</div><div class="g3">${[{l:'Org Name',v:org.name||org.org_name||'--'},{l:'Total Agents',v:org.total_agents!=null?n2s(org.total_agents):'--'},{l:'Total Tenants',v:org.total_tenants!=null?n2s(org.total_tenants):'--'}].map(s=>`<div style="padding:12px;border-radius:8px;background:var(--surface2);text-align:center"><div style="font-size:10px;color:var(--text-muted)">${s.l}</div><div style="font-size:16px;font-weight:800;color:hsl(var(--primary));margin-top:4px">${s.v}</div></div>`).join('')}</div>`);
  }

  if(tenantList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Tenants</div><div class="g3">`+tenantList.map(t=>gc(`<div style="text-align:center;padding:6px 0"><div style="font-size:14px;font-weight:700">${esc(t.display_name||t.tenant_id)}</div><div style="font-size:10px;color:var(--text-dim);margin:3px 0">${esc(t.tenant_id)}</div><span class="badge badge-green">${esc(t.status||'active')}</span></div>`)).join('')+'</div>');
  }else{h+=gc('<div class="empty">No tenants configured</div>');}

  if(roleList.length){
    h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">Roles &amp; Permissions</div><table class="tbl"><thead><tr><th>Role</th><th>Permissions</th><th>Created</th></tr></thead><tbody>`+roleList.map(r=>`<tr><td style="font-weight:600">${esc(r.name||r.role_name)}</td><td style="font-size:10px;color:var(--text-dim)">${Array.isArray(r.permissions)?r.permissions.join(', '):esc(r.permissions||'--')}</td><td style="color:var(--text-dim)">${ago(r.created_at)}</td></tr>`).join('')+'</tbody></table>','glow-cyan');
  }

  h+=gc(`<div style="font-size:12px;font-weight:700;margin-bottom:10px">System Info</div><div class="g2">${[{l:'Version',v:'V10.0.0 Seraph'},{l:'User',v:authUser?authUser.username:'--'},{l:'Role',v:authUser?authUser.role:'--'},{l:'API',v:BASE}].map(s=>`<div style="display:flex;justify-content:space-between;padding:8px 10px;border-radius:6px;background:var(--surface2)"><span style="font-size:11px;color:var(--text-muted)">${s.l}</span><span style="font-size:11px;font-weight:600">${esc(s.v)}</span></div>`).join('')}</div>`);
  mc.innerHTML=h;
}

/* ===== CHAT ===== */
async function sendChat(){
  const input=document.getElementById('chat-input'),msg=input.value.trim();
  if(!msg)return;input.value='';
  const cm=document.getElementById('chat-messages');
  cm.innerHTML+=`<div class="chat-msg user">${esc(msg)}</div>`;
  cm.scrollTop=cm.scrollHeight;
  document.getElementById('chat-typing').style.display='flex';
  chatHistory.push({role:'user',content:msg});
  try{
    const r=await postJSON('/api/v1/angelclaw/chat',{message:msg,history:chatHistory.slice(-10),context:{page:currentPage}});
    document.getElementById('chat-typing').style.display='none';
    if(r&&r.response){
      chatHistory.push({role:'assistant',content:r.response});
      cm.innerHTML+=`<div class="chat-msg bot">${formatAnswer(r.response)}</div>`;
      if(r.daemon)document.getElementById('chat-daemon-pill').textContent=r.daemon;
    }else{cm.innerHTML+=`<div class="chat-msg bot" style="color:var(--amber)">No response.</div>`;}
  }catch{document.getElementById('chat-typing').style.display='none';cm.innerHTML+=`<div class="chat-msg bot" style="color:var(--red)">Connection error.</div>`;}
  cm.scrollTop=cm.scrollHeight;
}
document.getElementById('chat-input').addEventListener('keydown',e=>{if(e.key==='Enter')sendChat();});

function formatAnswer(text){
  if(!text)return'';
  return esc(text).replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/`(.+?)`/g,'<code style="background:var(--surface2);padding:1px 3px;border-radius:3px;font-family:var(--mono);font-size:10px">$1</code>').replace(/\n/g,'<br>');
}

/* WebSocket */
let ws=null;
function connectWS(){
  try{
    const proto=location.protocol==='https:'?'wss:':'ws:';
    ws=new WebSocket(`${proto}//${location.host}/ws/alerts`);
    ws.onmessage=e=>{try{const d=JSON.parse(e.data);if(d.type==='alert'&&currentPage==='alerts')renderPage();}catch{}};
    ws.onclose=()=>setTimeout(connectWS,5000);ws.onerror=()=>{};
  }catch{}
}

/* Timeline modal */
async function showTimeline(agentId){
  document.getElementById('tl-agent-name').textContent=agentId+' Timeline';
  document.getElementById('tl-body').innerHTML='<div class="loading">Loading...</div>';
  openModal('timeline-modal');
  const data=await fetchJSON(`/api/v1/agents/${agentId}/timeline`);
  if(!data){document.getElementById('tl-body').innerHTML='<div class="empty">No timeline data.</div>';return;}
  document.getElementById('tl-body').innerHTML=`<div style="display:flex;flex-direction:column;gap:4px">`+(Array.isArray(data)?data:data.events||[]).map(e=>`<div style="padding:6px 8px;border-radius:5px;background:var(--surface2);border-left:2px solid hsl(var(--primary))"><div style="font-size:9px;color:var(--text-muted)">${ago(e.timestamp)}</div><div style="font-size:11px;margin-top:1px">${esc(e.summary||e.event||'Event')}</div></div>`).join('')+'</div>';
}

/* Bootstrap */
async function bootstrapDashboard(){
  await renderPage();connectWS();
  try{const d=await fetchJSON('/api/v1/angelclaw/daemon/status');if(d)document.getElementById('chat-daemon-pill').textContent=d.running?'Active':'Stopped';}catch{}
}

(async()=>{const ok=await checkAuth();if(ok)bootstrapDashboard();})();
</script>
</body>
</html>
