#!/usr/bin/env python3
"""angelclawctl – AngelClaw AGI Guardian operator CLI.

Lightweight CLI for checking AngelClaw Node/Cloud status, querying incidents,
testing AI tool evaluation, and chatting with the AngelClaw brain.
Talks directly to the local REST APIs.

Usage:
    angelclawctl status              Show AngelClaw Node and Cloud health
    angelclawctl incidents           Show recent incident summary
    angelclawctl test-ai-tool        Run a test AI tool evaluation
    angelclawctl explain <event-id>  Explain a specific event decision
    angelclawctl chat <prompt>       Chat with AngelClaw AI

Environment:
    ANGELNODE_URL   default: http://127.0.0.1:8400
    CLOUD_URL       default: http://127.0.0.1:8500
"""

from __future__ import annotations

import argparse
import json
import sys
from datetime import datetime
from urllib.error import URLError
from urllib.request import Request, urlopen


ANGELNODE_URL = "http://127.0.0.1:8400"
CLOUD_URL = "http://127.0.0.1:8500"

# ANSI colors
GREEN = "\033[92m"
RED = "\033[91m"
YELLOW = "\033[93m"
CYAN = "\033[96m"
BOLD = "\033[1m"
RESET = "\033[0m"


def _get(url: str, timeout: int = 5) -> dict | list | None:
    try:
        req = Request(url, headers={"Accept": "application/json"})
        with urlopen(req, timeout=timeout) as resp:
            return json.loads(resp.read())
    except (URLError, OSError, json.JSONDecodeError) as e:
        return None


def _post(url: str, body: dict, timeout: int = 5) -> dict | None:
    try:
        data = json.dumps(body).encode()
        req = Request(url, data=data, headers={
            "Content-Type": "application/json",
            "Accept": "application/json",
        })
        with urlopen(req, timeout=timeout) as resp:
            return json.loads(resp.read())
    except (URLError, OSError, json.JSONDecodeError):
        return None


def _sev_color(sev: str) -> str:
    if sev in ("critical",):
        return RED
    if sev in ("high", "warn"):
        return YELLOW
    return GREEN


# ---------------------------------------------------------------------------
# Commands
# ---------------------------------------------------------------------------

def cmd_status(args: argparse.Namespace) -> None:
    """Show AngelClaw Node and Cloud health status."""
    print(f"\n{BOLD}{CYAN}AngelClaw AGI Guardian — Status{RESET}\n{'─' * 50}")

    # AngelClaw Node
    node = _get(f"{ANGELNODE_URL}/status")
    if node:
        print(f"  AngelClaw Node   {GREEN}● UP{RESET}")
        print(f"    Agent ID       : {node.get('agent_id', '?')}")
        print(f"    Policy version : {node.get('policy_version', '?')}")
        evals = node.get("evaluations", {})
        print(f"    Evaluations    : {evals.get('total', 0)} total, {evals.get('blocked', 0)} blocked")
        sync = node.get("last_policy_sync")
        if sync:
            print(f"    Last sync      : {sync}")
    else:
        health = _get(f"{ANGELNODE_URL}/health")
        if health:
            print(f"  AngelClaw Node   {GREEN}● UP{RESET} (health OK, status endpoint may require token)")
        else:
            print(f"  AngelClaw Node   {RED}● DOWN{RESET} — cannot reach {ANGELNODE_URL}")

    # Cloud
    cloud = _get(f"{CLOUD_URL}/health")
    if cloud or _get(f"{CLOUD_URL}/docs"):
        print(f"  AngelClaw Cloud  {GREEN}● UP{RESET}")
        if isinstance(cloud, dict):
            print(f"    Version        : {cloud.get('version', '?')}")
    else:
        print(f"  AngelClaw Cloud  {RED}● DOWN{RESET} — cannot reach {CLOUD_URL}")

    # Daemon status
    daemon = _get(f"{CLOUD_URL}/api/v1/angelclaw/daemon/status")
    if daemon:
        running = daemon.get("running", False)
        cycles = daemon.get("cycles_completed", 0)
        status = f"{GREEN}● ACTIVE{RESET} ({cycles} cycles)" if running else f"{RED}● STOPPED{RESET}"
        print(f"  Daemon           {status}")

    # Agents
    agents = _get(f"{CLOUD_URL}/api/v1/agents")
    if agents and isinstance(agents, list):
        print(f"\n{BOLD}Fleet ({len(agents)} agents){RESET}")
        if agents:
            print(f"  {'ID':<38} {'Hostname':<20} {'Status':<10} {'Last Seen'}")
            print(f"  {'─'*37} {'─'*19} {'─'*9} {'─'*20}")
            for a in agents[:10]:
                st = a.get("status", "?")
                color = GREEN if st == "active" else YELLOW
                seen = a.get("last_seen_at", "never")
                if seen and seen != "never":
                    seen = seen[:19]
                print(f"  {a['agent_id']:<38} {a['hostname']:<20} {color}{st:<10}{RESET} {seen}")
    print()


def cmd_incidents(args: argparse.Namespace) -> None:
    """Show recent incidents/events summary."""
    print(f"\n{BOLD}{CYAN}AngelClaw — Recent Security Events{RESET}\n{'─' * 70}")

    events = _get(f"{CLOUD_URL}/api/v1/incidents/recent?limit=20")
    if events is None:
        print(f"  {RED}Cannot reach AngelClaw Cloud at {CLOUD_URL}{RESET}")
        return

    if not events:
        print(f"  {GREEN}No recent events — all quiet.{RESET}")
        print()
        return

    print(f"  {'Time':<20} {'Severity':<10} {'Category':<12} {'Type':<16} {'Agent'}")
    print(f"  {'─'*19} {'─'*9} {'─'*11} {'─'*15} {'─'*20}")

    for ev in events:
        ts = ev.get("timestamp", "?")[:19]
        sev = ev.get("severity", "?")
        color = _sev_color(sev)
        print(
            f"  {ts:<20} {color}{sev:<10}{RESET} {ev.get('category', '?'):<12} "
            f"{ev.get('type', '?'):<16} {ev.get('agent_id', '?')[:20]}"
        )

    # Threat matrix summary
    matrix = _get(f"{CLOUD_URL}/api/v1/analytics/threat-matrix?lookback_hours=24")
    if matrix:
        print(f"\n{BOLD}Threat Matrix (24h){RESET}")
        for entry in matrix[:5]:
            print(f"  {entry['category']:<14} {entry['total_events']:>5} events  {entry.get('by_severity', {})}")
    print()


def cmd_test_ai_tool(args: argparse.Namespace) -> None:
    """Send test AI tool evaluations to AngelClaw Node."""
    print(f"\n{BOLD}{CYAN}AngelClaw — AI Tool Evaluation Tests{RESET}\n{'─' * 50}")

    tests = [
        {
            "name": "Safe read_file",
            "body": {"tool_name": "read_file", "arguments": {"path": "/app/src/main.py"}},
            "expect": "allowed",
        },
        {
            "name": "Read .env (secret path)",
            "body": {"tool_name": "read_file", "arguments": {"path": "/app/.env"}},
            "expect": "blocked",
        },
        {
            "name": "API key in arguments",
            "body": {"tool_name": "http_request", "arguments": {"api_key": "sk-1234567890abcdefghij"}},
            "expect": "blocked",
        },
        {
            "name": "Safe analysis tool",
            "body": {"tool_name": "summarize", "arguments": {"text": "hello"}},
            "expect": "allowed",
        },
    ]

    passed = 0
    for t in tests:
        result = _post(f"{ANGELNODE_URL}/ai/openclaw/evaluate_tool", t["body"])
        if result is None:
            print(f"  {RED}FAIL{RESET}  {t['name']} — cannot reach AngelClaw Node")
            continue

        allowed = result.get("allowed", False)
        action = result.get("action", "?")
        actual = "allowed" if allowed else "blocked"
        ok = actual == t["expect"]

        if ok:
            print(f"  {GREEN}PASS{RESET}  {t['name']} → {action} (expected: {t['expect']})")
            passed += 1
        else:
            print(f"  {RED}FAIL{RESET}  {t['name']} → {action} (expected: {t['expect']}, got: {actual})")

    print(f"\n  {passed}/{len(tests)} tests passed\n")


def cmd_explain(args: argparse.Namespace) -> None:
    """Explain a specific event decision."""
    event_id = args.event_id
    print(f"\n{BOLD}{CYAN}AngelClaw — Event Explanation{RESET}\n{'─' * 50}")

    result = _get(f"{CLOUD_URL}/api/v1/assistant/explain?event_id={event_id}")
    if result is None:
        print(f"  {RED}Cannot reach AngelClaw Cloud or event not found{RESET}\n")
        return

    if "detail" in result:
        print(f"  {RED}{result['detail']}{RESET}\n")
        return

    print(f"  Event ID    : {result.get('event_id', '?')}")
    print(f"  Category    : {result.get('category', '?')}")
    print(f"  Type        : {result.get('type', '?')}")
    print(f"  Severity    : {result.get('severity', '?')}")
    print(f"  Source      : {result.get('source', '?')}")
    print(f"  Matched Rule: {result.get('matched_rule_id', 'none')}")
    print(f"\n  {BOLD}Explanation:{RESET}")
    print(f"  {result.get('explanation', 'No explanation available')}")
    print()


def cmd_chat(args: argparse.Namespace) -> None:
    """Chat with AngelClaw AI guardian."""
    prompt = " ".join(args.prompt)
    if not prompt:
        print(f"  {RED}Usage: angelclawctl chat <your question>{RESET}")
        return

    print(f"\n{BOLD}{CYAN}AngelClaw AI{RESET}\n{'─' * 50}")
    print(f"  {BOLD}You:{RESET} {prompt}\n")

    result = _post(f"{CLOUD_URL}/api/v1/angelclaw/chat", {
        "tenantId": "dev-tenant",
        "prompt": prompt,
    }, timeout=30)

    if result is None:
        print(f"  {RED}Cannot reach AngelClaw Cloud at {CLOUD_URL}{RESET}\n")
        return

    answer = result.get("answer", "No response")
    print(f"  {BOLD}AngelClaw:{RESET}")
    for line in answer.split("\n"):
        print(f"  {line}")

    actions = result.get("actions", [])
    if actions:
        print(f"\n  {YELLOW}Proposed actions:{RESET}")
        for a in actions:
            print(f"    #{a.get('index', '?')} {a.get('type', '?')}: {a.get('description', '')}")

    effects = result.get("effects", [])
    if effects:
        print(f"\n  {GREEN}Effects:{RESET}")
        for e in effects:
            print(f"    {e.get('message', e.get('type', '?'))}")

    print()


# ---------------------------------------------------------------------------
# Main
# ---------------------------------------------------------------------------

def main() -> None:
    import os
    global ANGELNODE_URL, CLOUD_URL
    ANGELNODE_URL = os.environ.get("ANGELNODE_URL", ANGELNODE_URL)
    CLOUD_URL = os.environ.get("CLOUD_URL", CLOUD_URL)

    parser = argparse.ArgumentParser(
        prog="angelclawctl",
        description="AngelClaw AGI Guardian — operator CLI",
    )
    sub = parser.add_subparsers(dest="command")

    sub.add_parser("status", help="Show AngelClaw Node and Cloud health")
    sub.add_parser("incidents", help="Show recent incident summary")
    sub.add_parser("test-ai-tool", help="Run test AI tool evaluations")

    explain_p = sub.add_parser("explain", help="Explain an event decision")
    explain_p.add_argument("event_id", help="Event ID to explain")

    chat_p = sub.add_parser("chat", help="Chat with AngelClaw AI")
    chat_p.add_argument("prompt", nargs="+", help="Your question or command")

    args = parser.parse_args()

    if args.command == "status":
        cmd_status(args)
    elif args.command == "incidents":
        cmd_incidents(args)
    elif args.command == "test-ai-tool":
        cmd_test_ai_tool(args)
    elif args.command == "explain":
        cmd_explain(args)
    elif args.command == "chat":
        cmd_chat(args)
    else:
        parser.print_help()
        sys.exit(1)


if __name__ == "__main__":
    main()
